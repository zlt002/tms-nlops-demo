---
title: "TMS NL-Ops演示系统任务009: 客户管理API实现"
epic: "tms-nlops-demo"
task: "009"
phase: "2"
status: "completed"
priority: "high"
estimated_hours: 3
parallel: true
depends_on: ["001", "002", "003", "004", "005", "006", "007"]
tags: ["api", "customers", "backend", "typescript"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T08:15:00Z"
---

## 概述

实现客户管理相关的API接口，包括客户的创建、查询、更新和删除操作。构建完整的客户信息管理系统，支持企业客户和个人客户的管理。

## 目标

- 实现客户CRUD操作的API接口
- 创建客户数据模型和类型定义
- 实现客户信息管理功能
- 集成数据验证和错误处理
- 提供客户查询和筛选功能

## 技术栈

- **框架**: Next.js 15+ API Routes
- **语言**: TypeScript
- **数据库**: PostgreSQL (通过Prisma)
- **验证**: Zod schema validation
- **API**: RESTful设计模式

## 实施步骤

### 1. 创建客户数据模型

更新`prisma/schema.prisma`:

```prisma
model Customer {
  id                String   @id @default(cuid())
  customerNumber    String   @unique
  customerType      CustomerType @default(COMPANY)

  // 公司信息 (仅企业客户)
  companyName       String?
  businessLicense   String?
  taxNumber         String?
  industry          String?

  // 个人信息 (仅个人客户)
  firstName         String?
  lastName          String?
  idNumber          String?

  // 联系信息
  email             String   @unique
  phone             String
  secondaryPhone    String?

  // 地址信息
  address           String
  city              String
  province          String
  postalCode        String?

  // 客户状态
  status            CustomerStatus @default(ACTIVE)
  creditRating      Int      @default(0)  // 信用评分 0-100

  // 财务信息
  creditLimit       Float    @default(0)
  outstandingBalance Float   @default(0)
  paymentTerms      String?  // 付款条件

  // 业务统计
  totalOrders       Int      @default(0)
  totalAmount       Float    @default(0)
  lastOrderDate     DateTime?

  // 元数据
  notes             String?
  tags              String[] // 客户标签
  createdBy         String
  updatedBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 关联关系
  orders            Order[]
  shipments         Shipment[]
  contacts          CustomerContact[]
  documents         Document[]
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name       String
  position   String?
  phone      String
  email      String?
  isPrimary  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum CustomerType {
  COMPANY
  INDIVIDUAL
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BLACKLISTED
}
```

### 2. 创建客户类型定义

创建`src/types/customer.ts`:

```typescript
import { CustomerType, CustomerStatus } from '@prisma/client'

export interface Customer {
  id: string
  customerNumber: string
  customerType: CustomerType

  // 公司信息
  companyName?: string
  businessLicense?: string
  taxNumber?: string
  industry?: string

  // 个人信息
  firstName?: string
  lastName?: string
  idNumber?: string

  // 联系信息
  email: string
  phone: string
  secondaryPhone?: string

  // 地址信息
  address: string
  city: string
  province: string
  postalCode?: string

  // 客户状态
  status: CustomerStatus
  creditRating: number

  // 财务信息
  creditLimit: number
  outstandingBalance: number
  paymentTerms?: string

  // 业务统计
  totalOrders: number
  totalAmount: number
  lastOrderDate?: Date

  // 元数据
  notes?: string
  tags: string[]
  createdBy: string
  updatedBy: string
  createdAt: Date
  updatedAt: Date

  // 关联数据
  contacts?: CustomerContact[]
  orders?: Order[]
}

export interface CustomerContact {
  id: string
  customerId: string
  name: string
  position?: string
  phone: string
  email?: string
  isPrimary: boolean
  createdAt: Date
  updatedAt: Date
}

export interface CreateCustomerRequest {
  customerType: CustomerType
  companyName?: string
  businessLicense?: string
  taxNumber?: string
  industry?: string
  firstName?: string
  lastName?: string
  idNumber?: string
  email: string
  phone: string
  secondaryPhone?: string
  address: string
  city: string
  province: string
  postalCode?: string
  creditLimit?: number
  paymentTerms?: string
  notes?: string
  tags?: string[]
  contacts?: Omit<CustomerContact, 'id' | 'customerId' | 'createdAt' | 'updatedAt'>[]
}

export interface UpdateCustomerRequest {
  companyName?: string
  businessLicense?: string
  taxNumber?: string
  industry?: string
  firstName?: string
  lastName?: string
  idNumber?: string
  email?: string
  phone?: string
  secondaryPhone?: string
  address?: string
  city?: string
  province?: string
  postalCode?: string
  status?: CustomerStatus
  creditRating?: number
  creditLimit?: number
  paymentTerms?: string
  notes?: string
  tags?: string[]
}

export interface CustomerQueryParams {
  customerType?: CustomerType
  status?: CustomerStatus
  search?: string
  city?: string
  province?: string
  minCreditRating?: number
  maxCreditRating?: number
  tags?: string[]
  page?: number
  limit?: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### 3. 创建客户验证Schema

创建`src/validations/customer.ts`:

```typescript
import { z } from 'zod'
import { CustomerType, CustomerStatus } from '@prisma/client'

const companyInfoSchema = z.object({
  companyName: z.string().min(1, '公司名称不能为空'),
  businessLicense: z.string().optional(),
  taxNumber: z.string().optional(),
  industry: z.string().optional()
})

const personalInfoSchema = z.object({
  firstName: z.string().min(1, '姓名不能为空'),
  lastName: z.string().min(1, '姓名不能为空'),
  idNumber: z.string().optional()
})

const contactInfoSchema = z.object({
  email: z.string().email('邮箱格式不正确'),
  phone: z.string().min(1, '电话号码不能为空'),
  secondaryPhone: z.string().optional()
})

const addressSchema = z.object({
  address: z.string().min(1, '地址不能为空'),
  city: z.string().min(1, '城市不能为空'),
  province: z.string().min(1, '省份不能为空'),
  postalCode: z.string().optional()
})

const contactSchema = z.object({
  name: z.string().min(1, '联系人姓名不能为空'),
  position: z.string().optional(),
  phone: z.string().min(1, '电话号码不能为空'),
  email: z.string().email('邮箱格式不正确').optional(),
  isPrimary: z.boolean().default(false)
})

export const createCustomerSchema = z.object({
  customerType: z.nativeEnum(CustomerType),
  companyInfo: companyInfoSchema.when('customerType', {
    is: CustomerType.COMPANY,
    then: (schema) => schema.required(),
    otherwise: (schema) => schema.optional()
  }),
  personalInfo: personalInfoSchema.when('customerType', {
    is: CustomerType.INDIVIDUAL,
    then: (schema) => schema.required(),
    otherwise: (schema) => schema.optional()
  }),
  contactInfo: contactInfoSchema.required(),
  address: addressSchema.required(),
  creditLimit: z.number().min(0, '信用额度不能为负数').optional(),
  paymentTerms: z.string().optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional(),
  contacts: z.array(contactSchema).optional()
})

export const updateCustomerSchema = z.object({
  companyInfo: companyInfoSchema.partial().optional(),
  personalInfo: personalInfoSchema.partial().optional(),
  contactInfo: contactInfoSchema.partial().optional(),
  address: addressSchema.partial().optional(),
  status: z.nativeEnum(CustomerStatus).optional(),
  creditRating: z.number().min(0).max(100, '信用评分必须在0-100之间').optional(),
  creditLimit: z.number().min(0, '信用额度不能为负数').optional(),
  paymentTerms: z.string().optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional()
})

export const customerQuerySchema = z.object({
  customerType: z.nativeEnum(CustomerType).optional(),
  status: z.nativeEnum(CustomerStatus).optional(),
  search: z.string().optional(),
  city: z.string().optional(),
  province: z.string().optional(),
  minCreditRating: z.number().min(0).max(100).optional(),
  maxCreditRating: z.number().min(0).max(100).optional(),
  tags: z.array(z.string()).optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(20),
  sortBy: z.string().default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc')
})
```

### 4. 实现客户API路由

创建`src/app/api/customers/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { customerQuerySchema } from '@/validations/customer'
import { getCurrentUser } from '@/lib/auth'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const searchParams = request.nextUrl.searchParams
    const query = {
      customerType: searchParams.get('customerType') || undefined,
      status: searchParams.get('status') || undefined,
      search: searchParams.get('search') || undefined,
      city: searchParams.get('city') || undefined,
      province: searchParams.get('province') || undefined,
      minCreditRating: searchParams.get('minCreditRating') ? parseInt(searchParams.get('minCreditRating')!) : undefined,
      maxCreditRating: searchParams.get('maxCreditRating') ? parseInt(searchParams.get('maxCreditRating')!) : undefined,
      tags: searchParams.get('tags') ? searchParams.get('tags')!.split(',') : undefined,
      page: parseInt(searchParams.get('page') || '1'),
      limit: parseInt(searchParams.get('limit') || '20'),
      sortBy: searchParams.get('sortBy') || 'createdAt',
      sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') || 'desc'
    }

    const validatedQuery = customerQuerySchema.parse(query)

    const where: any = {}
    if (validatedQuery.customerType) where.customerType = validatedQuery.customerType
    if (validatedQuery.status) where.status = validatedQuery.status
    if (validatedQuery.city) where.city = validatedQuery.city
    if (validatedQuery.province) where.province = validatedQuery.province
    if (validatedQuery.minCreditRating !== undefined || validatedQuery.maxCreditRating !== undefined) {
      where.creditRating = {}
      if (validatedQuery.minCreditRating !== undefined) where.creditRating.gte = validatedQuery.minCreditRating
      if (validatedQuery.maxCreditRating !== undefined) where.creditRating.lte = validatedQuery.maxCreditRating
    }
    if (validatedQuery.tags && validatedQuery.tags.length > 0) {
      where.tags = {
        hasSome: validatedQuery.tags
      }
    }

    // 搜索功能
    if (validatedQuery.search) {
      where.OR = [
        { customerNumber: { contains: validatedQuery.search } },
        { companyName: { contains: validatedQuery.search } },
        { firstName: { contains: validatedQuery.search } },
        { lastName: { contains: validatedQuery.search } },
        { email: { contains: validatedQuery.search } },
        { phone: { contains: validatedQuery.search } }
      ]
    }

    const [customers, total] = await Promise.all([
      prisma.customer.findMany({
        where,
        include: {
          contacts: true,
          orders: {
            select: {
              id: true,
              orderNumber: true,
              status: true,
              totalAmount: true,
              createdAt: true
            },
            take: 5,
            orderBy: { createdAt: 'desc' }
          },
          _count: {
            select: {
              orders: true,
              shipments: true
            }
          }
        },
        skip: (validatedQuery.page - 1) * validatedQuery.limit,
        take: validatedQuery.limit,
        orderBy: {
          [validatedQuery.sortBy]: validatedQuery.sortOrder
        }
      }),
      prisma.customer.count({ where })
    ])

    return NextResponse.json({
      success: true,
      data: customers,
      pagination: {
        page: validatedQuery.page,
        limit: validatedQuery.limit,
        total,
        pages: Math.ceil(total / validatedQuery.limit)
      }
    })
  } catch (error) {
    console.error('获取客户列表失败:', error)
    return NextResponse.json(
      { error: '获取客户列表失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()

    // 转换数据格式以匹配验证schema
    const transformData = {
      customerType: body.customerType,
      companyInfo: body.customerType === 'COMPANY' ? {
        companyName: body.companyName,
        businessLicense: body.businessLicense,
        taxNumber: body.taxNumber,
        industry: body.industry
      } : undefined,
      personalInfo: body.customerType === 'INDIVIDUAL' ? {
        firstName: body.firstName,
        lastName: body.lastName,
        idNumber: body.idNumber
      } : undefined,
      contactInfo: {
        email: body.email,
        phone: body.phone,
        secondaryPhone: body.secondaryPhone
      },
      address: {
        address: body.address,
        city: body.city,
        province: body.province,
        postalCode: body.postalCode
      },
      creditLimit: body.creditLimit,
      paymentTerms: body.paymentTerms,
      notes: body.notes,
      tags: body.tags,
      contacts: body.contacts
    }

    const validatedData = createCustomerSchema.parse(transformData)

    // 检查邮箱是否已存在
    const existingCustomer = await prisma.customer.findUnique({
      where: { email: validatedData.contactInfo.email }
    })

    if (existingCustomer) {
      return NextResponse.json(
        { error: '邮箱已被使用' },
        { status: 400 }
      )
    }

    // 生成客户编号
    const customerNumber = generateCustomerNumber(validatedData.customerType)

    const customerData: any = {
      customerNumber,
      customerType: validatedData.customerType,
      email: validatedData.contactInfo.email,
      phone: validatedData.contactInfo.phone,
      secondaryPhone: validatedData.contactInfo.secondaryPhone,
      address: validatedData.address.address,
      city: validatedData.address.city,
      province: validatedData.address.province,
      postalCode: validatedData.address.postalCode,
      creditLimit: validatedData.creditLimit || 0,
      paymentTerms: validatedData.paymentTerms,
      notes: validatedData.notes,
      tags: validatedData.tags || [],
      createdBy: user.id,
      updatedBy: user.id
    }

    // 根据客户类型添加特定字段
    if (validatedData.customerType === CustomerType.COMPANY && validatedData.companyInfo) {
      customerData.companyName = validatedData.companyInfo.companyName
      customerData.businessLicense = validatedData.companyInfo.businessLicense
      customerData.taxNumber = validatedData.companyInfo.taxNumber
      customerData.industry = validatedData.companyInfo.industry
    }

    if (validatedData.customerType === CustomerType.INDIVIDUAL && validatedData.personalInfo) {
      customerData.firstName = validatedData.personalInfo.firstName
      customerData.lastName = validatedData.personalInfo.lastName
      customerData.idNumber = validatedData.personalInfo.idNumber
    }

    const customer = await prisma.customer.create({
      data: customerData,
      include: {
        contacts: true
      }
    })

    // 创建联系人
    if (validatedData.contacts && validatedData.contacts.length > 0) {
      const contactData = validatedData.contacts.map(contact => ({
        customerId: customer.id,
        name: contact.name,
        position: contact.position,
        phone: contact.phone,
        email: contact.email,
        isPrimary: contact.isPrimary
      }))

      await prisma.customerContact.createMany({
        data: contactData
      })

      // 重新获取包含联系人的客户信息
      const customerWithContacts = await prisma.customer.findUnique({
        where: { id: customer.id },
        include: {
          contacts: true
        }
      })

      return NextResponse.json({
        success: true,
        data: customerWithContacts,
        message: '客户创建成功'
      }, { status: 201 })
    }

    return NextResponse.json({
      success: true,
      data: customer,
      message: '客户创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建客户失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建客户失败', details: error.message },
      { status: 500 }
    )
  }
}

function generateCustomerNumber(customerType: CustomerType): string {
  const prefix = customerType === CustomerType.COMPANY ? 'C' : 'I'
  const timestamp = Date.now().toString()
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `${prefix}${timestamp.slice(-6)}${random}`
}
```

### 5. 实现单个客户操作路由

创建`src/app/api/customers/[id]/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { updateCustomerSchema } from '@/validations/customer'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const customer = await prisma.customer.findUnique({
      where: { id: params.id },
      include: {
        contacts: {
          orderBy: { isPrimary: 'desc' }
        },
        orders: {
          select: {
            id: true,
            orderNumber: true,
            status: true,
            totalAmount: true,
            createdAt: true,
            expectedTime: true
          },
          take: 10,
          orderBy: { createdAt: 'desc' }
        },
        shipments: {
          select: {
            id: true,
            shipmentNumber: true,
            status: true,
            originAddress: true,
            destinationAddress: true,
            departureTime: true,
            estimatedArrival: true
          },
          take: 10,
          orderBy: { createdAt: 'desc' }
        },
        _count: {
          select: {
            orders: true,
            shipments: true,
            contacts: true
          }
        }
      }
    })

    if (!customer) {
      return NextResponse.json(
        { error: '客户不存在' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      success: true,
      data: customer
    })
  } catch (error) {
    console.error('获取客户详情失败:', error)
    return NextResponse.json(
      { error: '获取客户详情失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()

    // 转换数据格式以匹配验证schema
    const transformData = {
      companyInfo: body.customerType === 'COMPANY' ? {
        companyName: body.companyName,
        businessLicense: body.businessLicense,
        taxNumber: body.taxNumber,
        industry: body.industry
      } : undefined,
      personalInfo: body.customerType === 'INDIVIDUAL' ? {
        firstName: body.firstName,
        lastName: body.lastName,
        idNumber: body.idNumber
      } : undefined,
      contactInfo: {
        email: body.email,
        phone: body.phone,
        secondaryPhone: body.secondaryPhone
      },
      address: {
        address: body.address,
        city: body.city,
        province: body.province,
        postalCode: body.postalCode
      },
      status: body.status,
      creditRating: body.creditRating,
      creditLimit: body.creditLimit,
      paymentTerms: body.paymentTerms,
      notes: body.notes,
      tags: body.tags
    }

    const validatedData = updateCustomerSchema.parse(transformData)

    const existingCustomer = await prisma.customer.findUnique({
      where: { id: params.id }
    })

    if (!existingCustomer) {
      return NextResponse.json(
        { error: '客户不存在' },
        { status: 404 }
      )
    }

    // 检查邮箱是否已被其他客户使用
    if (validatedData.contactInfo?.email && validatedData.contactInfo.email !== existingCustomer.email) {
      const emailExists = await prisma.customer.findUnique({
        where: { email: validatedData.contactInfo.email }
      })

      if (emailExists) {
        return NextResponse.json(
          { error: '邮箱已被使用' },
          { status: 400 }
        )
      }
    }

    const updateData: any = {
      updatedBy: user.id,
      updatedAt: new Date()
    }

    // 更新联系信息
    if (validatedData.contactInfo) {
      if (validatedData.contactInfo.email !== undefined) updateData.email = validatedData.contactInfo.email
      if (validatedData.contactInfo.phone !== undefined) updateData.phone = validatedData.contactInfo.phone
      if (validatedData.contactInfo.secondaryPhone !== undefined) updateData.secondaryPhone = validatedData.contactInfo.secondaryPhone
    }

    // 更新地址信息
    if (validatedData.address) {
      if (validatedData.address.address !== undefined) updateData.address = validatedData.address.address
      if (validatedData.address.city !== undefined) updateData.city = validatedData.address.city
      if (validatedData.address.province !== undefined) updateData.province = validatedData.address.province
      if (validatedData.address.postalCode !== undefined) updateData.postalCode = validatedData.address.postalCode
    }

    // 更新公司信息
    if (validatedData.companyInfo) {
      if (validatedData.companyInfo.companyName !== undefined) updateData.companyName = validatedData.companyInfo.companyName
      if (validatedData.companyInfo.businessLicense !== undefined) updateData.businessLicense = validatedData.companyInfo.businessLicense
      if (validatedData.companyInfo.taxNumber !== undefined) updateData.taxNumber = validatedData.companyInfo.taxNumber
      if (validatedData.companyInfo.industry !== undefined) updateData.industry = validatedData.companyInfo.industry
    }

    // 更新个人信息
    if (validatedData.personalInfo) {
      if (validatedData.personalInfo.firstName !== undefined) updateData.firstName = validatedData.personalInfo.firstName
      if (validatedData.personalInfo.lastName !== undefined) updateData.lastName = validatedData.personalInfo.lastName
      if (validatedData.personalInfo.idNumber !== undefined) updateData.idNumber = validatedData.personalInfo.idNumber
    }

    // 更新其他字段
    if (validatedData.status !== undefined) updateData.status = validatedData.status
    if (validatedData.creditRating !== undefined) updateData.creditRating = validatedData.creditRating
    if (validatedData.creditLimit !== undefined) updateData.creditLimit = validatedData.creditLimit
    if (validatedData.paymentTerms !== undefined) updateData.paymentTerms = validatedData.paymentTerms
    if (validatedData.notes !== undefined) updateData.notes = validatedData.notes
    if (validatedData.tags !== undefined) updateData.tags = validatedData.tags

    const updatedCustomer = await prisma.customer.update({
      where: { id: params.id },
      data: updateData,
      include: {
        contacts: true
      }
    })

    return NextResponse.json({
      success: true,
      data: updatedCustomer,
      message: '客户信息更新成功'
    })
  } catch (error) {
    console.error('更新客户信息失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '更新客户信息失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const customer = await prisma.customer.findUnique({
      where: { id: params.id },
      include: {
        _count: {
          select: {
            orders: true,
            shipments: true
          }
        }
      }
    })

    if (!customer) {
      return NextResponse.json(
        { error: '客户不存在' },
        { status: 404 }
      )
    }

    // 检查客户是否有关联的订单或运单
    if (customer._count.orders > 0 || customer._count.shipments > 0) {
      return NextResponse.json(
        { error: '客户存在关联的订单或运单，无法删除' },
        { status: 400 }
      )
    }

    await prisma.customer.delete({
      where: { id: params.id }
    })

    return NextResponse.json({
      success: true,
      message: '客户删除成功'
    })
  } catch (error) {
    console.error('删除客户失败:', error)
    return NextResponse.json(
      { error: '删除客户失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 6. 实现客户联系人管理

创建`src/app/api/customers/[id]/contacts/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { contactSchema } from '@/validations/customer'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const customer = await prisma.customer.findUnique({
      where: { id: params.id }
    })

    if (!customer) {
      return NextResponse.json(
        { error: '客户不存在' },
        { status: 404 }
      )
    }

    const contacts = await prisma.customerContact.findMany({
      where: { customerId: params.id },
      orderBy: { isPrimary: 'desc' }
    })

    return NextResponse.json({
      success: true,
      data: contacts
    })
  } catch (error) {
    console.error('获取客户联系人失败:', error)
    return NextResponse.json(
      { error: '获取客户联系人失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const customer = await prisma.customer.findUnique({
      where: { id: params.id }
    })

    if (!customer) {
      return NextResponse.json(
        { error: '客户不存在' },
        { status: 404 }
      )
    }

    const body = await request.json()
    const validatedData = contactSchema.parse(body)

    // 如果设置为主要联系人，先将其他联系人设为非主要
    if (validatedData.isPrimary) {
      await prisma.customerContact.updateMany({
        where: { customerId: params.id },
        data: { isPrimary: false }
      })
    }

    const contact = await prisma.customerContact.create({
      data: {
        customerId: params.id,
        name: validatedData.name,
        position: validatedData.position,
        phone: validatedData.phone,
        email: validatedData.email,
        isPrimary: validatedData.isPrimary
      }
    })

    return NextResponse.json({
      success: true,
      data: contact,
      message: '联系人创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建客户联系人失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建客户联系人失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 7. 创建客户服务层

创建`src/services/customerService.ts`:

```typescript
import { prisma } from '@/lib/prisma'
import { CustomerType, CustomerStatus } from '@prisma/client'

export class CustomerService {
  static async calculateCustomerStats(customerId: string) {
    const [orders, shipments] = await Promise.all([
      prisma.order.findMany({
        where: { customerId },
        select: {
          totalAmount: true,
          status: true,
          createdAt: true
        }
      }),
      prisma.shipment.findMany({
        where: { customerId },
        select: {
          status: true,
          createdAt: true
        }
      })
    ])

    const totalOrders = orders.length
    const totalAmount = orders.reduce((sum, order) => sum + order.totalAmount, 0)
    const completedOrders = orders.filter(order => order.status === 'DELIVERED').length
    const lastOrderDate = orders.length > 0 ? Math.max(...orders.map(o => o.createdAt.getTime())) : null

    // 计算信用评分（基于订单完成率、付款情况等）
    const completionRate = totalOrders > 0 ? completedOrders / totalOrders : 0
    const creditRating = Math.round(completionRate * 80 + 20) // 基础评分60-100

    return {
      totalOrders,
      totalAmount,
      completedOrders,
      lastOrderDate: lastOrderDate ? new Date(lastOrderDate) : null,
      creditRating
    }
  }

  static async updateCustomerStats(customerId: string) {
    const stats = await this.calculateCustomerStats(customerId)

    await prisma.customer.update({
      where: { id: customerId },
      data: {
        totalOrders: stats.totalOrders,
        totalAmount: stats.totalAmount,
        lastOrderDate: stats.lastOrderDate,
        creditRating: stats.creditRating
      }
    })

    return stats
  }

  static async getCustomersByType(customerType: CustomerType, params: any = {}) {
    const { page = 1, limit = 20, status, search } = params

    const where: any = { customerType }
    if (status) where.status = status

    if (search) {
      where.OR = [
        { customerNumber: { contains: search } },
        { companyName: { contains: search } },
        { firstName: { contains: search } },
        { lastName: { contains: search } },
        { email: { contains: search } }
      ]
    }

    const [customers, total] = await Promise.all([
      prisma.customer.findMany({
        where,
        include: {
          contacts: true,
          _count: {
            select: {
              orders: true,
              shipments: true
            }
          }
        },
        skip: (page - 1) * limit,
        take: limit,
        orderBy: { createdAt: 'desc' }
      }),
      prisma.customer.count({ where })
    ])

    return {
      customers,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    }
  }

  static async updateCustomerStatus(customerId: string, status: CustomerStatus, reason?: string) {
    const customer = await prisma.customer.findUnique({
      where: { id: customerId }
    })

    if (!customer) {
      throw new Error('客户不存在')
    }

    // 状态转换验证
    const validTransitions = {
      [CustomerStatus.ACTIVE]: [CustomerStatus.INACTIVE, CustomerStatus.SUSPENDED, CustomerStatus.BLACKLISTED],
      [CustomerStatus.INACTIVE]: [CustomerStatus.ACTIVE],
      [CustomerStatus.SUSPENDED]: [CustomerStatus.ACTIVE, CustomerStatus.BLACKLISTED],
      [CustomerStatus.BLACKLISTED]: [CustomerStatus.ACTIVE]
    }

    if (!validTransitions[customer.status].includes(status)) {
      throw new Error(`无法从 ${customer.status} 转换到 ${status}`)
    }

    const updatedCustomer = await prisma.customer.update({
      where: { id: customerId },
      data: {
        status,
        notes: reason ? `${customer.notes || ''}\n[${new Date().toISOString()}] 状态变更为 ${status}: ${reason}` : customer.notes
      }
    })

    return updatedCustomer
  }
}
```

## 验证清单

- [ ] 客户数据模型定义正确
- [ ] API路由实现完整
- [ ] 数据验证Schema有效
- [ ] 客户创建功能正常
- [ ] 客户查询功能正常
- [ ] 客户更新功能正常
- [ ] 客户删除功能正常
- [ ] 联系人管理功能正常
- [ ] 服务层功能完整
- [ ] 错误处理机制完善

## 测试命令

```bash
# 运行API测试
npm run test:api

# 数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

## 注意事项

- 确保客户数据验证规则完善
- 企业客户和个人客户需要不同的验证规则
- 客户状态转换需要符合业务逻辑
- 联系人管理需要支持主要联系人设置
- 客户统计信息需要实时更新
- 删除操作需要检查关联数据