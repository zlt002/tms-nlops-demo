---
title: 主聊天界面实现 (传统UI与NL-Ops对比)
epic: tms-nlops-demo
task_id: 037
type: task
status: todo
priority: high
tags: ["ui", "chat", "react", "comparison", "frontend"]
assignee: ""
created: 2025-09-20T04:20:45Z
updated: 2025-09-20T04:20:45Z
parallel: false
depends_on: ["016", "017", "018", "019", "020", "021", "022", "023", "024", "025", "030", "031", "032", "033", "034", "035", "036"]
effort: 5
description: 实现主聊天界面，支持传统UI与NL-Ops模式的对比演示
---

## 任务描述

实现TMS NL-Ops演示系统的主聊天界面，集成传统UI导航和AI交互模式，提供直观的用户体验对比，支持动态UI组件渲染、消息流管理、模式切换等功能。

## 详细需求

### 1. 界面布局设计
- **双栏布局**: 左侧导航栏，右侧主内容区
- **模式切换**: 传统UI模式与NL-Ops模式切换
- **响应式设计**: 适配不同屏幕尺寸
- **主题一致**: 统一的视觉风格和交互体验

### 2. 聊天界面功能
- **消息流**: 实时消息显示和滚动
- **输入交互**: 智能输入建议和快捷操作
- **工具调用**: 动态UI组件渲染
- **状态管理**: 对话状态和上下文维护

### 3. 传统UI集成
- **导航菜单**: 传统UI功能模块入口
- **页面路由**: 跳转到传统UI页面
- **数据同步**: 与AI模式数据同步
- **状态保持**: 用户状态一致性

### 4. 交互体验优化
- **加载状态**: 异步操作的加载反馈
- **错误处理**: 友好的错误提示和恢复
- **快捷操作**: 常用功能的快捷入口
- **帮助引导**: 新用户引导和帮助

## 技术实现

### 主界面组件
```typescript
// app/page.tsx
'use client';
import { useState, useEffect } from 'react';
import { useChat } from '@ai-sdk/react';
import { useRouter } from 'next/navigation';
import { Sidebar } from '@/components/layout/Sidebar';
import { ChatContainer } from '@/components/chat/ChatContainer';
import { TraditionalUI } from '@/components/traditional-ui/TraditionalUI';
import { ModeToggle } from '@/components/ui/ModeToggle';
import { LoadingSpinner } from '@/components/ui/LoadingSpinner';
import { ErrorBoundary } from '@/components/error/ErrorBoundary';

interface ChatMode {
  type: 'ai' | 'traditional';
  session?: string;
}

export default function HomePage() {
  const [mode, setMode] = useState<ChatMode>({ type: 'ai' });
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const {
    messages,
    input,
    handleInputChange,
    handleSubmit,
    setMessages,
    error,
    reload
  } = useChat({
    api: '/api/chat',
    id: mode.session,
    onFinish: () => {
      setIsLoading(false);
    },
    onError: (error) => {
      console.error('Chat error:', error);
      setIsLoading(false);
    }
  });

  // 模式切换处理
  const handleModeChange = (newMode: ChatMode) => {
    if (newMode.type === 'traditional') {
      router.push('/tms-dashboard');
    } else {
      setMode(newMode);
    }
  };

  // 渲染动态UI组件
  const renderDynamicComponent = (toolCall: any) => {
    const { toolName, args } = toolCall;

    switch (toolName) {
      case 'showOrders':
        return (
          <OrderTable
            key={toolCall.id}
            orders={args.orders}
            onOrderClick={(orderId) => handleOrderClick(orderId)}
          />
        );

      case 'showDispatchPlan':
        return (
          <DispatchPlan
            key={toolCall.id}
            orders={args.orders}
            vehicle={args.vehicle}
            route={args.route}
            onConfirm={() => handleDispatchConfirm(args.dispatchId)}
          />
        );

      case 'showVehicleTracking':
        return (
          <VehicleTracker
            key={toolCall.id}
            vehicle={args.vehicle}
            currentLocation={args.currentLocation}
            estimatedArrival={new Date(args.estimatedArrival)}
            route={args.route}
          />
        );

      case 'showPODViewer':
        return (
          <PODViewer
            key={toolCall.id}
            orderId={args.orderId}
            podData={args.podData}
            onVerify={(verified) => handlePODVerify(args.orderId, verified)}
          />
        );

      default:
        return null;
    }
  };

  return (
    <ErrorBoundary>
      <div className="flex h-screen bg-gray-50">
        {/* 侧边栏 */}
        <Sidebar mode={mode} onModeChange={handleModeChange} />

        {/* 主内容区 */}
        <main className="flex-1 flex flex-col overflow-hidden">
          {/* 顶部工具栏 */}
          <header className="bg-white border-b border-gray-200 px-6 py-4">
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-bold text-gray-900">
                TMS NL-Ops 演示系统
              </h1>
              <div className="flex items-center space-x-4">
                <ModeToggle mode={mode} onModeChange={handleModeChange} />
                <QuickActions />
              </div>
            </div>
          </header>

          {/* 内容区域 */}
          <div className="flex-1 overflow-hidden">
            {mode.type === 'ai' ? (
              <ChatContainer
                messages={messages}
                input={input}
                handleInputChange={handleInputChange}
                handleSubmit={handleSubmit}
                isLoading={isLoading}
                error={error}
                renderDynamicComponent={renderDynamicComponent}
                onRetry={reload}
              />
            ) : (
              <TraditionalUI />
            )}
          </div>

          {/* 加载状态 */}
          {isLoading && (
            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <LoadingSpinner size="lg" />
            </div>
          )}
        </main>
      </div>
    </ErrorBoundary>
  );
}
```

### 聊天容器组件
```typescript
// components/chat/ChatContainer.tsx
'use client';
import { useRef, useEffect } from 'react';
import { Message, useChat } from '@ai-sdk/react';
import { ChatInput } from './ChatInput';
import { MessageList } from './MessageList';
import { Suggestions } from './Suggestions';
import { TypingIndicator } from './TypingIndicator';

interface ChatContainerProps {
  messages: Message[];
  input: string;
  handleInputChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
  handleSubmit: (e: React.FormEvent) => void;
  isLoading: boolean;
  error?: Error;
  renderDynamicComponent: (toolCall: any) => React.ReactNode;
  onRetry: () => void;
}

export function ChatContainer({
  messages,
  input,
  handleInputChange,
  handleSubmit,
  isLoading,
  error,
  renderDynamicComponent,
  onRetry
}: ChatContainerProps) {
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  // 自动滚动到底部
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // 处理键盘快捷键
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Enter' && !e.shiftKey && input.trim()) {
        e.preventDefault();
        handleSubmit(e as any);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [input, handleSubmit]);

  return (
    <div className="flex flex-col h-full">
      {/* 消息列表 */}
      <div
        ref={containerRef}
        className="flex-1 overflow-y-auto px-6 py-4 space-y-4"
      >
        <MessageList
          messages={messages}
          renderDynamicComponent={renderDynamicComponent}
        />

        {/* 输入指示器 */}
        {isLoading && (
          <TypingIndicator />
        )}

        {/* 错误提示 */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <div className="flex items-center justify-between">
              <div className="text-red-800">
                <strong>错误:</strong> {error.message}
              </div>
              <button
                onClick={onRetry}
                className="text-red-600 hover:text-red-800 underline"
              >
                重试
              </button>
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* 输入区域 */}
      <div className="border-t border-gray-200 bg-white">
        <div className="px-6 py-4">
          {/* 快捷建议 */}
          {messages.length === 0 && !isLoading && (
            <Suggestions onSelect={(suggestion) => {
              // 模拟输入建议
              const input = document.querySelector('input[type="text"]') as HTMLInputElement;
              if (input) {
                input.value = suggestion;
                handleInputChange({ target: { value: suggestion } } as any);
              }
            }} />
          )}

          {/* 输入框 */}
          <ChatInput
            value={input}
            onChange={handleInputChange}
            onSubmit={handleSubmit}
            disabled={isLoading}
            placeholder="请输入您的需求，例如：查询今天的订单、创建新订单、查看车辆位置等..."
          />
        </div>
      </div>
    </div>
  );
}
```

### 消息列表组件
```typescript
// components/chat/MessageList.tsx
'use client';
import { Message } from '@ai-sdk/react';
import { UserMessage } from './UserMessage';
import { AssistantMessage } from './AssistantMessage';

interface MessageListProps {
  messages: Message[];
  renderDynamicComponent: (toolCall: any) => React.ReactNode;
}

export function MessageList({ messages, renderDynamicComponent }: MessageListProps) {
  return (
    <div className="space-y-4">
      {messages.map((message, index) => (
        <div key={message.id} className="flex flex-col space-y-2">
          {message.role === 'user' ? (
            <UserMessage content={message.content} />
          ) : (
            <AssistantMessage
              content={message.content}
              toolCalls={message.tool_calls}
              renderDynamicComponent={renderDynamicComponent}
            />
          )}
        </div>
      ))}

      {/* 欢迎消息 */}
      {messages.length === 0 && (
        <div className="text-center py-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">
            欢迎使用 TMS NL-Ops 演示系统
          </h2>
          <p className="text-gray-600 mb-6">
            我是您的智能运输管理助手，可以帮助您：
          </p>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
            <div className="bg-white p-4 rounded-lg border border-gray-200">
              <h3 className="font-semibold text-blue-600 mb-2">📦 订单管理</h3>
              <p className="text-sm text-gray-600">查询、创建和管理运输订单</p>
            </div>
            <div className="bg-white p-4 rounded-lg border border-gray-200">
              <h3 className="font-semibold text-green-600 mb-2">🚚 排车调度</h3>
              <p className="text-sm text-gray-600">智能排车和路线规划</p>
            </div>
            <div className="bg-white p-4 rounded-lg border border-gray-200">
              <h3 className="font-semibold text-purple-600 mb-2">📍 车辆跟踪</h3>
              <p className="text-sm text-gray-600">实时车辆位置和轨迹查询</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### 助手消息组件
```typescript
// components/chat/AssistantMessage.tsx
'use client';
import { useState } from 'react';
import { ToolCall } from '@ai-sdk/react';
import { Markdown } from './Markdown';
import { ToolCallComponent } from './ToolCallComponent';

interface AssistantMessageProps {
  content: string;
  toolCalls?: ToolCall[];
  renderDynamicComponent: (toolCall: any) => React.ReactNode;
}

export function AssistantMessage({
  content,
  toolCalls,
  renderDynamicComponent
}: AssistantMessageProps) {
  const [expandedToolCalls, setExpandedToolCalls] = useState<Set<string>>(new Set());

  const toggleToolCall = (toolCallId: string) => {
    const newExpanded = new Set(expandedToolCalls);
    if (newExpanded.has(toolCallId)) {
      newExpanded.delete(toolCallId);
    } else {
      newExpanded.add(toolCallId);
    }
    setExpandedToolCalls(newExpanded);
  };

  return (
    <div className="flex items-start space-x-3">
      {/* AI头像 */}
      <div className="flex-shrink-0">
        <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
          <span className="text-white text-sm font-bold">AI</span>
        </div>
      </div>

      {/* 消息内容 */}
      <div className="flex-1 space-y-3">
        {/* 文本内容 */}
        {content && (
          <div className="bg-white rounded-lg p-4 shadow-sm">
            <Markdown content={content} />
          </div>
        )}

        {/* 工具调用 */}
        {toolCalls && toolCalls.length > 0 && (
          <div className="space-y-2">
            {toolCalls.map((toolCall) => (
              <div key={toolCall.id}>
                {/* 工具调用头部 */}
                <button
                  onClick={() => toggleToolCall(toolCall.id)}
                  className="flex items-center space-x-2 w-full text-left bg-gray-50 hover:bg-gray-100 rounded-lg p-3 transition-colors"
                >
                  <span className="font-mono text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                    {toolCall.toolName}
                  </span>
                  <span className="text-gray-600 text-sm">
                    {expandedToolCalls.has(toolCall.id) ? '收起' : '展开'}
                  </span>
                </button>

                {/* 工具调用详情 */}
                {expandedToolCalls.has(toolCall.id) && (
                  <div className="mt-2 space-y-3">
                    {/* 参数显示 */}
                    <div className="bg-gray-50 rounded-lg p-3">
                      <h4 className="text-sm font-medium text-gray-700 mb-2">参数:</h4>
                      <pre className="text-xs bg-gray-100 rounded p-2 overflow-x-auto">
                        {JSON.stringify(toolCall.args, null, 2)}
                      </pre>
                    </div>

                    {/* 动态UI组件 */}
                    {renderDynamicComponent(toolCall)}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

## 交付成果

1. **主界面组件**: 完整的主聊天界面实现
2. **聊天容器**: 消息流管理和用户交互
3. **消息组件**: 用户和助手消息展示
4. **输入组件**: 智能输入和快捷操作
5. **侧边栏**: 导航和模式切换
6. **快捷建议**: 常用操作快捷入口
7. **错误处理**: 友好的错误提示和恢复

## 验收标准

- [ ] 界面响应时间 < 100ms
- [ ] 消息渲染流畅，无卡顿
- [ ] 动态UI组件正确显示
- [ ] 模式切换正常工作
- [ ] 快捷建议功能正常
- [ ] 错误处理友好且有效
- [ ] 键盘快捷键支持
- [ ] 自动滚动功能正常
- [ ] 响应式设计适配各种设备
- [ ] 加载状态反馈及时
- [ ] 无障碍访问支持
- [ ] 代码符合项目编码规范

## 相关文件

- `/app/page.tsx` - 主页面组件
- `/components/chat/ChatContainer.tsx` - 聊天容器
- `/components/chat/MessageList.tsx` - 消息列表
- `/components/chat/UserMessage.tsx` - 用户消息
- `/components/chat/AssistantMessage.tsx` - 助手消息
- `/components/chat/ChatInput.tsx` - 聊天输入
- `/components/layout/Sidebar.tsx` - 侧边栏
- `/components/ui/ModeToggle.tsx` - 模式切换
- `/components/ui/QuickActions.tsx` - 快捷操作

## 注意事项

1. 用户体验：界面交互要直观友好
2. 性能优化：减少不必要的重渲染
3. 错误处理：提供清晰的错误反馈
4. 可访问性：支持键盘操作和屏幕阅读器
5. 响应式设计：适配不同设备屏幕
6. 动画效果：使用适当的过渡动画
7. 测试覆盖：确保各组件功能正常
8. 代码复用：最大化组件复用率