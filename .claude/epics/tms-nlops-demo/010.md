---
title: "TMS NL-Ops演示系统任务010: 车辆管理API实现"
epic: "tms-nlops-demo"
task: "010"
phase: "2"
status: "pending"
priority: "high"
estimated_hours: 3
parallel: true
depends_on: ["001", "002", "003", "004", "005", "006", "007"]
tags: ["api", "vehicles", "backend", "typescript"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
---

## 概述

实现车辆管理相关的API接口，包括车辆信息管理、状态跟踪和位置更新。构建完整的车辆管理系统，支持车辆的基本信息、维护记录和实时位置管理。

## 目标

- 实现车辆CRUD操作的API接口
- 创建车辆数据模型和类型定义
- 实现车辆状态管理功能
- 集成车辆位置跟踪功能
- 提供车辆查询和筛选功能

## 技术栈

- **框架**: Next.js 15+ API Routes
- **语言**: TypeScript
- **数据库**: PostgreSQL (通过Prisma)
- **验证**: Zod schema validation
- **API**: RESTful设计模式

## 实施步骤

### 1. 创建车辆数据模型

更新`prisma/schema.prisma`:

```prisma
model Vehicle {
  id            String   @id @default(cuid())
  licenseNumber String   @unique
  vinNumber     String   @unique

  // 车辆基本信息
  brand         String
  model         String
  year          Int
  color         String?
  vehicleType   VehicleType

  // 载重信息
  maxLoad       Float    // 最大载重(吨)
  maxVolume     Float    // 最大体积(立方米)
  currentLoad   Float    @default(0) // 当前载重
  currentVolume Float    @default(0) // 当前体积

  // 状态信息
  status        VehicleStatus @default(AVAILABLE)
  location      VehicleLocation?

  // 驾驶员信息
  driverId      String?
  driver        Driver?       @relation(fields: [driverId], references: [id])

  // 维护信息
  lastMaintenance DateTime?
  nextMaintenance DateTime?
  mileage        Float      @default(0) // 里程数(公里)
  fuelLevel      Float      @default(100) // 燃油百分比

  // 保险信息
  insuranceCompany String?
  insurancePolicy  String?
  insuranceExpiry DateTime?

  // 费用信息
  dailyRate        Float     // 日租金
  maintenanceCost  Float     @default(0) // 维护成本
  fuelCost         Float     @default(0) // 燃油成本

  // 元数据
  notes            String?
  tags             String[]  // 车辆标签
  isActive         Boolean   @default(true)
  createdBy        String
  updatedBy        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // 关联关系
  shipments        Shipment[]
  maintenanceRecords VehicleMaintenance[]
  locationHistory  VehicleLocationHistory[]
  fuelRecords      VehicleFuelRecord[]
}

model VehicleLocation {
  id         String   @id @default(cuid())
  vehicleId  String   @unique
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  latitude   Float
  longitude  Float
  address    String?
  speed      Float    @default(0) // 速度(km/h)
  heading    Float    @default(0) // 方向(度)
  timestamp  DateTime @default(now())
  accuracy   Float?   // GPS精度(米)
}

model VehicleLocationHistory {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  latitude   Float
  longitude  Float
  address    String?
  speed      Float    @default(0)
  heading    Float    @default(0)
  timestamp  DateTime @default(now())
  accuracy   Float?
}

model VehicleMaintenance {
  id          String   @id @default(cuid())
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  maintenanceType MaintenanceType
  description String
  cost        Float
  mileage     Float
  performedBy String
  performedAt DateTime
  nextDueDate DateTime?
  notes       String?
  createdAt   DateTime @default(now())
}

model VehicleFuelRecord {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  fuelAmount Float    // 加油量(升)
  fuelCost   Float    // 加油费用
  fuelType   String   // 燃油类型
  mileage    Float    // 加油时里程数
  location   String?  // 加油地点
  filledBy   String
  filledAt   DateTime @default(now())
  notes      String?
}

enum VehicleType {
  TRUCK
  VAN
  TRAILER
  FLATBED
  REFRIGERATED
  TANKER
  BULK
  OTHER
}

enum VehicleStatus {
  AVAILABLE      // 可用
  IN_TRANSIT     // 运输中
  LOADING        // 装货中
  UNLOADING      // 卸货中
  MAINTENANCE    // 维护中
  REPAIR         // 维修中
  OUT_OF_SERVICE // 停运
  RESERVED       // 已预订
}

enum MaintenanceType {
  ROUTINE         // 常规保养
  REPAIR          // 维修
  INSPECTION      // 检查
  TIRE_CHANGE     // 换轮胎
  OIL_CHANGE      // 换机油
  BRAKE_SERVICE   // 刹车服务
  OTHER           // 其他
}
```

### 2. 创建车辆类型定义

创建`src/types/vehicle.ts`:

```typescript
import { VehicleType, VehicleStatus, MaintenanceType } from '@prisma/client'

export interface Vehicle {
  id: string
  licenseNumber: string
  vinNumber: string
  brand: string
  model: string
  year: number
  color?: string
  vehicleType: VehicleType
  maxLoad: number
  maxVolume: number
  currentLoad: number
  currentVolume: number
  status: VehicleStatus
  location?: VehicleLocation
  driverId?: string
  driver?: Driver
  lastMaintenance?: Date
  nextMaintenance?: Date
  mileage: number
  fuelLevel: number
  insuranceCompany?: string
  insurancePolicy?: string
  insuranceExpiry?: Date
  dailyRate: number
  maintenanceCost: number
  fuelCost: number
  notes?: string
  tags: string[]
  isActive: boolean
  createdBy: string
  updatedBy: string
  createdAt: Date
  updatedAt: Date
}

export interface VehicleLocation {
  id: string
  vehicleId: string
  latitude: number
  longitude: number
  address?: string
  speed: number
  heading: number
  timestamp: Date
  accuracy?: number
}

export interface VehicleMaintenance {
  id: string
  vehicleId: string
  maintenanceType: MaintenanceType
  description: string
  cost: number
  mileage: number
  performedBy: string
  performedAt: Date
  nextDueDate?: Date
  notes?: string
  createdAt: Date
}

export interface VehicleFuelRecord {
  id: string
  vehicleId: string
  fuelAmount: number
  fuelCost: number
  fuelType: string
  mileage: number
  location?: string
  filledBy: string
  filledAt: Date
  notes?: string
}

export interface CreateVehicleRequest {
  licenseNumber: string
  vinNumber: string
  brand: string
  model: string
  year: number
  color?: string
  vehicleType: VehicleType
  maxLoad: number
  maxVolume: number
  dailyRate: number
  insuranceCompany?: string
  insurancePolicy?: string
  insuranceExpiry?: Date
  nextMaintenance?: Date
  notes?: string
  tags?: string[]
}

export interface UpdateVehicleRequest {
  licenseNumber?: string
  vinNumber?: string
  brand?: string
  model?: string
  year?: number
  color?: string
  vehicleType?: VehicleType
  maxLoad?: number
  maxVolume?: number
  dailyRate?: number
  status?: VehicleStatus
  driverId?: string
  nextMaintenance?: Date
  insuranceCompany?: string
  insurancePolicy?: string
  insuranceExpiry?: Date
  fuelLevel?: number
  notes?: string
  tags?: string[]
  isActive?: boolean
}

export interface UpdateVehicleLocationRequest {
  latitude: number
  longitude: number
  address?: string
  speed?: number
  heading?: number
  accuracy?: number
}

export interface VehicleQueryParams {
  status?: VehicleStatus
  vehicleType?: VehicleType
  driverId?: string
  available?: boolean
  minMaxLoad?: number
  maxMaxLoad?: number
  tags?: string[]
  search?: string
  page?: number
  limit?: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### 3. 创建车辆验证Schema

创建`src/validations/vehicle.ts`:

```typescript
import { z } from 'zod'
import { VehicleType, VehicleStatus, MaintenanceType } from '@prisma/client'

const locationSchema = z.object({
  latitude: z.number().min(-90).max(90, '纬度必须在-90到90之间'),
  longitude: z.number().min(-180).max(180, '经度必须在-180到180之间'),
  address: z.string().optional(),
  speed: z.number().min(0).max(300, '速度必须在0-300之间').optional(),
  heading: z.number().min(0).max(360, '方向必须在0-360度之间').optional(),
  accuracy: z.number().positive('GPS精度必须大于0').optional()
})

export const createVehicleSchema = z.object({
  licenseNumber: z.string().min(1, '车牌号不能为空'),
  vinNumber: z.string().min(17, 'VIN码长度必须为17位').max(17, 'VIN码长度必须为17位'),
  brand: z.string().min(1, '品牌不能为空'),
  model: z.string().min(1, '型号不能为空'),
  year: z.number().min(1900).max(new Date().getFullYear() + 1, '年份无效'),
  color: z.string().optional(),
  vehicleType: z.nativeEnum(VehicleType),
  maxLoad: z.number().positive('最大载重必须大于0'),
  maxVolume: z.number().positive('最大体积必须大于0'),
  dailyRate: z.number().positive('日租金必须大于0'),
  insuranceCompany: z.string().optional(),
  insurancePolicy: z.string().optional(),
  insuranceExpiry: z.date().optional(),
  nextMaintenance: z.date().optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional()
})

export const updateVehicleSchema = z.object({
  licenseNumber: z.string().min(1, '车牌号不能为空').optional(),
  vinNumber: z.string().min(17, 'VIN码长度必须为17位').max(17, 'VIN码长度必须为17位').optional(),
  brand: z.string().min(1, '品牌不能为空').optional(),
  model: z.string().min(1, '型号不能为空').optional(),
  year: z.number().min(1900).max(new Date().getFullYear() + 1, '年份无效').optional(),
  color: z.string().optional(),
  vehicleType: z.nativeEnum(VehicleType).optional(),
  maxLoad: z.number().positive('最大载重必须大于0').optional(),
  maxVolume: z.number().positive('最大体积必须大于0').optional(),
  dailyRate: z.number().positive('日租金必须大于0').optional(),
  status: z.nativeEnum(VehicleStatus).optional(),
  driverId: z.string().optional(),
  nextMaintenance: z.date().optional(),
  insuranceCompany: z.string().optional(),
  insurancePolicy: z.string().optional(),
  insuranceExpiry: z.date().optional(),
  fuelLevel: z.number().min(0).max(100, '燃油百分比必须在0-100之间').optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional(),
  isActive: z.boolean().optional()
})

export const updateVehicleLocationSchema = locationSchema

export const vehicleQuerySchema = z.object({
  status: z.nativeEnum(VehicleStatus).optional(),
  vehicleType: z.nativeEnum(VehicleType).optional(),
  driverId: z.string().optional(),
  available: z.boolean().optional(),
  minMaxLoad: z.number().positive().optional(),
  maxMaxLoad: z.number().positive().optional(),
  tags: z.array(z.string()).optional(),
  search: z.string().optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(20),
  sortBy: z.string().default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc')
})

export const createMaintenanceSchema = z.object({
  maintenanceType: z.nativeEnum(MaintenanceType),
  description: z.string().min(1, '维护描述不能为空'),
  cost: z.number().positive('维护费用必须大于0'),
  mileage: z.number().positive('里程数必须大于0'),
  performedBy: z.string().min(1, '执行人不能为空'),
  performedAt: z.date(),
  nextDueDate: z.date().optional(),
  notes: z.string().optional()
})

export const createFuelRecordSchema = z.object({
  fuelAmount: z.number().positive('加油量必须大于0'),
  fuelCost: z.number().positive('加油费用必须大于0'),
  fuelType: z.string().min(1, '燃油类型不能为空'),
  mileage: z.number().positive('里程数必须大于0'),
  location: z.string().optional(),
  filledBy: z.string().min(1, '加油人不能为空'),
  filledAt: z.date().optional(),
  notes: z.string().optional()
})
```

### 4. 实现车辆API路由

创建`src/app/api/vehicles/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { vehicleQuerySchema } from '@/validations/vehicle'
import { getCurrentUser } from '@/lib/auth'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const searchParams = request.nextUrl.searchParams
    const query = {
      status: searchParams.get('status') || undefined,
      vehicleType: searchParams.get('vehicleType') || undefined,
      driverId: searchParams.get('driverId') || undefined,
      available: searchParams.get('available') === 'true' ? true : undefined,
      minMaxLoad: searchParams.get('minMaxLoad') ? parseFloat(searchParams.get('minMaxLoad')!) : undefined,
      maxMaxLoad: searchParams.get('maxMaxLoad') ? parseFloat(searchParams.get('maxMaxLoad')!) : undefined,
      tags: searchParams.get('tags') ? searchParams.get('tags')!.split(',') : undefined,
      search: searchParams.get('search') || undefined,
      page: parseInt(searchParams.get('page') || '1'),
      limit: parseInt(searchParams.get('limit') || '20'),
      sortBy: searchParams.get('sortBy') || 'createdAt',
      sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') || 'desc'
    }

    const validatedQuery = vehicleQuerySchema.parse(query)

    const where: any = { isActive: true }
    if (validatedQuery.status) where.status = validatedQuery.status
    if (validatedQuery.vehicleType) where.vehicleType = validatedQuery.vehicleType
    if (validatedQuery.driverId) where.driverId = validatedQuery.driverId
    if (validatedQuery.available) where.status = VehicleStatus.AVAILABLE
    if (validatedQuery.minMaxLoad !== undefined || validatedQuery.maxMaxLoad !== undefined) {
      where.maxLoad = {}
      if (validatedQuery.minMaxLoad !== undefined) where.maxLoad.gte = validatedQuery.minMaxLoad
      if (validatedQuery.maxMaxLoad !== undefined) where.maxLoad.lte = validatedQuery.maxMaxLoad
    }
    if (validatedQuery.tags && validatedQuery.tags.length > 0) {
      where.tags = {
        hasSome: validatedQuery.tags
      }
    }

    // 搜索功能
    if (validatedQuery.search) {
      where.OR = [
        { licenseNumber: { contains: validatedQuery.search } },
        { vinNumber: { contains: validatedQuery.search } },
        { brand: { contains: validatedQuery.search } },
        { model: { contains: validatedQuery.search } },
        { driver: { name: { contains: validatedQuery.search } } }
      ]
    }

    const [vehicles, total] = await Promise.all([
      prisma.vehicle.findMany({
        where,
        include: {
          driver: {
            select: {
              id: true,
              name: true,
              phone: true,
              licenseNumber: true
            }
          },
          location: true,
          shipments: {
            select: {
              id: true,
              shipmentNumber: true,
              status: true,
              originAddress: true,
              destinationAddress: true
            },
            take: 3,
            orderBy: { createdAt: 'desc' }
          },
          _count: {
            select: {
              shipments: true,
              maintenanceRecords: true
            }
          }
        },
        skip: (validatedQuery.page - 1) * validatedQuery.limit,
        take: validatedQuery.limit,
        orderBy: {
          [validatedQuery.sortBy]: validatedQuery.sortOrder
        }
      }),
      prisma.vehicle.count({ where })
    ])

    return NextResponse.json({
      success: true,
      data: vehicles,
      pagination: {
        page: validatedQuery.page,
        limit: validatedQuery.limit,
        total,
        pages: Math.ceil(total / validatedQuery.limit)
      }
    })
  } catch (error) {
    console.error('获取车辆列表失败:', error)
    return NextResponse.json(
      { error: '获取车辆列表失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = createVehicleSchema.parse(body)

    // 检查车牌号是否已存在
    const existingLicense = await prisma.vehicle.findUnique({
      where: { licenseNumber: validatedData.licenseNumber }
    })

    if (existingLicense) {
      return NextResponse.json(
        { error: '车牌号已存在' },
        { status: 400 }
      )
    }

    // 检查VIN码是否已存在
    const existingVin = await prisma.vehicle.findUnique({
      where: { vinNumber: validatedData.vinNumber }
    })

    if (existingVin) {
      return NextResponse.json(
        { error: 'VIN码已存在' },
        { status: 400 }
      )
    }

    const vehicle = await prisma.vehicle.create({
      data: {
        licenseNumber: validatedData.licenseNumber,
        vinNumber: validatedData.vinNumber,
        brand: validatedData.brand,
        model: validatedData.model,
        year: validatedData.year,
        color: validatedData.color,
        vehicleType: validatedData.vehicleType,
        maxLoad: validatedData.maxLoad,
        maxVolume: validatedData.maxVolume,
        currentLoad: 0,
        currentVolume: 0,
        status: VehicleStatus.AVAILABLE,
        dailyRate: validatedData.dailyRate,
        insuranceCompany: validatedData.insuranceCompany,
        insurancePolicy: validatedData.insurancePolicy,
        insuranceExpiry: validatedData.insuranceExpiry,
        nextMaintenance: validatedData.nextMaintenance,
        mileage: 0,
        fuelLevel: 100,
        maintenanceCost: 0,
        fuelCost: 0,
        tags: validatedData.tags || [],
        notes: validatedData.notes,
        createdBy: user.id,
        updatedBy: user.id
      },
      include: {
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        },
        location: true
      }
    })

    return NextResponse.json({
      success: true,
      data: vehicle,
      message: '车辆创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建车辆失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建车辆失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 5. 实现单个车辆操作路由

创建`src/app/api/vehicles/[id]/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { updateVehicleSchema } from '@/validations/vehicle'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id },
      include: {
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true,
            status: true
          }
        },
        location: true,
        shipments: {
          select: {
            id: true,
            shipmentNumber: true,
            status: true,
            originAddress: true,
            destinationAddress: true,
            departureTime: true,
            estimatedArrival: true,
            actualArrival: true
          },
          take: 10,
          orderBy: { createdAt: 'desc' }
        },
        maintenanceRecords: {
          take: 10,
          orderBy: { performedAt: 'desc' }
        },
        fuelRecords: {
          take: 10,
          orderBy: { filledAt: 'desc' }
        },
        locationHistory: {
          take: 50,
          orderBy: { timestamp: 'desc' }
        }
      }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      success: true,
      data: vehicle
    })
  } catch (error) {
    console.error('获取车辆详情失败:', error)
    return NextResponse.json(
      { error: '获取车辆详情失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = updateVehicleSchema.parse(body)

    const existingVehicle = await prisma.vehicle.findUnique({
      where: { id: params.id }
    })

    if (!existingVehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    // 检查车牌号是否已被其他车辆使用
    if (validatedData.licenseNumber && validatedData.licenseNumber !== existingVehicle.licenseNumber) {
      const licenseExists = await prisma.vehicle.findUnique({
        where: { licenseNumber: validatedData.licenseNumber }
      })

      if (licenseExists) {
        return NextResponse.json(
          { error: '车牌号已被使用' },
          { status: 400 }
        )
      }
    }

    // 检查VIN码是否已被其他车辆使用
    if (validatedData.vinNumber && validatedData.vinNumber !== existingVehicle.vinNumber) {
      const vinExists = await prisma.vehicle.findUnique({
        where: { vinNumber: validatedData.vinNumber }
      })

      if (vinExists) {
        return NextResponse.json(
          { error: 'VIN码已被使用' },
          { status: 400 }
        )
      }
    }

    const updateData: any = {
      updatedBy: user.id,
      updatedAt: new Date()
    }

    // 更新字段
    const updatableFields = [
      'licenseNumber', 'vinNumber', 'brand', 'model', 'year', 'color',
      'vehicleType', 'maxLoad', 'maxVolume', 'dailyRate', 'status',
      'driverId', 'nextMaintenance', 'insuranceCompany', 'insurancePolicy',
      'insuranceExpiry', 'fuelLevel', 'notes', 'tags', 'isActive'
    ]

    updatableFields.forEach(field => {
      if (validatedData[field] !== undefined) {
        updateData[field] = validatedData[field]
      }
    })

    const updatedVehicle = await prisma.vehicle.update({
      where: { id: params.id },
      data: updateData,
      include: {
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        },
        location: true
      }
    })

    return NextResponse.json({
      success: true,
      data: updatedVehicle,
      message: '车辆信息更新成功'
    })
  } catch (error) {
    console.error('更新车辆信息失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '更新车辆信息失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id },
      include: {
        _count: {
          select: {
            shipments: true
          }
        }
      }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    // 检查车辆是否有关联的运单
    if (vehicle._count.shipments > 0) {
      return NextResponse.json(
        { error: '车辆存在关联的运单，无法删除' },
        { status: 400 }
      )
    }

    // 软删除
    await prisma.vehicle.update({
      where: { id: params.id },
      data: {
        isActive: false,
        updatedBy: user.id,
        updatedAt: new Date()
      }
    })

    return NextResponse.json({
      success: true,
      message: '车辆删除成功'
    })
  } catch (error) {
    console.error('删除车辆失败:', error)
    return NextResponse.json(
      { error: '删除车辆失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 6. 实现车辆位置更新API

创建`src/app/api/vehicles/[id]/location/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { updateVehicleLocationSchema } from '@/validations/vehicle'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    const location = await prisma.vehicleLocation.findUnique({
      where: { vehicleId: params.id }
    })

    return NextResponse.json({
      success: true,
      data: location
    })
  } catch (error) {
    console.error('获取车辆位置失败:', error)
    return NextResponse.json(
      { error: '获取车辆位置失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = updateVehicleLocationSchema.parse(body)

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    const locationData = {
      latitude: validatedData.latitude,
      longitude: validatedData.longitude,
      address: validatedData.address,
      speed: validatedData.speed || 0,
      heading: validatedData.heading || 0,
      timestamp: new Date(),
      accuracy: validatedData.accuracy
    }

    // 更新当前位置
    const location = await prisma.vehicleLocation.upsert({
      where: { vehicleId: params.id },
      update: locationData,
      create: {
        vehicleId: params.id,
        ...locationData
      }
    })

    // 添加到历史记录
    await prisma.vehicleLocationHistory.create({
      data: {
        vehicleId: params.id,
        ...locationData
      }
    })

    return NextResponse.json({
      success: true,
      data: location,
      message: '车辆位置更新成功'
    })
  } catch (error) {
    console.error('更新车辆位置失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '更新车辆位置失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 7. 实现车辆维护记录API

创建`src/app/api/vehicles/[id]/maintenance/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { createMaintenanceSchema } from '@/validations/vehicle'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    const searchParams = request.nextUrl.searchParams
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '20')

    const [records, total] = await Promise.all([
      prisma.vehicleMaintenance.findMany({
        where: { vehicleId: params.id },
        skip: (page - 1) * limit,
        take: limit,
        orderBy: { performedAt: 'desc' }
      }),
      prisma.vehicleMaintenance.count({
        where: { vehicleId: params.id }
      })
    ])

    return NextResponse.json({
      success: true,
      data: records,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    })
  } catch (error) {
    console.error('获取车辆维护记录失败:', error)
    return NextResponse.json(
      { error: '获取车辆维护记录失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = createMaintenanceSchema.parse(body)

    const vehicle = await prisma.vehicle.findUnique({
      where: { id: params.id }
    })

    if (!vehicle) {
      return NextResponse.json(
        { error: '车辆不存在' },
        { status: 404 }
      )
    }

    const record = await prisma.vehicleMaintenance.create({
      data: {
        vehicleId: params.id,
        maintenanceType: validatedData.maintenanceType,
        description: validatedData.description,
        cost: validatedData.cost,
        mileage: validatedData.mileage,
        performedBy: validatedData.performedBy,
        performedAt: validatedData.performedAt,
        nextDueDate: validatedData.nextDueDate,
        notes: validatedData.notes
      }
    })

    // 更新车辆的维护信息
    await prisma.vehicle.update({
      where: { id: params.id },
      data: {
        lastMaintenance: validatedData.performedAt,
        nextMaintenance: validatedData.nextDueDate,
        mileage: validatedData.mileage,
        maintenanceCost: {
          increment: validatedData.cost
        }
      }
    })

    return NextResponse.json({
      success: true,
      data: record,
      message: '维护记录创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建车辆维护记录失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建车辆维护记录失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 8. 创建车辆服务层

创建`src/services/vehicleService.ts`:

```typescript
import { prisma } from '@/lib/prisma'
import { VehicleStatus, VehicleType } from '@prisma/client'

export class VehicleService {
  static async getAvailableVehicles(params: any = {}) {
    const { vehicleType, minLoad, minVolume, startTime, endTime } = params

    const where: any = {
      status: VehicleStatus.AVAILABLE,
      isActive: true
    }

    if (vehicleType) where.vehicleType = vehicleType
    if (minLoad) where.maxLoad = { gte: minLoad }
    if (minVolume) where.maxVolume = { gte: minVolume }

    // 检查车辆在指定时间是否可用
    if (startTime && endTime) {
      const unavailableVehicles = await prisma.shipment.findMany({
        where: {
          OR: [
            {
              departureTime: { lte: endTime },
              estimatedArrival: { gte: startTime }
            }
          ],
          status: {
            in: [VehicleStatus.IN_TRANSIT, VehicleStatus.LOADING, VehicleStatus.UNLOADING]
          }
        },
        select: { vehicleId: true }
      })

      const unavailableIds = unavailableVehicles.map(v => v.vehicleId)
      if (unavailableIds.length > 0) {
        where.id = { notIn: unavailableIds }
      }
    }

    return await prisma.vehicle.findMany({
      where,
      include: {
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        },
        location: true
      },
      orderBy: { createdAt: 'desc' }
    })
  }

  static async updateVehicleStatus(vehicleId: string, status: VehicleStatus, userId: string) {
    const vehicle = await prisma.vehicle.findUnique({
      where: { id: vehicleId }
    })

    if (!vehicle) {
      throw new Error('车辆不存在')
    }

    const validTransitions = {
      [VehicleStatus.AVAILABLE]: [VehicleStatus.IN_TRANSIT, VehicleStatus.LOADING, VehicleStatus.MAINTENANCE, VehicleStatus.RESERVED],
      [VehicleStatus.IN_TRANSIT]: [VehicleStatus.AVAILABLE, VehicleStatus.UNLOADING],
      [VehicleStatus.LOADING]: [VehicleStatus.IN_TRANSIT, VehicleStatus.AVAILABLE],
      [VehicleStatus.UNLOADING]: [VehicleStatus.AVAILABLE],
      [VehicleStatus.MAINTENANCE]: [VehicleStatus.AVAILABLE, VehicleStatus.REPAIR],
      [VehicleStatus.REPAIR]: [VehicleStatus.AVAILABLE, VehicleStatus.OUT_OF_SERVICE],
      [VehicleStatus.OUT_OF_SERVICE]: [VehicleStatus.AVAILABLE],
      [VehicleStatus.RESERVED]: [VehicleStatus.AVAILABLE, VehicleStatus.LOADING]
    }

    if (!validTransitions[vehicle.status].includes(status)) {
      throw new Error(`无法从 ${vehicle.status} 转换到 ${status}`)
    }

    const updatedVehicle = await prisma.vehicle.update({
      where: { id: vehicleId },
      data: {
        status,
        updatedBy: userId,
        updatedAt: new Date()
      },
      include: {
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        },
        location: true
      }
    })

    return updatedVehicle
  }

  static async calculateVehicleUtilization(vehicleId: string, startDate: Date, endDate: Date) {
    const shipments = await prisma.shipment.findMany({
      where: {
        vehicleId,
        departureTime: { gte: startDate },
        estimatedArrival: { lte: endDate }
      }
    })

    const totalDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))
    let busyDays = 0

    for (const shipment of shipments) {
      const start = Math.max(shipment.departureTime.getTime(), startDate.getTime())
      const end = Math.min(shipment.estimatedArrival.getTime(), endDate.getTime())
      busyDays += Math.ceil((end - start) / (1000 * 60 * 60 * 24))
    }

    const utilizationRate = totalDays > 0 ? (busyDays / totalDays) * 100 : 0

    return {
      totalDays,
      busyDays,
      utilizationRate: Math.round(utilizationRate * 100) / 100,
      shipmentCount: shipments.length
    }
  }

  static async getVehicleMaintenanceSchedule(vehicleId: string) {
    const vehicle = await prisma.vehicle.findUnique({
      where: { id: vehicleId },
      include: {
        maintenanceRecords: {
          orderBy: { performedAt: 'desc' },
          take: 5
        }
      }
    })

    if (!vehicle) {
      throw new Error('车辆不存在')
    }

    const now = new Date()
    const nextMaintenance = vehicle.nextMaintenance

    let maintenanceStatus = 'normal'
    let daysUntilMaintenance = null

    if (nextMaintenance) {
      daysUntilMaintenance = Math.ceil((nextMaintenance.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))

      if (daysUntilMaintenance <= 7) {
        maintenanceStatus = 'urgent'
      } else if (daysUntilMaintenance <= 30) {
        maintenanceStatus = 'warning'
      }
    }

    return {
      currentMileage: vehicle.mileage,
      lastMaintenance: vehicle.lastMaintenance,
      nextMaintenance,
      maintenanceStatus,
      daysUntilMaintenance,
      recentMaintenance: vehicle.maintenanceRecords
    }
  }
}
```

## 验证清单

- [ ] 车辆数据模型定义正确
- [ ] API路由实现完整
- [ ] 数据验证Schema有效
- [ ] 车辆创建功能正常
- [ ] 车辆查询功能正常
- [ ] 车辆更新功能正常
- [ ] 车辆删除功能正常
- [ ] 位置更新功能正常
- [ ] 维护记录管理功能正常
- [ ] 服务层功能完整
- [ ] 错误处理机制完善

## 测试命令

```bash
# 运行API测试
npm run test:api

# 数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

## 注意事项

- 确保车辆数据验证规则完善
- 车辆状态转换需要符合业务逻辑
- 位置更新需要同时更新当前位置和历史记录
- 维护记录创建后需要更新车辆维护信息
- 车辆删除需要检查关联的运单
- 可用车辆查询需要考虑时间冲突