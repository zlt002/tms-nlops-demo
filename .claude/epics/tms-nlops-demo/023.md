---
title: "TMS NL-Ops演示系统任务023: LangGraph.js v1环境配置和基础架构"
epic: "tms-nlops-demo"
task: "023"
phase: "4"
status: "pending"
priority: "high"
estimated_hours: 8
parallel: false
depends_on: ["008", "009", "010", "011", "012", "013", "014", "015"]
tags: ["langgraph", "ai", "architecture", "infrastructure"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
---

## 概述

为TMS NL-Ops演示系统配置LangGraph.js v1环境并建立基础架构，包括依赖安装、目录结构设计、配置文件设置和基础框架搭建。

## 目标

- 安装和配置LangGraph.js v1及相关依赖
- 设计Agent模块的目录结构
- 创建基础配置文件和环境设置
- 实现Agent框架的基础架构
- 建立开发环境和工作流程

## 技术栈

- **AI编排**: LangGraph.js v1.0+
- **AI模型**: OpenAI GPT-4-turbo
- **语言**: TypeScript 5.5+
- **框架**: Next.js 15+ (App Router)
- **工具链**: Vercel AI SDK v4.0+

## 实施步骤

### 1. 安装LangGraph.js v1依赖

```bash
# 核心依赖
npm install @langchain/langgraph@1.0.0
npm install @langchain/core@0.3.0
npm install @langchain/community@0.3.0

# AI SDK依赖
npm install @ai-sdk/react@4.0.0
npm install @ai-sdk/openai@1.0.0
npm install openai@4.50.0

# 工具依赖
npm install zod@3.22.4
npm install uuid@9.0.1
npm install date-fns@3.6.0
```

### 2. 创建Agent目录结构

```
/agent
├── /graph                    # 工作流定义
│   ├── state.ts             # 状态定义
│   ├── workflow.ts          # 工作流编排
│   ├── compiler.ts          # 图编译器
│   └── types.ts             # 类型定义
├── /nodes                   # 节点实现
│   ├── supervisor.ts       # 主管节点
│   ├── tool-executor.ts     # 工具执行节点
│   ├── ui-generator.ts      # UI生成节点
│   └── error-handler.ts     # 错误处理节点
├── /tools                   # 工具定义
│   ├── order-tools.ts       # 订单相关工具
│   ├── dispatch-tools.ts    # 调度相关工具
│   ├── tracking-tools.ts    # 跟踪相关工具
│   ├── pod-tools.ts         # 回单相关工具
│   └── common-tools.ts      # 通用工具
├── /state                   # 状态管理
│   ├── agent-state.ts       # Agent状态
│   ├── context-manager.ts   # 上下文管理
│   └── history-manager.ts   # 历史记录管理
├── /prompts                 # 提示词管理
│   ├── system-prompts.ts    # 系统提示词
│   ├── tool-prompts.ts      # 工具提示词
│   └── error-prompts.ts     # 错误处理提示词
├── /utils                   # 工具函数
│   ├── stream-handler.ts    # 流式处理
│   ├── error-utils.ts       # 错误处理工具
│   ├── validation.ts        # 数据验证
│   └── helpers.ts           # 辅助函数
├── /types                   # 类型定义
│   ├── agent.ts             # Agent相关类型
│   ├── tools.ts             # 工具相关类型
│   ├── ui.ts                # UI相关类型
│   └── common.ts            # 通用类型
├── config.ts                # Agent配置
├── constants.ts             # 常量定义
└── index.ts                 # 导出文件
```

### 3. 创建基础配置文件

创建`agent/config.ts`:

```typescript
import { createOpenAI } from '@ai-sdk/openai'

// AI模型配置
export const aiConfig = {
  openai: createOpenAI({
    apiKey: process.env.OPENAI_API_KEY,
    baseURL: process.env.OPENAI_BASE_URL,
  }),
  model: process.env.OPENAI_MODEL || 'gpt-4-turbo-preview',
  temperature: 0.1,
  maxTokens: 4000,
}

// Agent配置
export const agentConfig = {
  name: 'TMS Assistant',
  version: '1.0.0',
  description: '智能运输管理系统助手',
  maxSteps: 10,
  timeout: 30000, // 30秒
  maxRetries: 3,
}

// 工作流配置
export const workflowConfig = {
  streamMode: 'values' as const,
  checkpointer: {
    type: 'memory', // 使用内存检查点
    ttl: 3600000, // 1小时
  },
  recursionLimit: 100,
}

// UI组件配置
export const uiConfig = {
  defaultComponent: 'Card',
  maxComponentDepth: 3,
  enableAnimation: true,
  responsive: true,
}
```

### 4. 创建类型定义

创建`agent/types/agent.ts`:

```typescript
import { BaseMessage } from '@langchain/core/messages'
import { Tool } from '@langchain/core/tools'

// Agent状态接口
export interface AgentState {
  messages: BaseMessage[]
  context: AgentContext
  data: AgentData
  ui: UIState
  metadata: AgentMetadata
}

export interface AgentContext {
  userRole: 'dispatcher' | 'customer_service' | 'manager' | 'customer'
  currentTask?: string
  taskHistory: string[]
  intent?: string
  entities: Record<string, any>
  session?: {
    id: string
    startTime: Date
    lastActivity: Date
  }
}

export interface AgentData {
  orders?: any[]
  vehicles?: any[]
  dispatch?: any
  tracking?: any[]
  pod?: any
  customers?: any[]
  results: Record<string, any>
}

export interface UIState {
  component?: string
  props?: Record<string, any>
  layout?: 'vertical' | 'horizontal' | 'grid'
  actions?: UIAction[]
  loading?: boolean
  error?: string
}

export interface UIAction {
  type: 'button' | 'link' | 'form' | 'modal'
  label: string
  action: string
  params?: Record<string, any>
  style?: 'primary' | 'secondary' | 'outline' | 'ghost'
}

export interface AgentMetadata {
  startTime: Date
  stepCount: number
  toolCalls: ToolCall[]
  errors: ErrorInfo[]
  performance: PerformanceMetrics
}

export interface ToolCall {
  id: string
  toolName: string
  args: Record<string, any>
  result?: any
  error?: string
  timestamp: Date
}

export interface ErrorInfo {
  type: string
  message: string
  stack?: string
  timestamp: Date
  handled: boolean
}

export interface PerformanceMetrics {
  totalTime: number
  toolExecutionTime: number
  llmCalls: number
  tokenUsage: {
    prompt: number
    completion: number
    total: number
  }
}

// Agent配置接口
export interface AgentConfig {
  name: string
  version: string
  description: string
  maxSteps: number
  timeout: number
  maxRetries: number
  tools: Tool[]
  systemPrompt: string
}

// 工作流状态接口
export interface WorkflowState {
  current: string
  history: WorkflowStep[]
  context: Record<string, any>
  result?: any
  error?: Error
}

export interface WorkflowStep {
  name: string
  input: any
  output: any
  startTime: Date
  endTime: Date
  duration: number
  status: 'pending' | 'running' | 'completed' | 'failed'
}
```

### 5. 创建状态管理

创建`agent/state/agent-state.ts`:

```typescript
import { AgentState, AgentContext, AgentData, UIState, AgentMetadata } from '../types/agent'
import { BaseMessage } from '@langchain/core/messages'
import { v4 as uuidv4 } from 'uuid'

export class AgentStateManager {
  private state: AgentState

  constructor(initialState?: Partial<AgentState>) {
    this.state = {
      messages: [],
      context: this.initializeContext(),
      data: this.initializeData(),
      ui: this.initializeUI(),
      metadata: this.initializeMetadata(),
      ...initialState,
    }
  }

  private initializeContext(): AgentContext {
    return {
      userRole: 'customer',
      taskHistory: [],
      entities: {},
      session: {
        id: uuidv4(),
        startTime: new Date(),
        lastActivity: new Date(),
      },
    }
  }

  private initializeData(): AgentData {
    return {
      results: {},
    }
  }

  private initializeUI(): UIState {
    return {}
  }

  private initializeMetadata(): AgentMetadata {
    return {
      startTime: new Date(),
      stepCount: 0,
      toolCalls: [],
      errors: [],
      performance: {
        totalTime: 0,
        toolExecutionTime: 0,
        llmCalls: 0,
        tokenUsage: {
          prompt: 0,
          completion: 0,
          total: 0,
        },
      },
    }
  }

  // 获取当前状态
  getState(): AgentState {
    return { ...this.state }
  }

  // 更新消息
  addMessage(message: BaseMessage): void {
    this.state.messages.push(message)
    this.state.metadata.stepCount++
    this.state.context.session!.lastActivity = new Date()
  }

  // 更新上下文
  updateContext(updates: Partial<AgentContext>): void {
    this.state.context = { ...this.state.context, ...updates }
  }

  // 更新数据
  updateData(updates: Partial<AgentData>): void {
    this.state.data = { ...this.state.data, ...updates }
  }

  // 更新UI状态
  updateUI(updates: Partial<UIState>): void {
    this.state.ui = { ...this.state.ui, ...updates }
  }

  // 记录工具调用
  recordToolCall(toolCall: Omit<ToolCall, 'id' | 'timestamp'>): void {
    this.state.metadata.toolCalls.push({
      ...toolCall,
      id: uuidv4(),
      timestamp: new Date(),
    })
  }

  // 记录错误
  recordError(error: Error, handled: boolean = false): void {
    this.state.metadata.errors.push({
      type: error.name,
      message: error.message,
      stack: error.stack,
      timestamp: new Date(),
      handled,
    })
  }

  // 更新性能指标
  updatePerformance(metrics: Partial<AgentMetadata['performance']>): void {
    this.state.metadata.performance = {
      ...this.state.metadata.performance,
      ...metrics,
    }
  }

  // 重置状态
  reset(keepContext: boolean = false): void {
    if (keepContext) {
      const context = this.state.context
      this.state = {
        messages: [],
        context,
        data: this.initializeData(),
        ui: this.initializeUI(),
        metadata: this.initializeMetadata(),
      }
    } else {
      this.state = {
        messages: [],
        context: this.initializeContext(),
        data: this.initializeData(),
        ui: this.initializeUI(),
        metadata: this.initializeMetadata(),
      }
    }
  }

  // 获取会话摘要
  getSessionSummary(): string {
    const { context, metadata } = this.state
    return `
Session ID: ${context.session?.id}
Duration: ${Date.now() - context.session!.startTime.getTime()}ms
Steps: ${metadata.stepCount}
Tool Calls: ${metadata.toolCalls.length}
Errors: ${metadata.errors.length}
    `.trim()
  }
}
```

### 6. 创建基础工作流

创建`agent/graph/workflow.ts`:

```typescript
import { StateGraph, MessagesAnnotation } from '@langchain/langgraph'
import { AgentState } from '../types/agent'
import { AgentStateManager } from '../state/agent-state'
import { workflowConfig } from '../config'

export class WorkflowManager {
  private stateManager: AgentStateManager
  private graph: any

  constructor() {
    this.stateManager = new AgentStateManager()
    this.graph = this.createWorkflow()
  }

  private createWorkflow() {
    // 创建状态图
    const workflow = new StateGraph(AgentState)

    // 添加节点（将在后续任务中实现）
    workflow.addNode('supervisor', this.supervisorNode.bind(this))
    workflow.addNode('tools', this.toolsNode.bind(this))
    workflow.addNode('ui-generator', this.uiGeneratorNode.bind(this))
    workflow.addNode('error-handler', this.errorHandlerNode.bind(this))

    // 设置入口点
    workflow.addEdge('__start__', 'supervisor')

    // 添加条件边
    workflow.addConditionalEdges(
      'supervisor',
      (state: AgentState) => {
        const lastMessage = state.messages[state.messages.length - 1]
        if (lastMessage.tool_calls && lastMessage.tool_calls.length > 0) {
          return 'tools'
        }
        return 'ui-generator'
      },
      {
        tools: 'tools',
        'ui-generator': 'ui-generator',
      }
    )

    // 添加普通边
    workflow.addEdge('tools', 'supervisor')
    workflow.addEdge('ui-generator', '__end__')

    // 编译图
    return workflow.compile({
      ...workflowConfig,
      // 添加中断点用于调试
      interruptBefore: [],
      interruptAfter: [],
    })
  }

  private async supervisorNode(state: AgentState): Promise<Partial<AgentState>> {
    // 主管节点逻辑（将在026任务中实现）
    this.stateManager.updateContext({ currentTask: 'supervisor_decision' })

    return {
      ...state,
      metadata: {
        ...state.metadata,
        stepCount: state.metadata.stepCount + 1,
      },
    }
  }

  private async toolsNode(state: AgentState): Promise<Partial<AgentState>> {
    // 工具执行节点逻辑（将在026任务中实现）
    return state
  }

  private async uiGeneratorNode(state: AgentState): Promise<Partial<AgentState>> {
    // UI生成节点逻辑（将在026任务中实现）
    return state
  }

  private async errorHandlerNode(state: AgentState): Promise<Partial<AgentState>> {
    // 错误处理节点逻辑（将在026任务中实现）
    return state
  }

  // 执行工作流
  async execute(input: Partial<AgentState>) {
    const initialState = this.stateManager.getState()
    const finalState = await this.graph.invoke({
      ...initialState,
      ...input,
    })

    return finalState
  }

  // 流式执行工作流
  async *stream(input: Partial<AgentState>) {
    const initialState = this.stateManager.getState()
    const stream = await this.graph.stream({
      ...initialState,
      ...input,
    })

    for await (const chunk of stream) {
      yield chunk
    }
  }
}
```

### 7. 创建环境变量配置

更新`.env.local`:

```env
# OpenAI配置
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4-turbo-preview

# Agent配置
AGENT_NAME=TMS Assistant
AGENT_VERSION=1.0.0
AGENT_MAX_STEPS=10
AGENT_TIMEOUT=30000

# 数据库配置
DATABASE_URL=postgresql://postgres:HhnthnBBEWhCdiZL@47.115.43.94:5432/HhnthnBBEWhCdiZL

# 应用配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### 8. 创建基础API路由

创建`app/api/chat/route.ts`:

```typescript
import { StreamingTextResponse, Message } from 'ai'
import { WorkflowManager } from '@/agent/graph/workflow'
import { openai } from '@ai-sdk/openai'
import { convertToCoreMessages } from 'ai'

export async function POST(req: Request) {
  try {
    const { messages } = await req.json()
    const coreMessages = convertToCoreMessages(messages)

    // 创建工作流管理器
    const workflow = new WorkflowManager()

    // 准备输入状态
    const input = {
      messages: coreMessages,
    }

    // 执行工作流
    const result = await workflow.execute(input)

    // 返回响应
    const lastMessage = result.messages[result.messages.length - 1]

    return new StreamingTextResponse(
      new ReadableStream({
        async start(controller) {
          try {
            if (lastMessage.content) {
              controller.enqueue(lastMessage.content)
            }
            controller.close()
          } catch (error) {
            controller.error(error)
          }
        },
      })
    )
  } catch (error) {
    console.error('Chat API Error:', error)
    return new Response('Internal Server Error', { status: 500 })
  }
}
```

### 9. 创建开发工具脚本

创建`scripts/agent-dev.js`:

```javascript
const { spawn } = require('child_process')
const path = require('path')

// 开发服务器
function startDevServer() {
  console.log('🚀 Starting development server...')

  const server = spawn('npm', ['run', 'dev'], {
    stdio: 'inherit',
    shell: true,
  })

  server.on('close', (code) => {
    console.log(`Dev server exited with code ${code}`)
  })
}

// Agent测试工具
function testAgent() {
  console.log('🤖 Testing agent...')

  const test = spawn('npx', ['tsx', 'scripts/test-agent.ts'], {
    stdio: 'inherit',
    shell: true,
  })

  test.on('close', (code) => {
    console.log(`Agent test exited with code ${code}`)
  })
}

// 主函数
function main() {
  const command = process.argv[2]

  switch (command) {
    case 'dev':
      startDevServer()
      break
    case 'test':
      testAgent()
      break
    default:
      console.log('Usage: npm run agent:dev|test')
      process.exit(1)
  }
}

main()
```

### 10. 更新package.json

```json
{
  "scripts": {
    "agent:dev": "node scripts/agent-dev.js dev",
    "agent:test": "node scripts/agent-dev.js test",
    "type-check": "tsc --noEmit",
    "build": "next build",
    "dev": "next dev"
  }
}
```

## 验证清单

- [ ] LangGraph.js v1依赖安装成功
- [ ] 目录结构创建完成
- [ ] 基础配置文件设置完成
- [ ] 类型定义正确
- [ ] 状态管理实现正常
- [ ] 工作流基础框架搭建完成
- [ ] 环境变量配置正确
- [ ] 开发工具脚本可用
- [ ] TypeScript类型检查通过
- [ ] 基础API路由可访问

## 测试命令

```bash
# 安装依赖
npm install

# 类型检查
npm run type-check

# 启动开发服务器
npm run agent:dev

# 测试基础框架
npm run agent:test

# 构建项目
npm run build
```

## 注意事项

- 确保OpenAI API密钥正确配置
- LangGraph.js v1的API可能有所变化，需要关注官方文档
- 状态管理需要考虑内存使用情况
- 错误处理机制需要完善
- 开发时注意观察控制台日志

## 下一步

完成本任务后，将进行任务024: Agent状态定义和管理，为后续的节点实现和工具开发打下基础。