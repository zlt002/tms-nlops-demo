---
title: "TMS NL-Opsæ¼”ç¤ºç³»ç»Ÿä»»åŠ¡023: LangGraph.js v1ç¯å¢ƒé…ç½®å’ŒåŸºç¡€æ¶æ„"
epic: "tms-nlops-demo"
task: "023"
phase: "4"
status: "pending"
priority: "high"
estimated_hours: 8
parallel: false
depends_on: ["008", "009", "010", "011", "012", "013", "014", "015"]
tags: ["langgraph", "ai", "architecture", "infrastructure"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
---

## æ¦‚è¿°

ä¸ºTMS NL-Opsæ¼”ç¤ºç³»ç»Ÿé…ç½®LangGraph.js v1ç¯å¢ƒå¹¶å»ºç«‹åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬ä¾èµ–å®‰è£…ã€ç›®å½•ç»“æ„è®¾è®¡ã€é…ç½®æ–‡ä»¶è®¾ç½®å’ŒåŸºç¡€æ¡†æ¶æ­å»ºã€‚

## ç›®æ ‡

- å®‰è£…å’Œé…ç½®LangGraph.js v1åŠç›¸å…³ä¾èµ–
- è®¾è®¡Agentæ¨¡å—çš„ç›®å½•ç»“æ„
- åˆ›å»ºåŸºç¡€é…ç½®æ–‡ä»¶å’Œç¯å¢ƒè®¾ç½®
- å®ç°Agentæ¡†æ¶çš„åŸºç¡€æ¶æ„
- å»ºç«‹å¼€å‘ç¯å¢ƒå’Œå·¥ä½œæµç¨‹

## æŠ€æœ¯æ ˆ

- **AIç¼–æ’**: LangGraph.js v1.0+
- **AIæ¨¡å‹**: OpenAI GPT-4-turbo
- **è¯­è¨€**: TypeScript 5.5+
- **æ¡†æ¶**: Next.js 15+ (App Router)
- **å·¥å…·é“¾**: Vercel AI SDK v4.0+

## å®æ–½æ­¥éª¤

### 1. å®‰è£…LangGraph.js v1ä¾èµ–

```bash
# æ ¸å¿ƒä¾èµ–
npm install @langchain/langgraph@1.0.0
npm install @langchain/core@0.3.0
npm install @langchain/community@0.3.0

# AI SDKä¾èµ–
npm install @ai-sdk/react@4.0.0
npm install @ai-sdk/openai@1.0.0
npm install openai@4.50.0

# å·¥å…·ä¾èµ–
npm install zod@3.22.4
npm install uuid@9.0.1
npm install date-fns@3.6.0
```

### 2. åˆ›å»ºAgentç›®å½•ç»“æ„

```
/agent
â”œâ”€â”€ /graph                    # å·¥ä½œæµå®šä¹‰
â”‚   â”œâ”€â”€ state.ts             # çŠ¶æ€å®šä¹‰
â”‚   â”œâ”€â”€ workflow.ts          # å·¥ä½œæµç¼–æ’
â”‚   â”œâ”€â”€ compiler.ts          # å›¾ç¼–è¯‘å™¨
â”‚   â””â”€â”€ types.ts             # ç±»å‹å®šä¹‰
â”œâ”€â”€ /nodes                   # èŠ‚ç‚¹å®ç°
â”‚   â”œâ”€â”€ supervisor.ts       # ä¸»ç®¡èŠ‚ç‚¹
â”‚   â”œâ”€â”€ tool-executor.ts     # å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
â”‚   â”œâ”€â”€ ui-generator.ts      # UIç”ŸæˆèŠ‚ç‚¹
â”‚   â””â”€â”€ error-handler.ts     # é”™è¯¯å¤„ç†èŠ‚ç‚¹
â”œâ”€â”€ /tools                   # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ order-tools.ts       # è®¢å•ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ dispatch-tools.ts    # è°ƒåº¦ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ tracking-tools.ts    # è·Ÿè¸ªç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ pod-tools.ts         # å›å•ç›¸å…³å·¥å…·
â”‚   â””â”€â”€ common-tools.ts      # é€šç”¨å·¥å…·
â”œâ”€â”€ /state                   # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ agent-state.ts       # AgentçŠ¶æ€
â”‚   â”œâ”€â”€ context-manager.ts   # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â””â”€â”€ history-manager.ts   # å†å²è®°å½•ç®¡ç†
â”œâ”€â”€ /prompts                 # æç¤ºè¯ç®¡ç†
â”‚   â”œâ”€â”€ system-prompts.ts    # ç³»ç»Ÿæç¤ºè¯
â”‚   â”œâ”€â”€ tool-prompts.ts      # å·¥å…·æç¤ºè¯
â”‚   â””â”€â”€ error-prompts.ts     # é”™è¯¯å¤„ç†æç¤ºè¯
â”œâ”€â”€ /utils                   # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ stream-handler.ts    # æµå¼å¤„ç†
â”‚   â”œâ”€â”€ error-utils.ts       # é”™è¯¯å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ validation.ts        # æ•°æ®éªŒè¯
â”‚   â””â”€â”€ helpers.ts           # è¾…åŠ©å‡½æ•°
â”œâ”€â”€ /types                   # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ agent.ts             # Agentç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ tools.ts             # å·¥å…·ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ ui.ts                # UIç›¸å…³ç±»å‹
â”‚   â””â”€â”€ common.ts            # é€šç”¨ç±»å‹
â”œâ”€â”€ config.ts                # Agenté…ç½®
â”œâ”€â”€ constants.ts             # å¸¸é‡å®šä¹‰
â””â”€â”€ index.ts                 # å¯¼å‡ºæ–‡ä»¶
```

### 3. åˆ›å»ºåŸºç¡€é…ç½®æ–‡ä»¶

åˆ›å»º`agent/config.ts`:

```typescript
import { createOpenAI } from '@ai-sdk/openai'

// AIæ¨¡å‹é…ç½®
export const aiConfig = {
  openai: createOpenAI({
    apiKey: process.env.OPENAI_API_KEY,
    baseURL: process.env.OPENAI_BASE_URL,
  }),
  model: process.env.OPENAI_MODEL || 'gpt-4-turbo-preview',
  temperature: 0.1,
  maxTokens: 4000,
}

// Agenté…ç½®
export const agentConfig = {
  name: 'TMS Assistant',
  version: '1.0.0',
  description: 'æ™ºèƒ½è¿è¾“ç®¡ç†ç³»ç»ŸåŠ©æ‰‹',
  maxSteps: 10,
  timeout: 30000, // 30ç§’
  maxRetries: 3,
}

// å·¥ä½œæµé…ç½®
export const workflowConfig = {
  streamMode: 'values' as const,
  checkpointer: {
    type: 'memory', // ä½¿ç”¨å†…å­˜æ£€æŸ¥ç‚¹
    ttl: 3600000, // 1å°æ—¶
  },
  recursionLimit: 100,
}

// UIç»„ä»¶é…ç½®
export const uiConfig = {
  defaultComponent: 'Card',
  maxComponentDepth: 3,
  enableAnimation: true,
  responsive: true,
}
```

### 4. åˆ›å»ºç±»å‹å®šä¹‰

åˆ›å»º`agent/types/agent.ts`:

```typescript
import { BaseMessage } from '@langchain/core/messages'
import { Tool } from '@langchain/core/tools'

// AgentçŠ¶æ€æ¥å£
export interface AgentState {
  messages: BaseMessage[]
  context: AgentContext
  data: AgentData
  ui: UIState
  metadata: AgentMetadata
}

export interface AgentContext {
  userRole: 'dispatcher' | 'customer_service' | 'manager' | 'customer'
  currentTask?: string
  taskHistory: string[]
  intent?: string
  entities: Record<string, any>
  session?: {
    id: string
    startTime: Date
    lastActivity: Date
  }
}

export interface AgentData {
  orders?: any[]
  vehicles?: any[]
  dispatch?: any
  tracking?: any[]
  pod?: any
  customers?: any[]
  results: Record<string, any>
}

export interface UIState {
  component?: string
  props?: Record<string, any>
  layout?: 'vertical' | 'horizontal' | 'grid'
  actions?: UIAction[]
  loading?: boolean
  error?: string
}

export interface UIAction {
  type: 'button' | 'link' | 'form' | 'modal'
  label: string
  action: string
  params?: Record<string, any>
  style?: 'primary' | 'secondary' | 'outline' | 'ghost'
}

export interface AgentMetadata {
  startTime: Date
  stepCount: number
  toolCalls: ToolCall[]
  errors: ErrorInfo[]
  performance: PerformanceMetrics
}

export interface ToolCall {
  id: string
  toolName: string
  args: Record<string, any>
  result?: any
  error?: string
  timestamp: Date
}

export interface ErrorInfo {
  type: string
  message: string
  stack?: string
  timestamp: Date
  handled: boolean
}

export interface PerformanceMetrics {
  totalTime: number
  toolExecutionTime: number
  llmCalls: number
  tokenUsage: {
    prompt: number
    completion: number
    total: number
  }
}

// Agenté…ç½®æ¥å£
export interface AgentConfig {
  name: string
  version: string
  description: string
  maxSteps: number
  timeout: number
  maxRetries: number
  tools: Tool[]
  systemPrompt: string
}

// å·¥ä½œæµçŠ¶æ€æ¥å£
export interface WorkflowState {
  current: string
  history: WorkflowStep[]
  context: Record<string, any>
  result?: any
  error?: Error
}

export interface WorkflowStep {
  name: string
  input: any
  output: any
  startTime: Date
  endTime: Date
  duration: number
  status: 'pending' | 'running' | 'completed' | 'failed'
}
```

### 5. åˆ›å»ºçŠ¶æ€ç®¡ç†

åˆ›å»º`agent/state/agent-state.ts`:

```typescript
import { AgentState, AgentContext, AgentData, UIState, AgentMetadata } from '../types/agent'
import { BaseMessage } from '@langchain/core/messages'
import { v4 as uuidv4 } from 'uuid'

export class AgentStateManager {
  private state: AgentState

  constructor(initialState?: Partial<AgentState>) {
    this.state = {
      messages: [],
      context: this.initializeContext(),
      data: this.initializeData(),
      ui: this.initializeUI(),
      metadata: this.initializeMetadata(),
      ...initialState,
    }
  }

  private initializeContext(): AgentContext {
    return {
      userRole: 'customer',
      taskHistory: [],
      entities: {},
      session: {
        id: uuidv4(),
        startTime: new Date(),
        lastActivity: new Date(),
      },
    }
  }

  private initializeData(): AgentData {
    return {
      results: {},
    }
  }

  private initializeUI(): UIState {
    return {}
  }

  private initializeMetadata(): AgentMetadata {
    return {
      startTime: new Date(),
      stepCount: 0,
      toolCalls: [],
      errors: [],
      performance: {
        totalTime: 0,
        toolExecutionTime: 0,
        llmCalls: 0,
        tokenUsage: {
          prompt: 0,
          completion: 0,
          total: 0,
        },
      },
    }
  }

  // è·å–å½“å‰çŠ¶æ€
  getState(): AgentState {
    return { ...this.state }
  }

  // æ›´æ–°æ¶ˆæ¯
  addMessage(message: BaseMessage): void {
    this.state.messages.push(message)
    this.state.metadata.stepCount++
    this.state.context.session!.lastActivity = new Date()
  }

  // æ›´æ–°ä¸Šä¸‹æ–‡
  updateContext(updates: Partial<AgentContext>): void {
    this.state.context = { ...this.state.context, ...updates }
  }

  // æ›´æ–°æ•°æ®
  updateData(updates: Partial<AgentData>): void {
    this.state.data = { ...this.state.data, ...updates }
  }

  // æ›´æ–°UIçŠ¶æ€
  updateUI(updates: Partial<UIState>): void {
    this.state.ui = { ...this.state.ui, ...updates }
  }

  // è®°å½•å·¥å…·è°ƒç”¨
  recordToolCall(toolCall: Omit<ToolCall, 'id' | 'timestamp'>): void {
    this.state.metadata.toolCalls.push({
      ...toolCall,
      id: uuidv4(),
      timestamp: new Date(),
    })
  }

  // è®°å½•é”™è¯¯
  recordError(error: Error, handled: boolean = false): void {
    this.state.metadata.errors.push({
      type: error.name,
      message: error.message,
      stack: error.stack,
      timestamp: new Date(),
      handled,
    })
  }

  // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
  updatePerformance(metrics: Partial<AgentMetadata['performance']>): void {
    this.state.metadata.performance = {
      ...this.state.metadata.performance,
      ...metrics,
    }
  }

  // é‡ç½®çŠ¶æ€
  reset(keepContext: boolean = false): void {
    if (keepContext) {
      const context = this.state.context
      this.state = {
        messages: [],
        context,
        data: this.initializeData(),
        ui: this.initializeUI(),
        metadata: this.initializeMetadata(),
      }
    } else {
      this.state = {
        messages: [],
        context: this.initializeContext(),
        data: this.initializeData(),
        ui: this.initializeUI(),
        metadata: this.initializeMetadata(),
      }
    }
  }

  // è·å–ä¼šè¯æ‘˜è¦
  getSessionSummary(): string {
    const { context, metadata } = this.state
    return `
Session ID: ${context.session?.id}
Duration: ${Date.now() - context.session!.startTime.getTime()}ms
Steps: ${metadata.stepCount}
Tool Calls: ${metadata.toolCalls.length}
Errors: ${metadata.errors.length}
    `.trim()
  }
}
```

### 6. åˆ›å»ºåŸºç¡€å·¥ä½œæµ

åˆ›å»º`agent/graph/workflow.ts`:

```typescript
import { StateGraph, MessagesAnnotation } from '@langchain/langgraph'
import { AgentState } from '../types/agent'
import { AgentStateManager } from '../state/agent-state'
import { workflowConfig } from '../config'

export class WorkflowManager {
  private stateManager: AgentStateManager
  private graph: any

  constructor() {
    this.stateManager = new AgentStateManager()
    this.graph = this.createWorkflow()
  }

  private createWorkflow() {
    // åˆ›å»ºçŠ¶æ€å›¾
    const workflow = new StateGraph(AgentState)

    // æ·»åŠ èŠ‚ç‚¹ï¼ˆå°†åœ¨åç»­ä»»åŠ¡ä¸­å®ç°ï¼‰
    workflow.addNode('supervisor', this.supervisorNode.bind(this))
    workflow.addNode('tools', this.toolsNode.bind(this))
    workflow.addNode('ui-generator', this.uiGeneratorNode.bind(this))
    workflow.addNode('error-handler', this.errorHandlerNode.bind(this))

    // è®¾ç½®å…¥å£ç‚¹
    workflow.addEdge('__start__', 'supervisor')

    // æ·»åŠ æ¡ä»¶è¾¹
    workflow.addConditionalEdges(
      'supervisor',
      (state: AgentState) => {
        const lastMessage = state.messages[state.messages.length - 1]
        if (lastMessage.tool_calls && lastMessage.tool_calls.length > 0) {
          return 'tools'
        }
        return 'ui-generator'
      },
      {
        tools: 'tools',
        'ui-generator': 'ui-generator',
      }
    )

    // æ·»åŠ æ™®é€šè¾¹
    workflow.addEdge('tools', 'supervisor')
    workflow.addEdge('ui-generator', '__end__')

    // ç¼–è¯‘å›¾
    return workflow.compile({
      ...workflowConfig,
      // æ·»åŠ ä¸­æ–­ç‚¹ç”¨äºè°ƒè¯•
      interruptBefore: [],
      interruptAfter: [],
    })
  }

  private async supervisorNode(state: AgentState): Promise<Partial<AgentState>> {
    // ä¸»ç®¡èŠ‚ç‚¹é€»è¾‘ï¼ˆå°†åœ¨026ä»»åŠ¡ä¸­å®ç°ï¼‰
    this.stateManager.updateContext({ currentTask: 'supervisor_decision' })

    return {
      ...state,
      metadata: {
        ...state.metadata,
        stepCount: state.metadata.stepCount + 1,
      },
    }
  }

  private async toolsNode(state: AgentState): Promise<Partial<AgentState>> {
    // å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹é€»è¾‘ï¼ˆå°†åœ¨026ä»»åŠ¡ä¸­å®ç°ï¼‰
    return state
  }

  private async uiGeneratorNode(state: AgentState): Promise<Partial<AgentState>> {
    // UIç”ŸæˆèŠ‚ç‚¹é€»è¾‘ï¼ˆå°†åœ¨026ä»»åŠ¡ä¸­å®ç°ï¼‰
    return state
  }

  private async errorHandlerNode(state: AgentState): Promise<Partial<AgentState>> {
    // é”™è¯¯å¤„ç†èŠ‚ç‚¹é€»è¾‘ï¼ˆå°†åœ¨026ä»»åŠ¡ä¸­å®ç°ï¼‰
    return state
  }

  // æ‰§è¡Œå·¥ä½œæµ
  async execute(input: Partial<AgentState>) {
    const initialState = this.stateManager.getState()
    const finalState = await this.graph.invoke({
      ...initialState,
      ...input,
    })

    return finalState
  }

  // æµå¼æ‰§è¡Œå·¥ä½œæµ
  async *stream(input: Partial<AgentState>) {
    const initialState = this.stateManager.getState()
    const stream = await this.graph.stream({
      ...initialState,
      ...input,
    })

    for await (const chunk of stream) {
      yield chunk
    }
  }
}
```

### 7. åˆ›å»ºç¯å¢ƒå˜é‡é…ç½®

æ›´æ–°`.env.local`:

```env
# OpenAIé…ç½®
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4-turbo-preview

# Agenté…ç½®
AGENT_NAME=TMS Assistant
AGENT_VERSION=1.0.0
AGENT_MAX_STEPS=10
AGENT_TIMEOUT=30000

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://postgres:HhnthnBBEWhCdiZL@47.115.43.94:5432/HhnthnBBEWhCdiZL

# åº”ç”¨é…ç½®
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### 8. åˆ›å»ºåŸºç¡€APIè·¯ç”±

åˆ›å»º`app/api/chat/route.ts`:

```typescript
import { StreamingTextResponse, Message } from 'ai'
import { WorkflowManager } from '@/agent/graph/workflow'
import { openai } from '@ai-sdk/openai'
import { convertToCoreMessages } from 'ai'

export async function POST(req: Request) {
  try {
    const { messages } = await req.json()
    const coreMessages = convertToCoreMessages(messages)

    // åˆ›å»ºå·¥ä½œæµç®¡ç†å™¨
    const workflow = new WorkflowManager()

    // å‡†å¤‡è¾“å…¥çŠ¶æ€
    const input = {
      messages: coreMessages,
    }

    // æ‰§è¡Œå·¥ä½œæµ
    const result = await workflow.execute(input)

    // è¿”å›å“åº”
    const lastMessage = result.messages[result.messages.length - 1]

    return new StreamingTextResponse(
      new ReadableStream({
        async start(controller) {
          try {
            if (lastMessage.content) {
              controller.enqueue(lastMessage.content)
            }
            controller.close()
          } catch (error) {
            controller.error(error)
          }
        },
      })
    )
  } catch (error) {
    console.error('Chat API Error:', error)
    return new Response('Internal Server Error', { status: 500 })
  }
}
```

### 9. åˆ›å»ºå¼€å‘å·¥å…·è„šæœ¬

åˆ›å»º`scripts/agent-dev.js`:

```javascript
const { spawn } = require('child_process')
const path = require('path')

// å¼€å‘æœåŠ¡å™¨
function startDevServer() {
  console.log('ğŸš€ Starting development server...')

  const server = spawn('npm', ['run', 'dev'], {
    stdio: 'inherit',
    shell: true,
  })

  server.on('close', (code) => {
    console.log(`Dev server exited with code ${code}`)
  })
}

// Agentæµ‹è¯•å·¥å…·
function testAgent() {
  console.log('ğŸ¤– Testing agent...')

  const test = spawn('npx', ['tsx', 'scripts/test-agent.ts'], {
    stdio: 'inherit',
    shell: true,
  })

  test.on('close', (code) => {
    console.log(`Agent test exited with code ${code}`)
  })
}

// ä¸»å‡½æ•°
function main() {
  const command = process.argv[2]

  switch (command) {
    case 'dev':
      startDevServer()
      break
    case 'test':
      testAgent()
      break
    default:
      console.log('Usage: npm run agent:dev|test')
      process.exit(1)
  }
}

main()
```

### 10. æ›´æ–°package.json

```json
{
  "scripts": {
    "agent:dev": "node scripts/agent-dev.js dev",
    "agent:test": "node scripts/agent-dev.js test",
    "type-check": "tsc --noEmit",
    "build": "next build",
    "dev": "next dev"
  }
}
```

## éªŒè¯æ¸…å•

- [ ] LangGraph.js v1ä¾èµ–å®‰è£…æˆåŠŸ
- [ ] ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ
- [ ] åŸºç¡€é…ç½®æ–‡ä»¶è®¾ç½®å®Œæˆ
- [ ] ç±»å‹å®šä¹‰æ­£ç¡®
- [ ] çŠ¶æ€ç®¡ç†å®ç°æ­£å¸¸
- [ ] å·¥ä½œæµåŸºç¡€æ¡†æ¶æ­å»ºå®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] å¼€å‘å·¥å…·è„šæœ¬å¯ç”¨
- [ ] TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] åŸºç¡€APIè·¯ç”±å¯è®¿é—®

## æµ‹è¯•å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
npm install

# ç±»å‹æ£€æŸ¥
npm run type-check

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run agent:dev

# æµ‹è¯•åŸºç¡€æ¡†æ¶
npm run agent:test

# æ„å»ºé¡¹ç›®
npm run build
```

## æ³¨æ„äº‹é¡¹

- ç¡®ä¿OpenAI APIå¯†é’¥æ­£ç¡®é…ç½®
- LangGraph.js v1çš„APIå¯èƒ½æœ‰æ‰€å˜åŒ–ï¼Œéœ€è¦å…³æ³¨å®˜æ–¹æ–‡æ¡£
- çŠ¶æ€ç®¡ç†éœ€è¦è€ƒè™‘å†…å­˜ä½¿ç”¨æƒ…å†µ
- é”™è¯¯å¤„ç†æœºåˆ¶éœ€è¦å®Œå–„
- å¼€å‘æ—¶æ³¨æ„è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—

## ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ä»»åŠ¡åï¼Œå°†è¿›è¡Œä»»åŠ¡024: AgentçŠ¶æ€å®šä¹‰å’Œç®¡ç†ï¼Œä¸ºåç»­çš„èŠ‚ç‚¹å®ç°å’Œå·¥å…·å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚