---
title: "TMS NL-Ops演示系统任务018: 在途跟踪界面实现"
epic: "tms-nlops-demo"
task: "018"
phase: "3"
status: "pending"
priority: "high"
estimated_hours: 16
parallel: false
depends_on: ["008", "009", "010", "011", "013"]
tags: ["ui", "tracking", "real-time", "maps"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
---

## 概述

实现TMS NL-Ops演示系统的在途跟踪界面，包括实时地图视图、车辆位置追踪、状态时间线等功能。为用户提供直观的货物运输实时监控体验。

## 目标

- 创建实时地图视图显示车辆位置和路线
- 实现车辆位置实时更新和轨迹回放
- 开发状态时间线显示运输进度
- 提供车辆详细信息监控
- 实现异常情况的告警和提醒
- 支持多车辆同时跟踪和管理

## 技术栈

- **框架**: Next.js 15+ App Router
- **语言**: TypeScript
- **样式**: Tailwind CSS + shadcn/ui v2
- **地图**: Leaflet + React-Leaflet
- **实时通信**: WebSocket / Server-Sent Events
- **图表**: Recharts
- **状态管理**: Zustand

## 实施步骤

### 1. 创建跟踪主界面组件

创建`src/components/tracking/tracking-dashboard.tsx`:

```typescript
'use client'

import { useState, useEffect, useMemo } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { VehicleTrackingMap } from './vehicle-tracking-map'
import { VehicleStatusList } from './vehicle-status-list'
import { TrackingTimeline } from './tracking-timeline'
import { AlertPanel } from './alert-panel'
import { VehicleTracking, TrackingAlert } from '@/types/tracking'

interface TrackingDashboardProps {
  vehicles: VehicleTracking[]
  alerts: TrackingAlert[]
  onVehicleSelect: (vehicleId: string) => void
  onAlertAcknowledge: (alertId: string) => Promise<void>
}

export function TrackingDashboard({
  vehicles,
  alerts,
  onVehicleSelect,
  onAlertAcknowledge,
}: TrackingDashboardProps) {
  const [selectedVehicleId, setSelectedVehicleId] = useState<string | null>(null)
  const [viewMode, setViewMode] = useState<'realtime' | 'replay'>('realtime')
  const [filterStatus, setFilterStatus] = useState<string>('all')
  const [showPaths, setShowPaths] = useState(true)

  // 筛选车辆
  const filteredVehicles = useMemo(() => {
    return vehicles.filter(vehicle => {
      if (filterStatus === 'all') return true
      return vehicle.status === filterStatus
    })
  }, [vehicles, filterStatus])

  // 选中的车辆
  const selectedVehicle = useMemo(() => {
    return vehicles.find(v => v.id === selectedVehicleId)
  }, [vehicles, selectedVehicleId])

  // 统计数据
  const stats = useMemo(() => {
    const total = vehicles.length
    const inTransit = vehicles.filter(v => v.status === 'IN_TRANSIT').length
    const stopped = vehicles.filter(v => v.status === 'STOPPED').length
    const offline = vehicles.filter(v => v.status === 'OFFLINE').length
    const alertsCount = alerts.filter(a => !a.acknowledged).length

    return {
      total,
      inTransit,
      stopped,
      offline,
      alertsCount,
    }
  }, [vehicles, alerts])

  // 处理车辆选择
  const handleVehicleSelect = (vehicleId: string) => {
    setSelectedVehicleId(vehicleId)
    onVehicleSelect(vehicleId)
  }

  return (
    <div className="space-y-6">
      {/* 页面标题和控制栏 */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">在途跟踪</h1>
          <p className="text-muted-foreground">实时监控货物运输状态</p>
        </div>

        <div className="flex space-x-4">
          <Select value={viewMode} onValueChange={(value: any) => setViewMode(value)}>
            <SelectTrigger className="w-[120px]">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="realtime">实时跟踪</SelectItem>
              <SelectItem value="replay">轨迹回放</SelectItem>
            </SelectContent>
          </Select>

          <Select value={filterStatus} onValueChange={setFilterStatus}>
            <SelectTrigger className="w-[120px]">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">所有状态</SelectItem>
              <SelectItem value="IN_TRANSIT">运输中</SelectItem>
              <SelectItem value="STOPPED">停车中</SelectItem>
              <SelectItem value="OFFLINE">离线</SelectItem>
            </SelectContent>
          </Select>

          <Button
            variant="outline"
            onClick={() => setShowPaths(!showPaths)}
          >
            {showPaths ? '隐藏路线' : '显示路线'}
          </Button>
        </div>
      </div>

      {/* 统计卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">总车辆数</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.total}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">运输中</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{stats.inTransit}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">停车中</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">{stats.stopped}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">离线</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{stats.offline}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">待处理告警</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{stats.alertsCount}</div>
          </CardContent>
        </Card>
      </div>

      {/* 主要内容区域 */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* 左侧：地图 */}
        <div className="lg:col-span-2">
          <Card className="h-[600px]">
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                实时地图
                <Badge variant={viewMode === 'realtime' ? 'default' : 'secondary'}>
                  {viewMode === 'realtime' ? '实时' : '回放'}
                </Badge>
              </CardTitle>
            </CardHeader>
            <CardContent className="h-[520px] p-0">
              <VehicleTrackingMap
                vehicles={filteredVehicles}
                selectedVehicleId={selectedVehicleId}
                showPaths={showPaths}
                onVehicleSelect={handleVehicleSelect}
                viewMode={viewMode}
              />
            </CardContent>
          </Card>
        </div>

        {/* 右侧：车辆列表和告警 */}
        <div className="space-y-6">
          <Tabs defaultValue="vehicles" className="w-full">
            <TabsList className="grid w-full grid-cols-2">
              <TabsTrigger value="vehicles">车辆列表</TabsTrigger>
              <TabsTrigger value="alerts">告警面板</TabsTrigger>
            </TabsList>

            <TabsContent value="vehicles">
              <VehicleStatusList
                vehicles={filteredVehicles}
                selectedVehicleId={selectedVehicleId}
                onVehicleSelect={handleVehicleSelect}
              />
            </TabsContent>

            <TabsContent value="alerts">
              <AlertPanel
                alerts={alerts}
                onAlertAcknowledge={onAlertAcknowledge}
              />
            </TabsContent>
          </Tabs>
        </div>
      </div>

      {/* 底部：选中车辆的详细信息 */}
      {selectedVehicle && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              车辆详情 - {selectedVehicle.licensePlate}
              <Button variant="ghost" size="sm" onClick={() => setSelectedVehicleId(null)}>
                关闭
              </Button>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <TrackingTimeline
              vehicle={selectedVehicle}
              viewMode={viewMode}
            />
          </CardContent>
        </Card>
      )}
    </div>
  )
}
```

### 2. 创建车辆跟踪地图组件

创建`src/components/tracking/vehicle-tracking-map.tsx`:

```typescript
'use client'

import { useState, useEffect, useRef } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { VehicleTracking } from '@/types/tracking'

interface VehicleTrackingMapProps {
  vehicles: VehicleTracking[]
  selectedVehicleId: string | null
  showPaths: boolean
  onVehicleSelect: (vehicleId: string) => void
  viewMode: 'realtime' | 'replay'
}

export function VehicleTrackingMap({
  vehicles,
  selectedVehicleId,
  showPaths,
  onVehicleSelect,
  viewMode,
}: VehicleTrackingMapProps) {
  const mapRef = useRef<HTMLDivElement>(null)
  const [map, setMap] = useState<any>(null)
  const [markers, setMarkers] = useState<any[]>([])
  const [replayTime, setReplayTime] = useState<number>(Date.now())

  // 初始化地图
  useEffect(() => {
    if (!mapRef.current) return

    // 模拟地图初始化
    const initMap = async () => {
      // 这里应该集成 Leaflet 或其他地图库
      // 为演示目的，我们显示一个占位符
    }

    initMap()
  }, [])

  // 更新车辆位置
  useEffect(() => {
    if (!map) return

    // 清除现有标记
    markers.forEach(marker => map.removeLayer(marker))
    setMarkers([])

    // 添加车辆标记
    vehicles.forEach(vehicle => {
      if (vehicle.location) {
        const marker = createVehicleMarker(vehicle)
        markers.push(marker)
        map.addLayer(marker)
      }
    })

    // 如果启用了路径显示，绘制路线
    if (showPaths) {
      vehicles.forEach(vehicle => {
        if (vehicle.path && vehicle.path.length > 1) {
          drawVehiclePath(vehicle)
        }
      })
    }
  }, [vehicles, map, showPaths, selectedVehicleId])

  // 实时更新（模拟）
  useEffect(() => {
    if (viewMode !== 'realtime') return

    const interval = setInterval(() => {
      // 模拟位置更新
      updateVehiclePositions()
    }, 5000)

    return () => clearInterval(interval)
  }, [viewMode])

  // 创建车辆标记
  const createVehicleMarker = (vehicle: VehicleTracking) => {
    // 这里应该创建实际的地图标记
    return {
      vehicle,
      remove: () => {},
      // 其他标记方法
    }
  }

  // 绘制车辆路径
  const drawVehiclePath = (vehicle: VehicleTracking) => {
    // 这里应该绘制实际的路径
  }

  // 更新车辆位置（模拟）
  const updateVehiclePositions = () => {
    // 模拟位置更新逻辑
  }

  // 处理地图点击
  const handleMapClick = (e: any) => {
    // 处理地图点击事件
  }

  // 获取车辆状态颜色
  const getVehicleColor = (status: string) => {
    switch (status) {
      case 'IN_TRANSIT': return '#10b981' // green
      case 'STOPPED': return '#f59e0b' // amber
      case 'OFFLINE': return '#6b7280' // gray
      default: return '#3b82f6' // blue
    }
  }

  return (
    <div className="relative h-full w-full bg-muted rounded-lg overflow-hidden">
      {/* 地图占位符 */}
      <div
        ref={mapRef}
        className="h-full w-full flex items-center justify-center"
        onClick={handleMapClick}
      >
        <div className="text-center">
          <div className="text-lg font-medium mb-2">实时地图视图</div>
          <div className="text-sm text-muted-foreground mb-4">
            显示 {vehicles.length} 辆车的实时位置
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-md mx-auto">
            {vehicles.slice(0, 8).map((vehicle) => (
              <VehicleMapCard
                key={vehicle.id}
                vehicle={vehicle}
                isSelected={vehicle.id === selectedVehicleId}
                onClick={() => onVehicleSelect(vehicle.id)}
              />
            ))}
          </div>
        </div>
      </div>

      {/* 地图控制按钮 */}
      <div className="absolute top-4 right-4 flex flex-col space-y-2">
        <Button variant="outline" size="sm">
          +
        </Button>
        <Button variant="outline" size="sm">
          -
        </Button>
        <Button variant="outline" size="sm">
          ⟲
        </Button>
      </div>

      {/* 图例 */}
      <div className="absolute bottom-4 left-4 bg-white p-3 rounded-lg shadow-md">
        <div className="text-sm font-medium mb-2">图例</div>
        <div className="space-y-1">
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
            <span className="text-xs">运输中</span>
          </div>
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
            <span className="text-xs">停车中</span>
          </div>
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 bg-gray-500 rounded-full"></div>
            <span className="text-xs">离线</span>
          </div>
        </div>
      </div>
    </div>
  )
}

// 车辆地图卡片组件
function VehicleMapCard({ vehicle, isSelected, onClick }: {
  vehicle: VehicleTracking
  isSelected: boolean
  onClick: () => void
}) {
  const getVehicleColor = (status: string) => {
    switch (status) {
      case 'IN_TRANSIT': return 'bg-green-500'
      case 'STOPPED': return 'bg-orange-500'
      case 'OFFLINE': return 'bg-gray-500'
      default: return 'bg-blue-500'
    }
  }

  return (
    <div
      className={`p-2 rounded border cursor-pointer transition-colors ${
        isSelected ? 'border-primary bg-primary/10' : 'border-border hover:border-primary/50'
      }`}
      onClick={onClick}
    >
      <div className="text-xs font-medium truncate">{vehicle.licensePlate}</div>
      <div className="flex items-center space-x-1 mt-1">
        <div className={`w-2 h-2 rounded-full ${getVehicleColor(vehicle.status)}`}></div>
        <div className="text-xs text-muted-foreground truncate">
          {vehicle.currentLocation?.address || '未知位置'}
        </div>
      </div>
      <div className="text-xs text-muted-foreground mt-1">
        {vehicle.speed ? `${vehicle.speed} km/h` : '静止'}
      </div>
    </div>
  )
}
```

### 3. 创建车辆状态列表组件

创建`src/components/tracking/vehicle-status-list.tsx`:

```typescript
'use client'

import { useMemo } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import { VehicleTracking } from '@/types/tracking'
import { format } from 'date-fns'
import { zhCN } from 'date-fns/locale'

interface VehicleStatusListProps {
  vehicles: VehicleTracking[]
  selectedVehicleId: string | null
  onVehicleSelect: (vehicleId: string) => void
}

export function VehicleStatusList({
  vehicles,
  selectedVehicleId,
  onVehicleSelect,
}: VehicleStatusListProps) {
  // 按状态分组车辆
  const groupedVehicles = useMemo(() => {
    return vehicles.reduce((acc, vehicle) => {
      if (!acc[vehicle.status]) {
        acc[vehicle.status] = []
      }
      acc[vehicle.status].push(vehicle)
      return acc
    }, {} as Record<string, VehicleTracking[]>)
  }, [vehicles])

  // 获取状态信息
  const getStatusInfo = (status: string) => {
    switch (status) {
      case 'IN_TRANSIT':
        return {
          label: '运输中',
          color: 'default',
          icon: '🚚',
        }
      case 'STOPPED':
        return {
          label: '停车中',
          color: 'secondary',
          icon: '🅿️',
        }
      case 'OFFLINE':
        return {
          label: '离线',
          color: 'outline',
          icon: '📴',
        }
      default:
        return {
          label: status,
          color: 'outline',
          icon: '❓',
        }
    }
  }

  return (
    <Card className="h-[500px]">
      <CardHeader>
        <CardTitle>车辆状态</CardTitle>
        <CardDescription>
          当前所有车辆的实时状态
        </CardDescription>
      </CardHeader>
      <CardContent className="p-0">
        <div className="h-[420px] overflow-y-auto">
          {Object.entries(groupedVehicles).map(([status, vehicleList]) => {
            const statusInfo = getStatusInfo(status)

            return (
              <div key={status} className="border-b last:border-b-0">
                <div className="sticky top-0 bg-background border-b px-4 py-2">
                  <div className="flex items-center space-x-2">
                    <span>{statusInfo.icon}</span>
                    <Badge variant={statusInfo.color as any}>
                      {statusInfo.label} ({vehicleList.length})
                    </Badge>
                  </div>
                </div>

                <div className="p-2 space-y-2">
                  {vehicleList.map((vehicle) => (
                    <VehicleStatusCard
                      key={vehicle.id}
                      vehicle={vehicle}
                      isSelected={vehicle.id === selectedVehicleId}
                      onClick={() => onVehicleSelect(vehicle.id)}
                    />
                  ))}
                </div>
              </div>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}

// 单个车辆状态卡片
function VehicleStatusCard({ vehicle, isSelected, onClick }: {
  vehicle: VehicleTracking
  isSelected: boolean
  onClick: () => void
}) {
  const getSpeedColor = (speed: number) => {
    if (speed === 0) return 'text-gray-500'
    if (speed < 30) return 'text-green-600'
    if (speed < 60) return 'text-orange-600'
    return 'text-red-600'
  }

  const getFuelColor = (fuelLevel: number) => {
    if (fuelLevel < 20) return 'text-red-600'
    if (fuelLevel < 50) return 'text-orange-600'
    return 'text-green-600'
  }

  return (
    <div
      className={`p-3 rounded-lg border cursor-pointer transition-colors ${
        isSelected ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50 hover:bg-muted/50'
      }`}
      onClick={onClick}
    >
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center space-x-2">
          <Avatar className="w-8 h-8">
            <AvatarFallback>{vehicle.licensePlate.slice(-2)}</AvatarFallback>
          </Avatar>
          <div>
            <div className="font-medium text-sm">{vehicle.licensePlate}</div>
            <div className="text-xs text-muted-foreground">{vehicle.driverName}</div>
          </div>
        </div>

        <div className="text-right">
          <div className={`text-sm font-medium ${getSpeedColor(vehicle.speed || 0)}`}>
            {vehicle.speed || 0} km/h
          </div>
          <div className="text-xs text-muted-foreground">
            {vehicle.fuelLevel !== undefined && (
              <span className={getFuelColor(vehicle.fuelLevel)}>
                油量: {vehicle.fuelLevel}%
              </span>
            )}
          </div>
        </div>
      </div>

      <div className="space-y-1 text-xs">
        <div className="flex items-center space-x-2">
          <span className="text-muted-foreground">位置:</span>
          <span className="truncate">{vehicle.currentLocation?.address || '位置未知'}</span>
        </div>

        {vehicle.destination && (
          <div className="flex items-center space-x-2">
            <span className="text-muted-foreground">目的地:</span>
            <span className="truncate">{vehicle.destination.address}</span>
          </div>
        )}

        {vehicle.eta && (
          <div className="flex items-center space-x-2">
            <span className="text-muted-foreground">预计到达:</span>
            <span>
              {format(new Date(vehicle.eta), 'MM-dd HH:mm', { locale: zhCN })}
            </span>
          </div>
        )}

        {vehicle.lastUpdate && (
          <div className="flex items-center space-x-2">
            <span className="text-muted-foreground">更新时间:</span>
            <span>
              {format(new Date(vehicle.lastUpdate), 'HH:mm:ss', { locale: zhCN })}
            </span>
          </div>
        )}
      </div>

      {/* 车辆状态指示器 */}
      <div className="flex items-center space-x-2 mt-2">
        <div className="flex items-center space-x-1">
          <div className={`w-2 h-2 rounded-full ${
            vehicle.status === 'IN_TRANSIT' ? 'bg-green-500' :
            vehicle.status === 'STOPPED' ? 'bg-orange-500' :
            vehicle.status === 'OFFLINE' ? 'bg-gray-500' : 'bg-blue-500'
          }`}></div>
          <span className="text-xs text-muted-foreground">
            {vehicle.status === 'IN_TRANSIT' ? '行驶中' :
             vehicle.status === 'STOPPED' ? '已停车' :
             vehicle.status === 'OFFLINE' ? '离线' : vehicle.status}
          </span>
        </div>

        {vehicle.alerts && vehicle.alerts.length > 0 && (
          <Badge variant="destructive" className="text-xs">
            {vehicle.alerts.length} 告警
          </Badge>
        )}
      </div>
    </div>
  )
}
```

### 4. 创建跟踪时间线组件

创建`src/components/tracking/tracking-timeline.tsx`:

```typescript
'use client'

import { useMemo } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { VehicleTracking } from '@/types/tracking'
import { format } from 'date-fns'
import { zhCN } from 'date-fns/locale'

interface TrackingTimelineProps {
  vehicle: VehicleTracking
  viewMode: 'realtime' | 'replay'
}

export function TrackingTimeline({ vehicle, viewMode }: TrackingTimelineProps) {
  // 生成时间线事件
  const timelineEvents = useMemo(() => {
    const events = []

    // 添加基本事件
    if (vehicle.assignmentTime) {
      events.push({
        id: 'assignment',
        type: 'assignment',
        time: vehicle.assignmentTime,
        title: '分配任务',
        description: `分配订单 ${vehicle.orderNumber}`,
        status: 'completed',
      })
    }

    if (vehicle.departureTime) {
      events.push({
        id: 'departure',
        type: 'departure',
        time: vehicle.departureTime,
        title: '出发',
        description: `从 ${vehicle.startLocation?.address || '仓库'} 出发`,
        status: 'completed',
      })
    }

    // 添加路径点事件
    if (vehicle.path && vehicle.path.length > 0) {
      vehicle.path.forEach((point, index) => {
        if (point.timestamp && index > 0 && index < vehicle.path!.length - 1) {
          events.push({
            id: `waypoint-${index}`,
            type: 'waypoint',
            time: point.timestamp,
            title: '途径点',
            description: `途径 ${point.address || '未知位置'}`,
            status: 'completed',
          })
        }
      })
    }

    // 添加预计到达事件
    if (vehicle.eta) {
      events.push({
        id: 'eta',
        type: 'eta',
        time: vehicle.eta,
        title: '预计到达',
        description: `预计到达 ${vehicle.destination?.address}`,
        status: 'pending',
      })
    }

    // 添加告警事件
    if (vehicle.alerts) {
      vehicle.alerts.forEach((alert, index) => {
        events.push({
          id: `alert-${index}`,
          type: 'alert',
          time: alert.timestamp,
          title: '告警',
          description: alert.message,
          status: alert.acknowledged ? 'resolved' : 'active',
        })
      })
    }

    // 按时间排序
    return events.sort((a, b) => new Date(a.time).getTime() - new Date(b.time).getTime())
  }, [vehicle])

  // 获取事件类型图标
  const getEventIcon = (type: string) => {
    switch (type) {
      case 'assignment': return '📋'
      case 'departure': return '🚚'
      case 'waypoint': return '📍'
      case 'eta': return '⏰'
      case 'alert': return '⚠️'
      default: return '📌'
    }
  }

  // 获取事件状态样式
  const getEventStatusStyle = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800 border-green-200'
      case 'pending': return 'bg-blue-100 text-blue-800 border-blue-200'
      case 'active': return 'bg-red-100 text-red-800 border-red-200'
      case 'resolved': return 'bg-gray-100 text-gray-800 border-gray-200'
      default: return 'bg-gray-100 text-gray-800 border-gray-200'
    }
  }

  // 获取事件状态文本
  const getEventStatusText = (status: string) => {
    switch (status) {
      case 'completed': return '已完成'
      case 'pending': return '待处理'
      case 'active': return '进行中'
      case 'resolved': return '已解决'
      default: return status
    }
  }

  return (
    <Tabs defaultValue="timeline" className="w-full">
      <TabsList className="grid w-full grid-cols-3">
        <TabsTrigger value="timeline">时间线</TabsTrigger>
        <TabsTrigger value="details">详细信息</TabsTrigger>
        <TabsTrigger value="analytics">数据分析</TabsTrigger>
      </TabsList>

      <TabsContent value="timeline">
        <div className="space-y-4">
          {timelineEvents.map((event, index) => (
            <TimelineEvent
              key={event.id}
              event={event}
              isLast={index === timelineEvents.length - 1}
            />
          ))}
        </div>
      </TabsContent>

      <TabsContent value="details">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <DetailSection
            title="行程信息"
            data={[
              { label: '总距离', value: `${vehicle.totalDistance?.toFixed(1) || 0} km` },
              { label: '已行驶距离', value: `${vehicle.traveledDistance?.toFixed(1) || 0} km` },
              { label: '剩余距离', value: `${vehicle.remainingDistance?.toFixed(1) || 0} km` },
              { label: '预计总时间', value: `${vehicle.estimatedDuration || 0} 分钟` },
              { label: '已用时间', value: `${vehicle.elapsedTime || 0} 分钟` },
            ]}
          />

          <DetailSection
            title="车辆状态"
            data={[
              { label: '当前速度', value: `${vehicle.speed || 0} km/h` },
              { label: '平均速度', value: `${vehicle.averageSpeed || 0} km/h` },
              { label: '最高速度', value: `${vehicle.maxSpeed || 0} km/h` },
              { label: '燃油水平', value: `${vehicle.fuelLevel || 0}%` },
              { label: '发动机状态', value: vehicle.engineStatus || '未知' },
            ]}
          />
        </div>
      </TabsContent>

      <TabsContent value="analytics">
        <div className="space-y-4">
          <AnalyticsCard
            title="行驶效率"
            metrics={[
              { label: '平均速度', value: `${vehicle.averageSpeed || 0} km/h`, trend: 'up' },
              { label: '燃油效率', value: `${vehicle.fuelEfficiency || 0} L/100km`, trend: 'down' },
              { label: '准时率', value: `${vehicle.onTimeRate || 0}%`, trend: 'up' },
            ]}
          />

          <AnalyticsCard
            title="安全指标"
            metrics={[
              { label: '急加速次数', value: vehicle.hardAccelerations || 0, trend: 'down' },
              { label: '急刹车次数', value: vehicle.hardBrakings || 0, trend: 'down' },
              { label: '超速次数', value: vehicle.speedingEvents || 0, trend: 'down' },
            ]}
          />
        </div>
      </TabsContent>
    </Tabs>
  )
}

// 时间线事件组件
function TimelineEvent({ event, isLast }: { event: any, isLast: boolean }) {
  const getEventIcon = (type: string) => {
    switch (type) {
      case 'assignment': return '📋'
      case 'departure': return '🚚'
      case 'waypoint': return '📍'
      case 'eta': return '⏰'
      case 'alert': return '⚠️'
      default: return '📌'
    }
  }

  const getEventStatusStyle = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800 border-green-200'
      case 'pending': return 'bg-blue-100 text-blue-800 border-blue-200'
      case 'active': return 'bg-red-100 text-red-800 border-red-200'
      case 'resolved': return 'bg-gray-100 text-gray-800 border-gray-200'
      default: return 'bg-gray-100 text-gray-800 border-gray-200'
    }
  }

  return (
    <div className="flex space-x-4">
      <div className="flex flex-col items-center">
        <div className="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-lg">
          {getEventIcon(event.type)}
        </div>
        {!isLast && <div className="w-0.5 h-16 bg-border mt-2"></div>}
      </div>

      <div className="flex-1 min-w-0">
        <div className="flex items-center space-x-2 mb-1">
          <h3 className="font-medium">{event.title}</h3>
          <Badge variant="outline" className={getEventStatusStyle(event.status)}>
            {getEventStatusText(event.status)}
          </Badge>
        </div>
        <p className="text-sm text-muted-foreground mb-1">{event.description}</p>
        <p className="text-xs text-muted-foreground">
          {format(new Date(event.time), 'yyyy-MM-dd HH:mm:ss', { locale: zhCN })}
        </p>
      </div>
    </div>
  )
}

// 详情段落组件
function DetailSection({ title, data }: { title: string, data: Array<{ label: string, value: string }> }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">{title}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {data.map((item, index) => (
            <div key={index} className="flex justify-between">
              <span className="text-sm text-muted-foreground">{item.label}</span>
              <span className="text-sm font-medium">{item.value}</span>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}

// 分析卡片组件
function AnalyticsCard({ title, metrics }: { title: string, metrics: Array<{ label: string, value: string, trend: string }> }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">{title}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-3 gap-4">
          {metrics.map((metric, index) => (
            <div key={index} className="text-center">
              <div className="text-2xl font-bold">{metric.value}</div>
              <div className="text-sm text-muted-foreground">{metric.label}</div>
              <div className={`text-xs ${
                metric.trend === 'up' ? 'text-green-600' : 'text-red-600'
              }`}>
                {metric.trend === 'up' ? '↑' : '↓'}
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

### 5. 创建告警面板组件

创建`src/components/tracking/alert-panel.tsx`:

```typescript
'use client'

import { useMemo } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { TrackingAlert } from '@/types/tracking'
import { format } from 'date-fns'
import { zhCN } from 'date-fns/locale'

interface AlertPanelProps {
  alerts: TrackingAlert[]
  onAlertAcknowledge: (alertId: string) => Promise<void>
}

export function AlertPanel({ alerts, onAlertAcknowledge }: AlertPanelProps) {
  // 按严重程度和状态排序告警
  const sortedAlerts = useMemo(() => {
    return [...alerts].sort((a, b) => {
      // 未确认的告警优先
      if (a.acknowledged !== b.acknowledged) {
        return a.acknowledged ? 1 : -1
      }
      // 按严重程度排序
      const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 }
      return severityOrder[a.severity] - severityOrder[b.severity]
    })
  }, [alerts])

  // 按状态分组
  const activeAlerts = sortedAlerts.filter(alert => !alert.acknowledged)
  const acknowledgedAlerts = sortedAlerts.filter(alert => alert.acknowledged)

  // 获取严重程度样式
  const getSeverityStyle = (severity: string) => {
    switch (severity) {
      case 'critical':
        return {
          color: 'destructive',
          text: '严重',
          bg: 'bg-red-50 border-red-200'
        }
      case 'high':
        return {
          color: 'destructive',
          text: '高',
          bg: 'bg-orange-50 border-orange-200'
        }
      case 'medium':
        return {
          color: 'secondary',
          text: '中',
          bg: 'bg-yellow-50 border-yellow-200'
        }
      case 'low':
        return {
          color: 'outline',
          text: '低',
          bg: 'bg-gray-50 border-gray-200'
        }
      default:
        return {
          color: 'outline',
          text: severity,
          bg: 'bg-gray-50 border-gray-200'
        }
    }
  }

  return (
    <Card className="h-[500px]">
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          告警面板
          <Badge variant={activeAlerts.length > 0 ? 'destructive' : 'secondary'}>
            {activeAlerts.length} 个待处理
          </Badge>
        </CardTitle>
        <CardDescription>
          系统监控告警和异常事件
        </CardDescription>
      </CardHeader>
      <CardContent className="p-0">
        <div className="h-[420px] overflow-y-auto">
          {/* 未确认告警 */}
          {activeAlerts.length > 0 && (
            <div className="border-b last:border-b-0">
              <div className="sticky top-0 bg-background border-b px-4 py-2">
                <h3 className="font-medium text-red-600">待处理告警</h3>
              </div>
              <div className="p-2 space-y-2">
                {activeAlerts.map((alert) => (
                  <AlertCard
                    key={alert.id}
                    alert={alert}
                    onAcknowledge={onAlertAcknowledge}
                  />
                ))}
              </div>
            </div>
          )}

          {/* 已确认告警 */}
          {acknowledgedAlerts.length > 0 && (
            <div>
              <div className="sticky top-0 bg-background border-b px-4 py-2">
                <h3 className="font-medium text-gray-600">已处理告警</h3>
              </div>
              <div className="p-2 space-y-2">
                {acknowledgedAlerts.map((alert) => (
                  <AlertCard
                    key={alert.id}
                    alert={alert}
                    onAcknowledge={onAlertAcknowledge}
                  />
                ))}
              </div>
            </div>
          )}

          {/* 无告警 */}
          {sortedAlerts.length === 0 && (
            <div className="h-full flex items-center justify-center">
              <div className="text-center text-muted-foreground">
                <div className="text-lg mb-2">✅ 暂无告警</div>
                <div className="text-sm">系统运行正常</div>
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}

// 告警卡片组件
function AlertCard({ alert, onAcknowledge }: {
  alert: TrackingAlert
  onAcknowledge: (alertId: string) => Promise<void>
}) {
  const [isAcknowledging, setIsAcknowledging] = useState(false)

  const getSeverityStyle = (severity: string) => {
    switch (severity) {
      case 'critical':
        return {
          color: 'destructive',
          text: '严重',
          bg: 'bg-red-50 border-red-200'
        }
      case 'high':
        return {
          color: 'destructive',
          text: '高',
          bg: 'bg-orange-50 border-orange-200'
        }
      case 'medium':
        return {
          color: 'secondary',
          text: '中',
          bg: 'bg-yellow-50 border-yellow-200'
        }
      case 'low':
        return {
          color: 'outline',
          text: '低',
          bg: 'bg-gray-50 border-gray-200'
        }
      default:
        return {
          color: 'outline',
          text: severity,
          bg: 'bg-gray-50 border-gray-200'
        }
    }
  }

  const handleAcknowledge = async () => {
    setIsAcknowledging(true)
    try {
      await onAcknowledge(alert.id)
    } catch (error) {
      console.error('确认告警失败:', error)
    } finally {
      setIsAcknowledging(false)
    }
  }

  const severityStyle = getSeverityStyle(alert.severity)

  return (
    <div className={`p-3 rounded-lg border ${severityStyle.bg} ${
      alert.acknowledged ? 'opacity-60' : ''
    }`}>
      <div className="flex items-start justify-between mb-2">
        <div className="flex items-center space-x-2">
          <Badge variant={severityStyle.color as any}>
            {severityStyle.text}
          </Badge>
          <span className="text-sm font-medium">{alert.type}</span>
        </div>

        <div className="flex items-center space-x-2">
          <span className="text-xs text-muted-foreground">
            {format(new Date(alert.timestamp), 'HH:mm', { locale: zhCN })}
          </span>
          {!alert.acknowledged && (
            <Button
              variant="outline"
              size="sm"
              onClick={handleAcknowledge}
              disabled={isAcknowledging}
            >
              {isAcknowledging ? '处理中...' : '确认'}
            </Button>
          )}
        </div>
      </div>

      <div className="space-y-2">
        <p className="text-sm">{alert.message}</p>

        {alert.vehicleId && (
          <div className="text-xs text-muted-foreground">
            车辆: {alert.vehicleId}
          </div>
        )}

        {alert.location && (
          <div className="text-xs text-muted-foreground">
            位置: {alert.location.address || '未知位置'}
          </div>
        )}

        {alert.acknowledged && alert.acknowledgedAt && (
          <div className="text-xs text-green-600">
            已处理于 {format(new Date(alert.acknowledgedAt), 'yyyy-MM-dd HH:mm:ss', { locale: zhCN })}
          </div>
        )}
      </div>
    </div>
  )
}
```

### 6. 创建类型定义

创建`src/types/tracking.ts`:

```typescript
export interface VehicleTracking {
  id: string
  licensePlate: string
  driverName: string
  driverId: string
  orderNumber: string
  status: 'IN_TRANSIT' | 'STOPPED' | 'OFFLINE'
  location: {
    lat: number
    lng: number
    address: string
  }
  currentLocation?: {
    lat: number
    lng: number
    address: string
  }
  destination?: {
    lat: number
    lng: number
    address: string
  }
  startLocation?: {
    lat: number
    lng: number
    address: string
  }
  speed: number
  heading: number
  fuelLevel?: number
  engineStatus?: string
  totalDistance?: number
  traveledDistance?: number
  remainingDistance?: number
  estimatedDuration?: number
  elapsedTime?: number
  averageSpeed?: number
  maxSpeed?: number
  fuelEfficiency?: number
  onTimeRate?: number
  hardAccelerations?: number
  hardBrakings?: number
  speedingEvents?: number
  assignmentTime?: string
  departureTime?: string
  eta?: string
  lastUpdate: string
  path?: Array<{
    lat: number
    lng: number
    address?: string
    timestamp?: string
  }>
  alerts?: TrackingAlert[]
}

export interface TrackingAlert {
  id: string
  vehicleId?: string
  type: string
  severity: 'critical' | 'high' | 'medium' | 'low'
  message: string
  timestamp: string
  acknowledged: boolean
  acknowledgedAt?: string
  acknowledgedBy?: string
  location?: {
    lat: number
    lng: number
    address: string
  }
  metadata?: Record<string, any>
}

export type AlertType =
  | 'speeding'
  | 'hard_braking'
  | 'hard_acceleration'
  | 'fuel_low'
  | 'engine_warning'
  | 'route_deviation'
  | 'delay_warning'
  | 'geofence_violation'
  | 'connection_lost'
  | 'emergency'
```

### 7. 创建跟踪页面

创建`src/app/tracking/page.tsx`:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { TrackingDashboard } from '@/components/tracking/tracking-dashboard'
import { VehicleTracking, TrackingAlert } from '@/types/tracking'

// 模拟数据
const mockVehicles: VehicleTracking[] = [
  {
    id: '1',
    licensePlate: '京A12345',
    driverName: '张司机',
    driverId: '1',
    orderNumber: 'ORD-2024-0001',
    status: 'IN_TRANSIT',
    location: {
      lat: 39.9042,
      lng: 116.4074,
      address: '北京市朝阳区建国路'
    },
    currentLocation: {
      lat: 39.9042,
      lng: 116.4074,
      address: '北京市朝阳区建国路'
    },
    destination: {
      lat: 31.2304,
      lng: 121.4737,
      address: '上海市浦东新区世纪大道100号'
    },
    speed: 65,
    heading: 120,
    fuelLevel: 75,
    engineStatus: 'normal',
    totalDistance: 1200,
    traveledDistance: 300,
    remainingDistance: 900,
    estimatedDuration: 720,
    elapsedTime: 180,
    averageSpeed: 60,
    maxSpeed: 85,
    fuelEfficiency: 8.5,
    onTimeRate: 95,
    hardAccelerations: 2,
    hardBrakings: 1,
    speedingEvents: 1,
    assignmentTime: '2024-01-15T08:00:00Z',
    departureTime: '2024-01-15T09:00:00Z',
    eta: '2024-01-15T18:00:00Z',
    lastUpdate: '2024-01-15T12:30:00Z',
  },
  {
    id: '2',
    licensePlate: '沪B67890',
    driverName: '李司机',
    driverId: '2',
    orderNumber: 'ORD-2024-0002',
    status: 'STOPPED',
    location: {
      lat: 23.1291,
      lng: 113.2644,
      address: '广州市天河区天河路'
    },
    currentLocation: {
      lat: 23.1291,
      lng: 113.2644,
      address: '广州市天河区天河路'
    },
    destination: {
      lat: 22.5431,
      lng: 114.0579,
      address: '深圳市南山区科技园路'
    },
    speed: 0,
    heading: 0,
    fuelLevel: 45,
    engineStatus: 'off',
    totalDistance: 150,
    traveledDistance: 80,
    remainingDistance: 70,
    estimatedDuration: 120,
    elapsedTime: 90,
    averageSpeed: 45,
    maxSpeed: 60,
    fuelEfficiency: 9.2,
    onTimeRate: 100,
    hardAccelerations: 0,
    hardBrakings: 0,
    speedingEvents: 0,
    assignmentTime: '2024-01-15T10:00:00Z',
    departureTime: '2024-01-15T10:30:00Z',
    eta: '2024-01-15T12:30:00Z',
    lastUpdate: '2024-01-15T12:00:00Z',
  },
]

const mockAlerts: TrackingAlert[] = [
  {
    id: '1',
    vehicleId: '1',
    type: 'speeding',
    severity: 'medium',
    message: '车辆超速行驶：85km/h（限速80km/h）',
    timestamp: '2024-01-15T12:25:00Z',
    acknowledged: false,
    location: {
      lat: 39.9042,
      lng: 116.4074,
      address: '北京市朝阳区建国路'
    }
  },
  {
    id: '2',
    vehicleId: '2',
    type: 'fuel_low',
    severity: 'high',
    message: '燃油水平偏低：45%，建议及时加油',
    timestamp: '2024-01-15T11:45:00Z',
    acknowledged: true,
    acknowledgedAt: '2024-01-15T11:50:00Z',
    location: {
      lat: 23.1291,
      lng: 113.2644,
      address: '广州市天河区天河路'
    }
  },
]

export default function TrackingPage() {
  const [vehicles, setVehicles] = useState<VehicleTracking[]>(mockVehicles)
  const [alerts, setAlerts] = useState<TrackingAlert[]>(mockAlerts)
  const [selectedVehicleId, setSelectedVehicleId] = useState<string | null>(null)

  // 模拟实时数据更新
  useEffect(() => {
    const interval = setInterval(() => {
      setVehicles(prevVehicles =>
        prevVehicles.map(vehicle => ({
          ...vehicle,
          speed: vehicle.status === 'IN_TRANSIT' ?
            Math.max(0, vehicle.speed + (Math.random() - 0.5) * 10) : 0,
          lastUpdate: new Date().toISOString(),
          traveledDistance: vehicle.status === 'IN_TRANSIT' ?
            vehicle.traveledDistance! + (vehicle.speed / 3600) * 5 : vehicle.traveledDistance,
          remainingDistance: vehicle.status === 'IN_TRANSIT' ?
            Math.max(0, vehicle.remainingDistance! - (vehicle.speed / 3600) * 5) : vehicle.remainingDistance,
        }))
      )
    }, 5000)

    return () => clearInterval(interval)
  }, [])

  // 处理车辆选择
  const handleVehicleSelect = (vehicleId: string) => {
    setSelectedVehicleId(vehicleId)
  }

  // 处理告警确认
  const handleAlertAcknowledge = async (alertId: string) => {
    try {
      // 模拟API调用
      await new Promise(resolve => setTimeout(resolve, 500))

      setAlerts(prevAlerts =>
        prevAlerts.map(alert =>
          alert.id === alertId
            ? {
                ...alert,
                acknowledged: true,
                acknowledgedAt: new Date().toISOString(),
                acknowledgedBy: 'system',
              }
            : alert
        )
      )
    } catch (error) {
      console.error('确认告警失败:', error)
    }
  }

  return (
    <div className="container mx-auto py-8">
      <TrackingDashboard
        vehicles={vehicles}
        alerts={alerts}
        onVehicleSelect={handleVehicleSelect}
        onAlertAcknowledge={handleAlertAcknowledge}
      />
    </div>
  )
}
```

## 验证清单

- [ ] 跟踪主界面布局正确
- [ ] 车辆位置实时更新正常
- [ ] 地图视图显示正确
- [ ] 状态时间线完整
- [ ] 告警面板功能正常
- [ ] 车辆详情显示完整
- [ ] 实时数据更新流畅
- [ ] 响应式设计良好

## 测试命令

```bash
# 启动开发服务器
npm run dev

# 运行类型检查
npm run type-check

# 运行测试
npm test

# 检查构建
npm run build
```

## 注意事项

- 确保地图集成正确且性能优化
- 实现实时数据通信机制
- 优化大量车辆标记的渲染性能
- 添加适当的错误处理和重连机制
- 考虑添加离线数据缓存
- 确保移动端地图操作体验良好