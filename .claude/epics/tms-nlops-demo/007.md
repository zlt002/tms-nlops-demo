---
title: "TMS NL-Ops演示系统任务007: 基础API路由结构搭建"
epic: "tms-nlops-demo"
task: "007"
phase: "1"
status: completed
priority: "high"
estimated_hours: 3
parallel: true
depends_on: ["003", "004", "005"]
tags: ["api", "routes", "backend", "infrastructure"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
```

## 概述

搭建TMS NL-Ops演示系统的基础API路由结构，包括认证、订单管理、车辆管理、实时跟踪、回单管理和NL-Ops功能的核心API端点。

## 目标

- 创建RESTful API路由结构
- 实现基础的CRUD操作
- 建立API响应格式标准
- 实现错误处理机制
- 集成数据库访问层

## API路由结构

```
src/app/api/
├── auth/           # 认证相关API
│   ├── login/      # 登录
│   ├── logout/     # 登出
│   └── profile/    # 用户信息
├── orders/         # 订单管理API
│   └── [id]/       # 订单详情
├── vehicles/       # 车辆管理API
│   └── [id]/       # 车辆详情
├── tracking/       # 实时跟踪API
│   └── [id]/       # 跟踪记录
├── receipts/       # 回单管理API
│   └── [id]/       # 回单详情
├── nlops/          # NL-Ops相关API
│   ├── command/    # 自然语言命令
│   ├── history/    # 命令历史
│   └── intents/    # 意图定义
└── health/         # 健康检查
```

## 实施步骤

### 1. 创建API响应工具

创建`src/lib/api/response.ts`:

```typescript
import { NextResponse } from 'next/server'

export interface ApiResponse<T = any> {
  success: boolean
  data?: T
  error?: string
  message?: string
  metadata?: {
    timestamp: string
    requestId: string
  }
}

export class ApiResponseBuilder {
  static success<T>(data: T, message?: string, status: number = 200): NextResponse {
    const response: ApiResponse<T> = {
      success: true,
      data,
      message,
      metadata: {
        timestamp: new Date().toISOString(),
        requestId: this.generateRequestId()
      }
    }
    return NextResponse.json(response, { status })
  }

  static error(
    error: string,
    status: number = 500,
    details?: any
  ): NextResponse {
    const response: ApiResponse = {
      success: false,
      error,
      metadata: {
        timestamp: new Date().toISOString(),
        requestId: this.generateRequestId()
      }
    }
    return NextResponse.json(response, { status })
  }

  static paginated<T>(
    data: T[],
    pagination: {
      page: number
      limit: number
      total: number
      pages: number
    },
    message?: string
  ): NextResponse {
    const response: ApiResponse<T[]> = {
      success: true,
      data,
      message,
      metadata: {
        timestamp: new Date().toISOString(),
        requestId: this.generateRequestId()
      }
    }
    return NextResponse.json({
      ...response,
      pagination
    })
  }

  private static generateRequestId(): string {
    return Math.random().toString(36).substr(2, 9)
  }
}

export function withErrorHandler(handler: Function) {
  return async (...args: any[]) => {
    try {
      return await handler(...args)
    } catch (error) {
      console.error('API Error:', error)

      if (error instanceof Error) {
        return ApiResponseBuilder.error(error.message, 500)
      }

      return ApiResponseBuilder.error('Internal server error', 500)
    }
  }
}
```

### 2. 创建认证API

创建`src/app/api/auth/login/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/db/prisma'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

const loginSchema = z.object({
  email: z.string().email('邮箱格式不正确'),
  password: z.string().min(6, '密码至少6位')
})

export const POST = withErrorHandler(async (request: NextRequest) => {
  const body = await request.json()

  // 验证输入
  const validatedData = loginSchema.parse(body)

  // 查找用户
  const user = await prisma.user.findUnique({
    where: { email: validatedData.email },
    select: {
      id: true,
      email: true,
      name: true,
      role: true,
      avatar: true,
      createdAt: true
    }
  })

  if (!user) {
    return ApiResponseBuilder.error('用户不存在', 401)
  }

  // 生成token（实际项目中应该使用JWT）
  const token = `token-${user.id}-${Date.now()}`

  // 返回用户信息和token
  return ApiResponseBuilder.success({
    user,
    token
  }, '登录成功')
})
```

创建`src/app/api/auth/profile/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

export const GET = withErrorHandler(async (request: NextRequest) => {
  // 从请求头获取token
  const authHeader = request.headers.get('authorization')

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return ApiResponseBuilder.error('未授权', 401)
  }

  const token = authHeader.substring(7)

  // 解析token获取用户信息（简化版）
  const userId = token.split('-')[1]

  if (!userId) {
    return ApiResponseBuilder.error('无效的token', 401)
  }

  // 返回模拟的用户信息
  return ApiResponseBuilder.success({
    id: userId,
    email: 'user@example.com',
    name: '演示用户',
    role: 'USER'
  })
})
```

### 3. 创建订单管理API

创建`src/app/api/orders/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/db/prisma'
import { OrderQueries } from '@/lib/db/queries'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'
import { createOrderSchema } from '@/lib/validators'

export const GET = withErrorHandler(async (request: NextRequest) => {
  const { searchParams } = new URL(request.url)

  const filters = {
    status: searchParams.get('status') as any,
    customerId: searchParams.get('customerId') || undefined,
    page: parseInt(searchParams.get('page') || '1'),
    limit: parseInt(searchParams.get('limit') || '20')
  }

  const result = await OrderQueries.findAll(filters)

  return ApiResponseBuilder.paginated(
    result.orders,
    result.pagination,
    '获取订单列表成功'
  )
})

export const POST = withErrorHandler(async (request: NextRequest) => {
  const body = await request.json()

  // 验证输入
  const validatedData = createOrderSchema.parse(body)

  // 生成订单号
  const orderNumber = `ORD-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`

  // 创建订单
  const order = await prisma.order.create({
    data: {
      ...validatedData,
      orderNumber
    },
    include: {
      customer: true,
      assignedVehicle: {
        include: {
          driver: true
        }
      }
    }
  })

  return ApiResponseBuilder.success(order, '订单创建成功', 201)
})
```

创建`src/app/api/orders/[id]/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/db/prisma'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

const updateOrderSchema = z.object({
  status: z.enum(['PENDING', 'CONFIRMED', 'IN_TRANSIT', 'DELIVERED', 'CANCELLED']).optional(),
  weight: z.number().positive().optional(),
  pickupTime: z.date().optional(),
  deliveryTime: z.date().optional(),
  specialInstructions: z.string().optional()
})

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  return withErrorHandler(async () => {
    const order = await prisma.order.findUnique({
      where: { id: params.id },
      include: {
        customer: true,
        assignedVehicle: {
          include: {
            driver: true
          }
        },
        schedules: {
          include: {
            vehicle: {
              include: {
                driver: true
              }
            }
          }
        },
        trackings: {
          orderBy: {
            timestamp: 'desc'
          }
        },
        receipts: true
      }
    })

    if (!order) {
      return ApiResponseBuilder.error('订单不存在', 404)
    }

    return ApiResponseBuilder.success(order)
  })()
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  return withErrorHandler(async () => {
    const body = await request.json()
    const validatedData = updateOrderSchema.parse(body)

    const order = await prisma.order.update({
      where: { id: params.id },
      data: validatedData,
      include: {
        customer: true,
        assignedVehicle: {
          include: {
            driver: true
          }
        }
      }
    })

    return ApiResponseBuilder.success(order, '订单更新成功')
  })()
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  return withErrorHandler(async () => {
    await prisma.order.delete({
      where: { id: params.id }
    })

    return ApiResponseBuilder.success(null, '订单删除成功')
  })()
}
```

### 4. 创建车辆管理API

创建`src/app/api/vehicles/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/db/prisma'
import { VehicleQueries } from '@/lib/db/queries'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

const createVehicleSchema = z.object({
  licensePlate: z.string().min(1, '车牌号不能为空'),
  type: z.enum(['TRUCK', 'VAN', 'TRAILER']),
  capacity: z.number().positive('载重量必须大于0'),
  driverId: z.string().uuid('无效的驾驶员ID')
})

export const GET = withErrorHandler(async (request: NextRequest) => {
  const { searchParams } = new URL(request.url)

  const filters = {
    type: searchParams.get('type'),
    status: searchParams.get('status'),
    page: parseInt(searchParams.get('page') || '1'),
    limit: parseInt(searchParams.get('limit') || '20')
  }

  const vehicles = await prisma.vehicle.findMany({
    where: {
      ...(filters.type && { type: filters.type as any }),
      ...(filters.status && { status: filters.status as any })
    },
    include: {
      driver: true,
      schedules: true
    },
    skip: (filters.page - 1) * filters.limit,
    take: filters.limit,
    orderBy: {
      createdAt: 'desc'
    }
  })

  const total = await prisma.vehicle.count({
    where: {
      ...(filters.type && { type: filters.type as any }),
      ...(filters.status && { status: filters.status as any })
    }
  })

  return ApiResponseBuilder.paginated(
    vehicles,
    {
      page: filters.page,
      limit: filters.limit,
      total,
      pages: Math.ceil(total / filters.limit)
    },
    '获取车辆列表成功'
  )
})

export const POST = withErrorHandler(async (request: NextRequest) => {
  const body = await request.json()
  const validatedData = createVehicleSchema.parse(body)

  const vehicle = await prisma.vehicle.create({
    data: validatedData,
    include: {
      driver: true
    }
  })

  return ApiResponseBuilder.success(vehicle, '车辆创建成功', 201)
})
```

### 5. 创建NL-Ops API

创建`src/app/api/nlops/command/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/db/prisma'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

const commandSchema = z.object({
  command: z.string().min(1, '命令不能为空'),
  userId: z.string().uuid().optional()
})

// 简化的意图识别（实际项目中应该使用AI服务）
function identifyIntent(command: string) {
  const lowerCommand = command.toLowerCase()

  if (lowerCommand.includes('创建') || lowerCommand.includes('新增') || lowerCommand.includes('添加')) {
    return {
      intent: 'create_order',
      confidence: 0.8,
      parameters: {}
    }
  }

  if (lowerCommand.includes('查询') || lowerCommand.includes('查看') || lowerCommand.includes('状态')) {
    return {
      intent: 'track_order',
      confidence: 0.8,
      parameters: {}
    }
  }

  if (lowerCommand.includes('分配') || lowerCommand.includes('安排') || lowerCommand.includes('调度')) {
    return {
      intent: 'assign_vehicle',
      confidence: 0.8,
      parameters: {}
    }
  }

  return {
    intent: 'unknown',
    confidence: 0.3,
    parameters: {}
  }
}

export const POST = withErrorHandler(async (request: NextRequest) => {
  const body = await request.json()
  const validatedData = commandSchema.parse(body)

  // 意图识别
  const intentResult = identifyIntent(validatedData.command)

  // 创建命令记录
  const nlCommand = await prisma.nLCommand.create({
    data: {
      command: validatedData.command,
      intent: intentResult.intent,
      parameters: intentResult.parameters,
      confidence: intentResult.confidence,
      userId: validatedData.userId
    }
  })

  // 执行命令（简化版）
  let result = null
  let error = null

  try {
    // 这里应该根据不同的intent执行不同的业务逻辑
    result = {
      action: intentResult.intent,
      message: '命令已接收，正在处理中...'
    }

    // 更新命令状态
    await prisma.nLCommand.update({
      where: { id: nlCommand.id },
      data: {
        status: 'COMPLETED',
        executed: true,
        result,
        executedAt: new Date()
      }
    })
  } catch (err) {
    error = err instanceof Error ? err.message : 'Unknown error'

    await prisma.nLCommand.update({
      where: { id: nlCommand.id },
      data: {
        status: 'FAILED',
        error
      }
    })
  }

  return ApiResponseBuilder.success({
    command: nlCommand,
    result,
    error
  }, '命令处理完成')
})
```

创建`src/app/api/nlops/history/route.ts`:

```typescript
import { NextRequest } from 'next/server'
import { prisma } from '@/lib/db/prisma'
import { ApiResponseBuilder, withErrorHandler } from '@/lib/api/response'

export const GET = withErrorHandler(async (request: NextRequest) => {
  const { searchParams } = new URL(request.url)

  const filters = {
    userId: searchParams.get('userId') || undefined,
    intent: searchParams.get('intent') || undefined,
    limit: parseInt(searchParams.get('limit') || '50')
  }

  const commands = await prisma.nLCommand.findMany({
    where: {
      ...(filters.userId && { userId: filters.userId }),
      ...(filters.intent && { intent: filters.intent })
    },
    include: {
      user: true,
      order: true
    },
    orderBy: {
      createdAt: 'desc'
    },
    take: filters.limit
  })

  return ApiResponseBuilder.success(commands, '获取命令历史成功')
})
```

### 6. 创建健康检查API

创建`src/app/api/health/route.ts`:

```typescript
import { prisma } from '@/lib/db/prisma'
import { ApiResponseBuilder } from '@/lib/api/response'

export async function GET() {
  try {
    // 检查数据库连接
    await prisma.$queryRaw`SELECT 1`

    const healthStatus = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      version: '1.0.0',
      services: {
        database: 'healthy',
        api: 'healthy'
      },
      uptime: process.uptime()
    }

    return ApiResponseBuilder.success(healthStatus)
  } catch (error) {
    return ApiResponseBuilder.error(
      'Service unhealthy',
      503,
      error instanceof Error ? error.message : 'Unknown error'
    )
  }
}
```

### 7. 创建API中间件

创建`src/lib/api/middleware.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { ApiResponseBuilder } from './response'

export async function requireAuth(request: NextRequest) {
  const authHeader = request.headers.get('authorization')

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return ApiResponseBuilder.error('未授权', 401)
  }

  const token = authHeader.substring(7)

  // 这里应该验证token的有效性
  // 简化版：只检查token格式
  if (!token || !token.includes('-')) {
    return ApiResponseBuilder.error('无效的token', 401)
  }

  return null // 验证通过
}

export async function requireRole(request: NextRequest, requiredRoles: string[]) {
  const authResult = await requireAuth(request)
  if (authResult) return authResult

  // 简化版：从token中获取角色信息
  const authHeader = request.headers.get('authorization')!
  const token = authHeader.substring(7)
  const userRole = token.split('-')[2] || 'USER'

  if (!requiredRoles.includes(userRole)) {
    return ApiResponseBuilder.error('权限不足', 403)
  }

  return null // 验证通过
}

export function logRequest(request: NextRequest) {
  const startTime = Date.now()

  return {
    endTime: () => {
      const duration = Date.now() - startTime
      console.log(`${request.method} ${request.url} - ${duration}ms`)
    }
  }
}

export function rateLimit(request: NextRequest, limit: number = 100, windowMs: number = 60000) {
  const ip = request.ip || 'unknown'
  const key = `rate_limit:${ip}`

  // 这里应该使用Redis等缓存服务
  // 简化版：内存存储（不适用于生产环境）
  const now = Date.now()
  const windowStart = now - windowMs

  // 返回null表示允许请求
  return null
}
```

### 8. 创建API路由索引

创建`src/app/api/README.md`:

```markdown
# TMS NL-Ops API 文档

## 基础信息

- 基础URL: `/api`
- 版本: v1
- 认证方式: Bearer Token

## 通用响应格式

```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "metadata": {
    "timestamp": "2024-01-01T00:00:00.000Z",
    "requestId": "abc123"
  }
}
```

## API端点

### 认证相关

#### POST /api/auth/login
用户登录

**请求体:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

#### GET /api/auth/profile
获取用户信息

**请求头:**
```
Authorization: Bearer <token>
```

### 订单管理

#### GET /api/orders
获取订单列表

**查询参数:**
- `status`: 订单状态 (PENDING, CONFIRMED, IN_TRANSIT, DELIVERED, CANCELLED)
- `customerId`: 客户ID
- `page`: 页码 (默认: 1)
- `limit`: 每页数量 (默认: 20)

#### POST /api/orders
创建订单

**请求体:**
```json
{
  "customerId": "customer-id",
  "origin": "北京",
  "destination": "上海",
  "weight": 1000,
  "pickupTime": "2024-01-01T10:00:00Z",
  "deliveryTime": "2024-01-02T10:00:00Z"
}
```

#### GET /api/orders/[id]
获取订单详情

#### PUT /api/orders/[id]
更新订单

#### DELETE /api/orders/[id]
删除订单

### 车辆管理

#### GET /api/vehicles
获取车辆列表

#### POST /api/vehicles
创建车辆

### NL-Ops

#### POST /api/nlops/command
执行自然语言命令

**请求体:**
```json
{
  "command": "创建一个从北京到上海的订单",
  "userId": "user-id"
}
```

#### GET /api/nlops/history
获取命令历史

### 系统监控

#### GET /api/health
健康检查
```

## 验证清单

- [ ] 认证API功能正常
- [ ] 订单管理CRUD操作完整
- [ ] 车辆管理API可用
- [ ] NL-Ops命令处理正常
- [ ] 健康检查API工作
- [ ] 错误处理机制完善
- [ ] API响应格式统一
- [ ] 中间件功能正常

## 测试命令

```bash
# 测试健康检查
curl http://localhost:3000/api/health

# 测试登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# 测试获取订单列表
curl http://localhost:3000/api/orders

# 测试创建订单
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{"customerId":"customer-id","origin":"北京","destination":"上海","weight":1000,"pickupTime":"2024-01-01T10:00:00Z","deliveryTime":"2024-01-02T10:00:00Z"}'

# 测试NL-Ops命令
curl -X POST http://localhost:3000/api/nlops/command \
  -H "Content-Type: application/json" \
  -d '{"command":"创建一个从北京到上海的订单"}'
```

## 注意事项

- 所有API都需要适当的错误处理
- 敏感信息不要在响应中返回
- 考虑添加API版本控制
- 实现适当的请求限流
- 添加API文档和示例
- 考虑添加API监控和日志记录