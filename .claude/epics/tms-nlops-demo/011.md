---
title: "TMS NL-Ops演示系统任务011: 排车调度API实现"
epic: "tms-nlops-demo"
task: "011"
phase: "2"
status: completed
priority: "high"
estimated_hours: 4
parallel: true
depends_on: ["001", "002", "003", "004", "005", "006", "007"]
tags: ["api", "dispatch", "scheduling", "backend", "typescript"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T08:20:00Z"
---

## 概述

实现排车调度相关的API接口，包括发车单创建、状态更新和调度管理。构建完整的运输调度系统，支持智能车辆分配和路径规划。

## 目标

- 实现发车单CRUD操作的API接口
- 创建发车单数据模型和类型定义
- 实现智能车辆调度算法
- 集成状态更新和跟踪功能
- 提供调度查询和统计功能

## 技术栈

- **框架**: Next.js 15+ API Routes
- **语言**: TypeScript
- **数据库**: PostgreSQL (通过Prisma)
- **验证**: Zod schema validation
- **算法**: 智能调度算法
- **API**: RESTful设计模式

## 实施步骤

### 1. 创建发车单数据模型

更新`prisma/schema.prisma`:

```prisma
model Shipment {
  id                String   @id @default(cuid())
  shipmentNumber    String   @unique
  orderId           String
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id])

  // 车辆和驾驶员信息
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id])
  driverId          String
  driver            Driver   @relation(fields: [driverId], references: [id])

  // 路线信息
  originAddress     String
  destinationAddress String
  originCoordinates String?  // JSON格式: {lat: number, lng: number}
  destinationCoordinates String? // JSON格式: {lat: number, lng: number}
  distance          Float?   // 距离(公里)
  estimatedDuration Float?   // 预计时间(小时)

  // 时间信息
  scheduledTime     DateTime // 计划发车时间
  departureTime     DateTime? // 实际发车时间
  estimatedArrival  DateTime // 预计到达时间
  actualArrival     DateTime? // 实际到达时间

  // 货物信息
  cargoWeight       Float    // 货物重量(吨)
  cargoVolume       Float    // 货物体积(立方米)
  cargoValue        Float?   // 货物价值
  specialHandling   Boolean  @default(false) // 特殊处理需求

  // 费用信息
  baseRate          Float    // 基础费率
  fuelSurcharge     Float    @default(0) // 燃油附加费
  tollFees          Float    @default(0) // 过路费
  additionalCharges Float    @default(0) // 额外费用
  totalAmount       Float    // 总费用

  // 状态信息
  status            ShipmentStatus @default(SCHEDULED)
  priority          Priority    @default(MEDIUM)

  // 跟踪信息
  currentLocation   String?   // 当前位置
  currentCoordinates String?  // JSON格式
  progress          Float     @default(0) // 运输进度百分比

  // 元数据
  instructions      String?   // 运输说明
  requirements      String?   // 特殊要求
  notes             String?
  createdBy         String
  updatedBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 关联关系
  documents         Document[]
  trackingLogs      TrackingLog[]
  checkpoints       ShipmentCheckpoint[]
}

model ShipmentCheckpoint {
  id          String   @id @default(cuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  name        String   // 检查点名称
  address     String   // 检查点地址
  coordinates String   // JSON格式
  isRequired  Boolean  @default(true) // 是否必须经过
  estimatedTime DateTime? // 预计到达时间
  actualTime  DateTime? // 实际到达时间
  status      CheckpointStatus @default(PENDING)
  notes       String?
  order       Int      // 顺序
  createdAt   DateTime @default(now())
}

model Driver {
  id            String   @id @default(cuid())
  driverNumber  String   @unique
  name          String
  phone         String
  email         String?
  licenseNumber String   @unique
  licenseType   String
  licenseExpiry DateTime
  address       String
  emergencyContact String?
  emergencyPhone String?

  // 状态信息
  status        DriverStatus @default(AVAILABLE)
  drivingYears  Int      @default(0)
  accidentCount Int      @default(0)
  violationCount Int     @default(0)

  // 工作信息
  hourlyRate    Float    // 小时工资
  monthlySalary Float?   // 月薪
  hireDate      DateTime
  lastMedicalCheck DateTime?

  // 评分信息
  rating        Float    @default(0) // 司机评分
  totalTrips    Int      @default(0)
  totalDistance Float    @default(0) // 总行驶里程

  // 元数据
  notes         String?
  tags          String[]
  isActive      Boolean  @default(true)
  createdBy     String
  updatedBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关联关系
  vehicles      Vehicle[]
  shipments     Shipment[]
  documents     Document[]
}

enum ShipmentStatus {
  SCHEDULED      // 已调度
  ASSIGNED       // 已分配
  LOADING        // 装货中
  IN_TRANSIT     // 运输中
  UNLOADING      // 卸货中
  DELIVERED      // 已送达
  DELAYED        // 延迟
  CANCELLED      // 已取消
  RETURNED       // 已返回
}

enum CheckpointStatus {
  PENDING        // 待到达
  PASSED         // 已通过
  MISSED         // 已错过
  SKIPPED        // 已跳过
}

enum DriverStatus {
  AVAILABLE      // 可用
  ON_DUTY        // 在岗
  DRIVING        // 驾驶中
  RESTING        // 休息中
  OFF_DUTY       // 下班
  SICK_LEAVE     // 病假
  VACATION       // 休假
  SUSPENDED      // 停职
}
```

### 2. 创建发车单类型定义

创建`src/types/shipment.ts`:

```typescript
import { ShipmentStatus, Priority, CheckpointStatus, DriverStatus } from '@prisma/client'

export interface Shipment {
  id: string
  shipmentNumber: string
  orderId: string
  customerId: string
  vehicleId: string
  driverId: string
  originAddress: string
  destinationAddress: string
  originCoordinates?: string
  destinationCoordinates?: string
  distance?: number
  estimatedDuration?: number
  scheduledTime: Date
  departureTime?: Date
  estimatedArrival: Date
  actualArrival?: Date
  cargoWeight: number
  cargoVolume: number
  cargoValue?: number
  specialHandling: boolean
  baseRate: number
  fuelSurcharge: number
  tollFees: number
  additionalCharges: number
  totalAmount: number
  status: ShipmentStatus
  priority: Priority
  currentLocation?: string
  currentCoordinates?: string
  progress: number
  instructions?: string
  requirements?: string
  notes?: string
  createdBy: string
  updatedBy: string
  createdAt: Date
  updatedAt: Date

  // 关联数据
  order?: Order
  customer?: Customer
  vehicle?: Vehicle
  driver?: Driver
  documents?: Document[]
  trackingLogs?: TrackingLog[]
  checkpoints?: ShipmentCheckpoint[]
}

export interface ShipmentCheckpoint {
  id: string
  shipmentId: string
  name: string
  address: string
  coordinates: string
  isRequired: boolean
  estimatedTime?: Date
  actualTime?: Date
  status: CheckpointStatus
  notes?: string
  order: number
  createdAt: Date
}

export interface Driver {
  id: string
  driverNumber: string
  name: string
  phone: string
  email?: string
  licenseNumber: string
  licenseType: string
  licenseExpiry: Date
  address: string
  emergencyContact?: string
  emergencyPhone?: string
  status: DriverStatus
  drivingYears: number
  accidentCount: number
  violationCount: number
  hourlyRate: number
  monthlySalary?: number
  hireDate: Date
  lastMedicalCheck?: Date
  rating: number
  totalTrips: number
  totalDistance: number
  notes?: string
  tags: string[]
  isActive: boolean
  createdBy: string
  updatedBy: string
  createdAt: Date
  updatedAt: Date
}

export interface CreateShipmentRequest {
  orderId: string
  vehicleId: string
  driverId: string
  scheduledTime: Date
  originAddress: string
  destinationAddress: string
  cargoWeight: number
  cargoVolume: number
  cargoValue?: number
  specialHandling?: boolean
  instructions?: string
  requirements?: string
  notes?: string
  checkpoints?: Omit<ShipmentCheckpoint, 'id' | 'shipmentId' | 'createdAt' | 'status'>[]
}

export interface UpdateShipmentRequest {
  vehicleId?: string
  driverId?: string
  scheduledTime?: Date
  departureTime?: Date
  estimatedArrival?: Date
  actualArrival?: Date
  status?: ShipmentStatus
  priority?: Priority
  instructions?: string
  requirements?: string
  notes?: string
  progress?: number
  currentLocation?: string
  currentCoordinates?: string
}

export interface ShipmentQueryParams {
  status?: ShipmentStatus
  priority?: Priority
  vehicleId?: string
  driverId?: string
  customerId?: string
  startDate?: Date
  endDate?: Date
  origin?: string
  destination?: string
  page?: number
  limit?: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### 3. 创建发车单验证Schema

创建`src/validations/shipment.ts`:

```typescript
import { z } from 'zod'
import { ShipmentStatus, Priority, CheckpointStatus, DriverStatus } from '@prisma/client'

const coordinatesSchema = z.object({
  lat: z.number().min(-90).max(90),
  lng: z.number().min(-180).max(180)
})

const checkpointSchema = z.object({
  name: z.string().min(1, '检查点名称不能为空'),
  address: z.string().min(1, '检查点地址不能为空'),
  coordinates: z.string().refine(val => {
    try {
      const coords = JSON.parse(val)
      return coordinatesSchema.safeParse(coords).success
    } catch {
      return false
    }, '坐标格式不正确，应为JSON格式: {lat: number, lng: number}'),
  isRequired: z.boolean().default(true),
  estimatedTime: z.date().optional(),
  actualTime: z.date().optional(),
  notes: z.string().optional(),
  order: z.number().min(0, '顺序不能为负数')
})

export const createShipmentSchema = z.object({
  orderId: z.string().min(1, '订单ID不能为空'),
  vehicleId: z.string().min(1, '车辆ID不能为空'),
  driverId: z.string().min(1, '驾驶员ID不能为空'),
  scheduledTime: z.date('计划发车时间不能为空'),
  originAddress: z.string().min(1, '发货地址不能为空'),
  destinationAddress: z.string().min(1, '收货地址不能为空'),
  cargoWeight: z.number().positive('货物重量必须大于0'),
  cargoVolume: z.number().positive('货物体积必须大于0'),
  cargoValue: z.number().positive('货物价值必须大于0').optional(),
  specialHandling: z.boolean().default(false),
  instructions: z.string().optional(),
  requirements: z.string().optional(),
  notes: z.string().optional(),
  checkpoints: z.array(checkpointSchema).optional()
})

export const updateShipmentSchema = z.object({
  vehicleId: z.string().min(1, '车辆ID不能为空').optional(),
  driverId: z.string().min(1, '驾驶员ID不能为空').optional(),
  scheduledTime: z.date().optional(),
  departureTime: z.date().optional(),
  estimatedArrival: z.date().optional(),
  actualArrival: z.date().optional(),
  status: z.nativeEnum(ShipmentStatus).optional(),
  priority: z.nativeEnum(Priority).optional(),
  instructions: z.string().optional(),
  requirements: z.string().optional(),
  notes: z.string().optional(),
  progress: z.number().min(0).max(100, '进度必须在0-100之间').optional(),
  currentLocation: z.string().optional(),
  currentCoordinates: z.string().refine(val => {
    if (!val) return true
    try {
      const coords = JSON.parse(val)
      return coordinatesSchema.safeParse(coords).success
    } catch {
      return false
    }
  }, '坐标格式不正确').optional()
})

export const shipmentQuerySchema = z.object({
  status: z.nativeEnum(ShipmentStatus).optional(),
  priority: z.nativeEnum(Priority).optional(),
  vehicleId: z.string().optional(),
  driverId: z.string().optional(),
  customerId: z.string().optional(),
  startDate: z.date().optional(),
  endDate: z.date().optional(),
  origin: z.string().optional(),
  destination: z.string().optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(20),
  sortBy: z.string().default('scheduledTime'),
  sortOrder: z.enum(['asc', 'desc']).default('desc')
})

export const createDriverSchema = z.object({
  name: z.string().min(1, '姓名不能为空'),
  phone: z.string().min(1, '电话号码不能为空'),
  email: z.string().email('邮箱格式不正确').optional(),
  licenseNumber: z.string().min(1, '驾驶证号不能为空'),
  licenseType: z.string().min(1, '驾驶证类型不能为空'),
  licenseExpiry: z.date('驾驶证到期时间不能为空'),
  address: z.string().min(1, '地址不能为空'),
  emergencyContact: z.string().optional(),
  emergencyPhone: z.string().optional(),
  hourlyRate: z.number().positive('小时工资必须大于0'),
  monthlySalary: z.number().positive('月薪必须大于0').optional(),
  hireDate: z.date('入职日期不能为空'),
  lastMedicalCheck: z.date().optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional()
})

export const updateDriverSchema = z.object({
  name: z.string().min(1, '姓名不能为空').optional(),
  phone: z.string().min(1, '电话号码不能为空').optional(),
  email: z.string().email('邮箱格式不正确').optional(),
  licenseNumber: z.string().min(1, '驾驶证号不能为空').optional(),
  licenseType: z.string().min(1, '驾驶证类型不能为空').optional(),
  licenseExpiry: z.date('驾驶证到期时间不能为空').optional(),
  address: z.string().min(1, '地址不能为空').optional(),
  emergencyContact: z.string().optional(),
  emergencyPhone: z.string().optional(),
  hourlyRate: z.number().positive('小时工资必须大于0').optional(),
  monthlySalary: z.number().positive('月薪必须大于0').optional(),
  status: z.nativeEnum(DriverStatus).optional(),
  lastMedicalCheck: z.date().optional(),
  notes: z.string().optional(),
  tags: z.array(z.string()).optional(),
  isActive: z.boolean().optional()
})
```

### 4. 实现发车单API路由

创建`src/app/api/shipments/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { shipmentQuerySchema } from '@/validations/shipment'
import { getCurrentUser } from '@/lib/auth'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const searchParams = request.nextUrl.searchParams
    const query = {
      status: searchParams.get('status') || undefined,
      priority: searchParams.get('priority') || undefined,
      vehicleId: searchParams.get('vehicleId') || undefined,
      driverId: searchParams.get('driverId') || undefined,
      customerId: searchParams.get('customerId') || undefined,
      startDate: searchParams.get('startDate') ? new Date(searchParams.get('startDate')!) : undefined,
      endDate: searchParams.get('endDate') ? new Date(searchParams.get('endDate')!) : undefined,
      origin: searchParams.get('origin') || undefined,
      destination: searchParams.get('destination') || undefined,
      page: parseInt(searchParams.get('page') || '1'),
      limit: parseInt(searchParams.get('limit') || '20'),
      sortBy: searchParams.get('sortBy') || 'scheduledTime',
      sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') || 'desc'
    }

    const validatedQuery = shipmentQuerySchema.parse(query)

    const where: any = {}
    if (validatedQuery.status) where.status = validatedQuery.status
    if (validatedQuery.priority) where.priority = validatedQuery.priority
    if (validatedQuery.vehicleId) where.vehicleId = validatedQuery.vehicleId
    if (validatedQuery.driverId) where.driverId = validatedQuery.driverId
    if (validatedQuery.customerId) where.customerId = validatedQuery.customerId
    if (validatedQuery.startDate || validatedQuery.endDate) {
      where.scheduledTime = {}
      if (validatedQuery.startDate) where.scheduledTime.gte = validatedQuery.startDate
      if (validatedQuery.endDate) where.scheduledTime.lte = validatedQuery.endDate
    }
    if (validatedQuery.origin) where.originAddress = { contains: validatedQuery.origin }
    if (validatedQuery.destination) where.destinationAddress = { contains: validatedQuery.destination }

    const [shipments, total] = await Promise.all([
      prisma.shipment.findMany({
        where,
        include: {
          order: {
            select: {
              id: true,
              orderNumber: true,
              cargoName: true,
              totalAmount: true
            }
          },
          customer: {
            select: {
              id: true,
              customerNumber: true,
              companyName: true,
              email: true,
              phone: true
            }
          },
          vehicle: {
            select: {
              id: true,
              licenseNumber: true,
              brand: true,
              model: true,
              status: true
            }
          },
          driver: {
            select: {
              id: true,
              name: true,
              phone: true,
              licenseNumber: true,
              status: true
            }
          },
          checkpoints: {
            orderBy: { order: 'asc' }
          },
          trackingLogs: {
            take: 5,
            orderBy: { createdAt: 'desc' }
          }
        },
        skip: (validatedQuery.page - 1) * validatedQuery.limit,
        take: validatedQuery.limit,
        orderBy: {
          [validatedQuery.sortBy]: validatedQuery.sortOrder
        }
      }),
      prisma.shipment.count({ where })
    ])

    return NextResponse.json({
      success: true,
      data: shipments,
      pagination: {
        page: validatedQuery.page,
        limit: validatedQuery.limit,
        total,
        pages: Math.ceil(total / validatedQuery.limit)
      }
    })
  } catch (error) {
    console.error('获取发车单列表失败:', error)
    return NextResponse.json(
      { error: '获取发车单列表失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = createShipmentSchema.parse(body)

    // 检查订单是否存在
    const order = await prisma.order.findUnique({
      where: { id: validatedData.orderId }
    })

    if (!order) {
      return NextResponse.json(
        { error: '订单不存在' },
        { status: 404 }
      )
    }

    // 检查车辆是否可用
    const vehicle = await prisma.vehicle.findUnique({
      where: { id: validatedData.vehicleId }
    })

    if (!vehicle || vehicle.status !== 'AVAILABLE') {
      return NextResponse.json(
        { error: '车辆不可用' },
        { status: 400 }
      )
    }

    // 检查驾驶员是否可用
    const driver = await prisma.driver.findUnique({
      where: { id: validatedData.driverId }
    })

    if (!driver || driver.status !== 'AVAILABLE') {
      return NextResponse.json(
        { error: '驾驶员不可用' },
        { status: 400 }
      )
    }

    // 检查时间冲突
    const timeConflict = await prisma.shipment.findFirst({
      where: {
        OR: [
          { vehicleId: validatedData.vehicleId },
          { driverId: validatedData.driverId }
        ],
        status: {
          in: ['SCHEDULED', 'ASSIGNED', 'LOADING', 'IN_TRANSIT']
        },
        scheduledTime: {
          lte: new Date(validatedData.scheduledTime.getTime() + 24 * 60 * 60 * 1000), // 24小时窗口
          gte: new Date(validatedData.scheduledTime.getTime() - 24 * 60 * 60 * 1000)
        }
      }
    })

    if (timeConflict) {
      return NextResponse.json(
        { error: '车辆或驾驶员在该时间段已被调度' },
        { status: 400 }
      )
    }

    // 计算距离和预计时间
    const distance = await calculateDistance(validatedData.originAddress, validatedData.destinationAddress)
    const estimatedDuration = Math.ceil(distance / 60) // 假设平均时速60km/h

    // 计算费用
    const baseRate = await calculateBaseRate(vehicle, distance)
    const fuelSurcharge = calculateFuelSurcharge(distance)
    const tollFees = await estimateTollFees(validatedData.originAddress, validatedData.destinationAddress)
    const totalAmount = baseRate + fuelSurcharge + tollFees

    // 生成发车单号
    const shipmentNumber = generateShipmentNumber()

    const shipment = await prisma.shipment.create({
      data: {
        shipmentNumber,
        orderId: validatedData.orderId,
        customerId: order.customerId,
        vehicleId: validatedData.vehicleId,
        driverId: validatedData.driverId,
        originAddress: validatedData.originAddress,
        destinationAddress: validatedData.destinationAddress,
        distance,
        estimatedDuration,
        scheduledTime: validatedData.scheduledTime,
        estimatedArrival: new Date(validatedData.scheduledTime.getTime() + estimatedDuration * 60 * 60 * 1000),
        cargoWeight: validatedData.cargoWeight,
        cargoVolume: validatedData.cargoVolume,
        cargoValue: validatedData.cargoValue,
        specialHandling: validatedData.specialHandling || false,
        baseRate,
        fuelSurcharge,
        tollFees,
        additionalCharges: 0,
        totalAmount,
        status: ShipmentStatus.SCHEDULED,
        priority: Priority.MEDIUM,
        instructions: validatedData.instructions,
        requirements: validatedData.requirements,
        notes: validatedData.notes,
        createdBy: user.id,
        updatedBy: user.id
      },
      include: {
        order: {
          select: {
            id: true,
            orderNumber: true,
            cargoName: true
          }
        },
        customer: {
          select: {
            id: true,
            customerNumber: true,
            companyName: true
          }
        },
        vehicle: {
          select: {
            id: true,
            licenseNumber: true,
            brand: true,
            model: true
          }
        },
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        }
      }
    })

    // 创建检查点
    if (validatedData.checkpoints && validatedData.checkpoints.length > 0) {
      const checkpointData = validatedData.checkpoints.map((checkpoint, index) => ({
        shipmentId: shipment.id,
        name: checkpoint.name,
        address: checkpoint.address,
        coordinates: checkpoint.coordinates,
        isRequired: checkpoint.isRequired,
        estimatedTime: checkpoint.estimatedTime,
        notes: checkpoint.notes,
        order: index
      }))

      await prisma.shipmentCheckpoint.createMany({
        data: checkpointData
      })
    }

    // 更新订单状态
    await prisma.order.update({
      where: { id: validatedData.orderId },
      data: {
        status: 'CONFIRMED',
        updatedBy: user.id
      }
    })

    return NextResponse.json({
      success: true,
      data: shipment,
      message: '发车单创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建发车单失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建发车单失败', details: error.message },
      { status: 500 }
    )
  }
}

async function calculateDistance(origin: string, destination: string): Promise<number> {
  // 简化版距离计算，实际应该使用地图API
  return Math.random() * 500 + 50 // 返回50-550公里之间的随机距离
}

async function calculateBaseRate(vehicle: any, distance: number): Promise<number> {
  const baseRatePerKm = vehicle.dailyRate / 300 // 假设每天行驶300公里
  return Math.round(baseRatePerKm * distance * 100) / 100
}

function calculateFuelSurcharge(distance: number): number {
  const fuelPrice = 8 // 假设油价8元/升
  const fuelConsumption = 0.3 // 假设油耗0.3升/公里
  return Math.round(distance * fuelConsumption * fuelPrice * 100) / 100
}

async function estimateTollFees(origin: string, destination: string): Promise<number> {
  // 简化版过路费估算
  return Math.random() * 200 + 50 // 返回50-250元之间的随机费用
}

function generateShipmentNumber(): string {
  const timestamp = Date.now().toString()
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `SHP${timestamp.slice(-6)}${random}`
}
```

### 5. 实现单个发车单操作路由

创建`src/app/api/shipments/[id]/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { updateShipmentSchema } from '@/validations/shipment'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const shipment = await prisma.shipment.findUnique({
      where: { id: params.id },
      include: {
        order: {
          select: {
            id: true,
            orderNumber: true,
            cargoName: true,
            totalAmount: true,
            status: true
          }
        },
        customer: {
          select: {
            id: true,
            customerNumber: true,
            companyName: true,
            email: true,
            phone: true
          }
        },
        vehicle: {
          select: {
            id: true,
            licenseNumber: true,
            brand: true,
            model: true,
            vehicleType: true,
            maxLoad: true,
            maxVolume: true,
            status: true
          }
        },
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true,
            rating: true,
            status: true
          }
        },
        checkpoints: {
          orderBy: { order: 'asc' }
        },
        trackingLogs: {
          orderBy: { createdAt: 'desc' }
        },
        documents: {
          orderBy: { createdAt: 'desc' }
        }
      }
    })

    if (!shipment) {
      return NextResponse.json(
        { error: '发车单不存在' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      success: true,
      data: shipment
    })
  } catch (error) {
    console.error('获取发车单详情失败:', error)
    return NextResponse.json(
      { error: '获取发车单详情失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = updateShipmentSchema.parse(body)

    const existingShipment = await prisma.shipment.findUnique({
      where: { id: params.id }
    })

    if (!existingShipment) {
      return NextResponse.json(
        { error: '发车单不存在' },
        { status: 404 }
      )
    }

    const updateData: any = {
      updatedBy: user.id,
      updatedAt: new Date()
    }

    // 更新字段
    const updatableFields = [
      'vehicleId', 'driverId', 'scheduledTime', 'departureTime',
      'estimatedArrival', 'actualArrival', 'status', 'priority',
      'instructions', 'requirements', 'notes', 'progress',
      'currentLocation', 'currentCoordinates'
    ]

    updatableFields.forEach(field => {
      if (validatedData[field] !== undefined) {
        updateData[field] = validatedData[field]
      }
    })

    // 如果状态发生变化，检查状态转换是否有效
    if (validatedData.status && validatedData.status !== existingShipment.status) {
      const validTransitions = {
        [ShipmentStatus.SCHEDULED]: [ShipmentStatus.ASSIGNED, ShipmentStatus.CANCELLED],
        [ShipmentStatus.ASSIGNED]: [ShipmentStatus.LOADING, ShipmentStatus.CANCELLED],
        [ShipmentStatus.LOADING]: [ShipmentStatus.IN_TRANSIT, ShipmentStatus.CANCELLED],
        [ShipmentStatus.IN_TRANSIT]: [ShipmentStatus.UNLOADING, ShipmentStatus.DELAYED, ShipmentStatus.RETURNED],
        [ShipmentStatus.UNLOADING]: [ShipmentStatus.DELIVERED, ShipmentStatus.DELAYED],
        [ShipmentStatus.DELAYED]: [ShipmentStatus.IN_TRANSIT, ShipmentStatus.UNLOADING, ShipmentStatus.DELIVERED],
        [ShipmentStatus.CANCELLED]: [],
        [ShipmentStatus.DELIVERED]: [],
        [ShipmentStatus.RETURNED]: [ShipmentStatus.IN_TRANSIT]
      }

      if (!validTransitions[existingShipment.status].includes(validatedData.status)) {
        return NextResponse.json(
          { error: `无法从 ${existingShipment.status} 转换到 ${validatedData.status}` },
          { status: 400 }
        )
      }

      // 状态变更时更新相关资源状态
      await updateResourceStatus(existingShipment, validatedData.status, user.id)
    }

    const updatedShipment = await prisma.shipment.update({
      where: { id: params.id },
      data: updateData,
      include: {
        order: {
          select: {
            id: true,
            orderNumber: true,
            cargoName: true
          }
        },
        customer: {
          select: {
            id: true,
            customerNumber: true,
            companyName: true
          }
        },
        vehicle: {
          select: {
            id: true,
            licenseNumber: true,
            brand: true,
            model: true
          }
        },
        driver: {
          select: {
            id: true,
            name: true,
            phone: true,
            licenseNumber: true
          }
        }
      }
    })

    return NextResponse.json({
      success: true,
      data: updatedShipment,
      message: '发车单更新成功'
    })
  } catch (error) {
    console.error('更新发车单失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '更新发车单失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const shipment = await prisma.shipment.findUnique({
      where: { id: params.id }
    })

    if (!shipment) {
      return NextResponse.json(
        { error: '发车单不存在' },
        { status: 404 }
      )
    }

    // 检查是否可以删除
    if (shipment.status !== ShipmentStatus.SCHEDULED && shipment.status !== ShipmentStatus.CANCELLED) {
      return NextResponse.json(
        { error: '只有已调度或已取消的发车单才能删除' },
        { status: 400 }
      )
    }

    await prisma.shipment.delete({
      where: { id: params.id }
    })

    return NextResponse.json({
      success: true,
      message: '发车单删除成功'
    })
  } catch (error) {
    console.error('删除发车单失败:', error)
    return NextResponse.json(
      { error: '删除发车单失败', details: error.message },
      { status: 500 }
    )
  }
}

async function updateResourceStatus(shipment: any, newStatus: string, userId: string) {
  const { vehicleId, driverId } = shipment

  // 更新车辆状态
  let vehicleStatus = null
  let driverStatus = null

  switch (newStatus) {
    case ShipmentStatus.ASSIGNED:
      vehicleStatus = 'RESERVED'
      driverStatus = 'ON_DUTY'
      break
    case ShipmentStatus.LOADING:
      vehicleStatus = 'LOADING'
      driverStatus = 'DRIVING'
      break
    case ShipmentStatus.IN_TRANSIT:
      vehicleStatus = 'IN_TRANSIT'
      driverStatus = 'DRIVING'
      break
    case ShipmentStatus.UNLOADING:
      vehicleStatus = 'UNLOADING'
      driverStatus = 'DRIVING'
      break
    case ShipmentStatus.DELIVERED:
      vehicleStatus = 'AVAILABLE'
      driverStatus = 'ON_DUTY'
      break
    case ShipmentStatus.CANCELLED:
      vehicleStatus = 'AVAILABLE'
      driverStatus = 'AVAILABLE'
      break
  }

  if (vehicleStatus) {
    await prisma.vehicle.update({
      where: { id: vehicleId },
      data: { status: vehicleStatus, updatedBy: userId }
    })
  }

  if (driverStatus) {
    await prisma.driver.update({
      where: { id: driverId },
      data: { status: driverStatus, updatedBy: userId }
    })
  }
}
```

### 6. 实现智能调度服务

创建`src/services/dispatchService.ts`:

```typescript
import { prisma } from '@/lib/prisma'
import { VehicleStatus, DriverStatus, ShipmentStatus } from '@prisma/client'

export class DispatchService {
  static async findOptimalVehicle(orderData: any, scheduledTime: Date) {
    const { cargoWeight, cargoVolume, originAddress, destinationAddress } = orderData

    // 获取可用车辆
    const availableVehicles = await prisma.vehicle.findMany({
      where: {
        status: VehicleStatus.AVAILABLE,
        isActive: true,
        maxLoad: { gte: cargoWeight },
        maxVolume: { gte: cargoVolume }
      },
      include: {
        driver: {
          where: {
            status: DriverStatus.AVAILABLE,
            isActive: true
          }
        },
        location: true
      }
    })

    if (availableVehicles.length === 0) {
      throw new Error('没有可用的车辆')
    }

    // 计算距离和评分
    const vehicleScores = await Promise.all(
      availableVehicles.map(async (vehicle) => {
        if (!vehicle.driver || vehicle.driver.length === 0) {
          return null
        }

        const driver = vehicle.driver[0]
        const distance = await calculateDistance(
          vehicle.location?.address || originAddress,
          originAddress
        )

        // 计算综合评分
        const distanceScore = Math.max(0, 100 - distance) // 距离越近评分越高
        const vehicleScore = calculateVehicleScore(vehicle)
        const driverScore = calculateDriverScore(driver)

        const totalScore = (distanceScore * 0.4) + (vehicleScore * 0.3) + (driverScore * 0.3)

        return {
          vehicle,
          driver,
          distance,
          score: totalScore
        }
      })
    )

    // 过滤掉无效结果并按评分排序
    const validScores = vehicleScores.filter(score => score !== null)
    if (validScores.length === 0) {
      throw new Error('没有可用的驾驶员')
    }

    return validScores.sort((a, b) => b.score - a.score)[0]
  }

  static async createShipment(orderId: string, scheduledTime?: Date) {
    const order = await prisma.order.findUnique({
      where: { id: orderId },
      include: {
        customer: true
      }
    })

    if (!order) {
      throw new Error('订单不存在')
    }

    // 智能选择车辆和驾驶员
    const optimalMatch = await this.findOptimalVehicle(order, scheduledTime || new Date())
    if (!optimalMatch) {
      throw new Error('无法找到合适的车辆和驾驶员')
    }

    const { vehicle, driver } = optimalMatch

    // 计算距离和预计时间
    const distance = await calculateDistance(order.originAddress, order.destinationAddress)
    const estimatedDuration = Math.ceil(distance / 60)

    // 创建发车单
    const shipment = await prisma.shipment.create({
      data: {
        shipmentNumber: generateShipmentNumber(),
        orderId,
        customerId: order.customerId,
        vehicleId: vehicle.id,
        driverId: driver.id,
        originAddress: order.originAddress,
        destinationAddress: order.destinationAddress,
        distance,
        estimatedDuration,
        scheduledTime: scheduledTime || new Date(),
        estimatedArrival: new Date((scheduledTime || new Date()).getTime() + estimatedDuration * 60 * 60 * 1000),
        cargoWeight: order.cargoWeight,
        cargoVolume: order.cargoVolume,
        cargoValue: order.cargoValue,
        specialHandling: false,
        baseRate: await calculateBaseRate(vehicle, distance),
        fuelSurcharge: calculateFuelSurcharge(distance),
        tollFees: await estimateTollFees(order.originAddress, order.destinationAddress),
        additionalCharges: 0,
        totalAmount: 0, // 稍后计算
        status: ShipmentStatus.SCHEDULED,
        priority: order.priority,
        createdBy: 'system',
        updatedBy: 'system'
      }
    })

    // 更新总费用
    await prisma.shipment.update({
      where: { id: shipment.id },
      data: {
        totalAmount: shipment.baseRate + shipment.fuelSurcharge + shipment.tollFees
      }
    })

    // 更新资源状态
    await Promise.all([
      prisma.vehicle.update({
        where: { id: vehicle.id },
        data: { status: VehicleStatus.RESERVED }
      }),
      prisma.driver.update({
        where: { id: driver.id },
        data: { status: DriverStatus.ON_DUTY }
      }),
      prisma.order.update({
        where: { id: orderId },
        data: { status: 'CONFIRMED' }
      })
    ])

    return shipment
  }

  static async optimizeSchedule(date: Date) {
    const startOfDay = new Date(date.setHours(0, 0, 0, 0))
    const endOfDay = new Date(date.setHours(23, 59, 59, 999))

    // 获取当天的所有订单
    const orders = await prisma.order.findMany({
      where: {
        expectedTime: {
          gte: startOfDay,
          lte: endOfDay
        },
        status: 'PENDING'
      },
      orderBy: {
        priority: 'desc'
      }
    })

    if (orders.length === 0) {
      return { message: '没有需要调度的订单' }
    }

    const results = []
    for (const order of orders) {
      try {
        const shipment = await this.createShipment(order.id, order.expectedTime)
        results.push({
          orderId: order.id,
          shipmentId: shipment.id,
          status: 'success'
        })
      } catch (error) {
        results.push({
          orderId: order.id,
          error: error.message,
          status: 'failed'
        })
      }
    }

    return results
  }
}

function calculateVehicleScore(vehicle: any): number {
  let score = 50 // 基础分数

  // 根据车辆状况加分
  if (vehicle.maintenanceCost < 1000) score += 10
  if (vehicle.fuelLevel > 50) score += 10
  if (vehicle.dailyRate < 1000) score += 10

  return Math.min(100, score)
}

function calculateDriverScore(driver: any): number {
  let score = 50 // 基础分数

  // 根据驾驶员评分
  score += driver.rating * 10
  if (driver.accidentCount === 0) score += 10
  if (driver.violationCount === 0) score += 10
  if (driver.drivingYears > 5) score += 10

  return Math.min(100, score)
}

// 辅助函数（与前面定义的相同）
async function calculateDistance(origin: string, destination: string): Promise<number> {
  return Math.random() * 500 + 50
}

async function calculateBaseRate(vehicle: any, distance: number): Promise<number> {
  const baseRatePerKm = vehicle.dailyRate / 300
  return Math.round(baseRatePerKm * distance * 100) / 100
}

function calculateFuelSurcharge(distance: number): number {
  const fuelPrice = 8
  const fuelConsumption = 0.3
  return Math.round(distance * fuelConsumption * fuelPrice * 100) / 100
}

async function estimateTollFees(origin: string, destination: string): Promise<number> {
  return Math.random() * 200 + 50
}

function generateShipmentNumber(): string {
  const timestamp = Date.now().toString()
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `SHP${timestamp.slice(-6)}${random}`
}
```

## 验证清单

- [ ] 发车单数据模型定义正确
- [ ] API路由实现完整
- [ ] 数据验证Schema有效
- [ ] 发车单创建功能正常
- [ ] 发车单查询功能正常
- [ ] 发车单更新功能正常
- [ ] 发车单删除功能正常
- [ ] 智能调度算法工作正常
- [ ] 状态转换逻辑正确
- [ ] 费用计算准确
- [ ] 错误处理机制完善

## 测试命令

```bash
# 运行API测试
npm run test:api

# 数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

## 注意事项

- 确保发车单数据验证规则完善
- 智能调度算法需要考虑多种因素
- 状态转换需要符合业务逻辑
- 费用计算需要准确
- 时间冲突检查需要完善
- 资源状态更新需要同步
- 检查点管理需要支持路线规划