---
title: "TMS NL-Ops演示系统任务004: 数据库Schema设计 (订单、客户、车辆、排车、跟踪、回单等实体)"
epic: "tms-nlops-demo"
task: "004"
phase: "1"
status: "completed"
priority: "high"
estimated_hours: 4
parallel: true
depends_on: ["003"]
tags: ["database", "schema", "prisma", "modeling"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T05:30:00Z"
---

## 概述

设计TMS NL-Ops演示系统的完整数据库Schema，包括订单管理、客户管理、车辆管理、排车调度、实时跟踪、回单管理等核心业务实体，以及NL-Ops相关的数据模型。

## 目标

- 设计完整的业务实体模型
- 建立实体间的关系和约束
- 创建索引优化查询性能
- 支持自然语言操作的数据结构
- 验证Schema设计合理性和完整性

## 数据实体设计

### 核心实体
1. **User** - 用户管理
2. **Customer** - 客户管理
3. **Order** - 订单管理
4. **Vehicle** - 车辆管理
5. **Schedule** - 排车调度
6. **Tracking** - 实时跟踪
7. **Receipt** - 回单管理
8. **NLCommand** - 自然语言命令
9. **Intent** - 意图定义

## 实施步骤

### 1. 完整Prisma Schema设计

更新`prisma/schema.prisma`:

```prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  // PostgreSQL 17 specific configuration
  extensions = [
    { name = "uuid-ossp", version = "1.1" },
    { name = "pg_trgm", version = "1.6" },
    { name = "unaccent", version = "1.1" }
  ]
}

// 枚举定义
enum UserRole {
  ADMIN
  MANAGER
  DRIVER
  CUSTOMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum VehicleType {
  TRUCK
  VAN
  TRAILER
}

enum VehicleStatus {
  AVAILABLE
  IN_TRANSIT
  MAINTENANCE
  UNAVAILABLE
}

enum ScheduleStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DELAYED
}

enum TrackingStatus {
  PICKUP
  IN_TRANSIT
  DELIVERY
  COMPLETED
}

enum ReceiptStatus {
  PENDING
  UPLOADED
  VERIFIED
  REJECTED
}

enum CommandStatus {
  PENDING
  EXECUTING
  COMPLETED
  FAILED
}

// 用户模型
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  role      UserRole @default(CUSTOMER)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关系
  vehicles    Vehicle[]
  receipts    Receipt[]
  nlCommands  NLCommand[]

  @@map("users")
}

// 客户模型
model Customer {
  id             String   @id @default(uuid()) @db.Uuid
  name           String
  contactPerson  String
  phone          String
  email          String
  address        String
  company        String
  creditLimit    Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 关系
  orders Order[]

  @@map("customers")
}

// 订单模型
model Order {
  id                 String      @id @default(uuid()) @db.Uuid
  orderNumber        String      @unique
  customerId         String      @db.Uuid
  customer           Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  status             OrderStatus @default(PENDING)
  origin             String
  destination        String
  weight             Float
  volume             Float
  value              Float?
  pickupTime         DateTime
  deliveryTime       DateTime
  specialInstructions String?
  assignedVehicleId  String?     @db.Uuid
  assignedVehicle    Vehicle?    @relation(fields: [assignedVehicleId], references: [id])
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // 关系
  schedules Schedule[]
  trackings Tracking[]
  receipts  Receipt[]
  nlCommands NLCommand[]

  @@map("orders")
  @@index([status])
  @@index([customerId])
  @@index([assignedVehicleId])
  @@index([pickupTime])
  @@index([deliveryTime])
}

// 车辆模型
model Vehicle {
  id                String        @id @default(uuid()) @db.Uuid
  licensePlate      String        @unique
  type              VehicleType
  capacity          Float
  driverId          String        @db.Uuid
  driver            User          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  status            VehicleStatus @default(AVAILABLE)
  currentLocation   String?
  lastMaintenance   DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // 关系
  schedules Schedule[]
  orders    Order[]

  @@map("vehicles")
  @@index([status])
  @@index([driverId])
  @@index([licensePlate])
}

// 排车调度模型
model Schedule {
  id                 String          @id @default(uuid()) @db.Uuid
  orderId            String          @db.Uuid
  order              Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vehicleId          String          @db.Uuid
  vehicle            Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  plannedDeparture   DateTime
  plannedArrival     DateTime
  actualDeparture    DateTime?
  actualArrival      DateTime?
  status             ScheduleStatus  @default(PLANNED)
  route              String[]        @db.Text[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@map("schedules")
  @@index([orderId])
  @@index([vehicleId])
  @@index([status])
  @@index([plannedDeparture])
  @@index([plannedArrival])
}

// 实时跟踪模型
model Tracking {
  id          String          @id @default(uuid()) @db.Uuid
  orderId     String          @db.Uuid
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  location    String
  coordinates Json            // {"lat": 0.0, "lng": 0.0}
  status      TrackingStatus  @default(IN_TRANSIT)
  timestamp   DateTime        @default(now())
  notes       String?
  imageUrl    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("trackings")
  @@index([orderId])
  @@index([status])
  @@index([timestamp])
  @@index([location])
}

// 回单模型
model Receipt {
  id          String         @id @default(uuid()) @db.Uuid
  orderId     String         @db.Uuid
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      ReceiptStatus  @default(PENDING)
  imageUrl    String?
  notes       String?
  verifiedBy  String?        @db.Uuid
  verifiedAt  DateTime?
  verifier    User?          @relation(fields: [verifiedBy], references: [id])
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("receipts")
  @@index([orderId])
  @@index([status])
  @@index([verifiedBy])
  @@index([verifiedAt])
}

// 自然语言命令模型
model NLCommand {
  id          String        @id @default(uuid()) @db.Uuid
  command     String
  intent      String
  parameters  Json          // {"key": "value"}
  confidence  Float         @default(0.0)
  status      CommandStatus @default(PENDING)
  executed    Boolean       @default(false)
  result      Json?
  error       String?
  userId      String?       @db.Uuid
  user        User?         @relation(fields: [userId], references: [id])
  orderId     String?       @db.Uuid
  order       Order?        @relation(fields: [orderId], references: [id])
  createdAt   DateTime      @default(now())
  executedAt  DateTime?
  updatedAt   DateTime      @updatedAt

  @@map("nl_commands")
  @@index([intent])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([executed])
}

// 意图定义模型
model Intent {
  id                 String  @id @default(uuid()) @db.Uuid
  name               String  @unique
  description        String
  parameters         Json    // [{"name": "param", "type": "string", "required": true}]
  requiredParameters String[] @db.Text[]
  examples           String[] @db.Text[]
  isActive           Boolean @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("intents")
  @@index([name])
  @@index([isActive])
}

// 系统配置模型
model SystemConfig {
  id          String  @id @default(uuid()) @db.Uuid
  key         String  @unique
  value       Json
  description String?
  category    String  @default("general")
  isPublic    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
  @@index([key])
  @@index([category])
}

// 审计日志模型
model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  action      String
  entity      String
  entityId    String   @db.Uuid
  userId      String?  @db.Uuid
  user        User?    @relation(fields: [userId], references: [id])
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@map("audit_logs")
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
}
```

### 2. 创建数据库种子文件

创建`prisma/seed.ts`:

```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('开始数据库种子数据初始化...')

  // 创建系统配置
  const configs = await prisma.systemConfig.createMany({
    data: [
      {
        key: 'app_name',
        value: { value: 'TMS NL-Ops Demo' },
        description: '应用程序名称',
        category: 'app',
        isPublic: true
      },
      {
        key: 'app_version',
        value: { value: '1.0.0' },
        description: '应用程序版本',
        category: 'app',
        isPublic: true
      },
      {
        key: 'openai_model',
        value: { value: 'gpt-4' },
        description: 'OpenAI模型名称',
        category: 'ai'
      },
      {
        key: 'max_order_weight',
        value: { value: 50000 },
        description: '最大订单重量(kg)',
        category: 'business'
      }
    ],
    skipDuplicates: true
  })

  console.log('系统配置创建完成')

  // 创建意图定义
  const intents = await prisma.intent.createMany({
    data: [
      {
        name: 'create_order',
        description: '创建新订单',
        parameters: JSON.stringify([
          { name: 'customer_name', type: 'string', required: true, description: '客户名称' },
          { name: 'origin', type: 'string', required: true, description: '起始地点' },
          { name: 'destination', type: 'string', required: true, description: '目的地' },
          { name: 'weight', type: 'number', required: true, description: '货物重量' },
          { name: 'pickup_time', type: 'date', required: true, description: '取货时间' },
          { name: 'delivery_time', type: 'date', required: true, description: '送达时间' }
        ]),
        requiredParameters: ['customer_name', 'origin', 'destination', 'weight', 'pickup_time', 'delivery_time'],
        examples: JSON.stringify([
          '创建一个从北京到上海的订单，重量10吨，明天取货，后天送达',
          '我要从广州发5吨货到深圳，今天下午取货，明天上午送达'
        ])
      },
      {
        name: 'update_order',
        description: '更新订单信息',
        parameters: JSON.stringify([
          { name: 'order_id', type: 'string', required: true, description: '订单ID' },
          { name: 'status', type: 'string', required: false, description: '订单状态' },
          { name: 'weight', type: 'number', required: false, description: '货物重量' },
          { name: 'pickup_time', type: 'date', required: false, description: '取货时间' }
        ]),
        requiredParameters: ['order_id'],
        examples: JSON.stringify([
          '更新订单123的状态为已确认',
          '修改订单456的重量为15吨'
        ])
      },
      {
        name: 'track_order',
        description: '查询订单状态',
        parameters: JSON.stringify([
          { name: 'order_id', type: 'string', required: true, description: '订单ID' }
        ]),
        requiredParameters: ['order_id'],
        examples: JSON.stringify([
          '查询订单123的当前状态',
          '订单456到哪里了？'
        ])
      },
      {
        name: 'assign_vehicle',
        description: '分配车辆到订单',
        parameters: JSON.stringify([
          { name: 'order_id', type: 'string', required: true, description: '订单ID' },
          { name: 'vehicle_id', type: 'string', required: true, description: '车辆ID' }
        ]),
        requiredParameters: ['order_id', 'vehicle_id'],
        examples: JSON.stringify([
          '给订单123分配车辆456',
          '安排车辆788处理订单999'
        ])
      }
    ],
    skipDuplicates: true
  })

  console.log('意图定义创建完成')

  // 创建示例客户
  const customers = await prisma.customer.createMany({
    data: [
      {
        name: 'ABC物流公司',
        contactPerson: '张经理',
        phone: '13800138000',
        email: 'zhang@abc-logistics.com',
        address: '北京市朝阳区建国路1号',
        company: 'ABC物流有限公司',
        creditLimit: 1000000
      },
      {
        name: 'XYZ贸易集团',
        contactPerson: '李总',
        phone: '13900139000',
        email: 'li@xyz-trade.com',
        address: '上海市浦东新区陆家嘴100号',
        company: 'XYZ贸易集团有限公司',
        creditLimit: 2000000
      }
    ],
    skipDuplicates: true
  })

  console.log('示例客户创建完成')

  // 创建示例用户
  const users = await prisma.user.createMany({
    data: [
      {
        email: 'admin@example.com',
        name: '系统管理员',
        role: 'ADMIN'
      },
      {
        email: 'driver1@example.com',
        name: '王司机',
        role: 'DRIVER'
      },
      {
        email: 'manager@example.com',
        name: '刘经理',
        role: 'MANAGER'
      }
    ],
    skipDuplicates: true
  })

  console.log('示例用户创建完成')

  // 创建示例车辆
  const vehicles = await prisma.vehicle.createMany({
    data: [
      {
        licensePlate: '京A12345',
        type: 'TRUCK',
        capacity: 20000,
        driverId: (await prisma.user.findFirst({ where: { email: 'driver1@example.com' } }))?.id || '',
        status: 'AVAILABLE'
      },
      {
        licensePlate: '京B67890',
        type: 'VAN',
        capacity: 5000,
        driverId: (await prisma.user.findFirst({ where: { email: 'driver1@example.com' } }))?.id || '',
        status: 'AVAILABLE'
      }
    ],
    skipDuplicates: true
  })

  console.log('示例车辆创建完成')

  console.log('数据库种子数据初始化完成!')
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

### 3. 创建数据库迁移文件

创建初始迁移:

```bash
npx prisma migrate dev --name init
```

### 4. 创建数据库查询工具

创建`src/lib/db/queries.ts`:

```typescript
import { prisma } from './prisma'
import { OrderStatus, VehicleStatus, ScheduleStatus } from '@prisma/client'

export class OrderQueries {
  static async findAll(filters: {
    status?: OrderStatus
    customerId?: string
    page?: number
    limit?: number
  } = {}) {
    const { status, customerId, page = 1, limit = 20 } = filters
    const skip = (page - 1) * limit

    const [orders, total] = await Promise.all([
      prisma.order.findMany({
        where: {
          status,
          customerId
        },
        include: {
          customer: true,
          assignedVehicle: {
            include: {
              driver: true
            }
          },
          schedules: true
        },
        skip,
        take: limit,
        orderBy: {
          createdAt: 'desc'
        }
      }),
      prisma.order.count({
        where: {
          status,
          customerId
        }
      })
    ])

    return {
      orders,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    }
  }

  static async findById(id: string) {
    return prisma.order.findUnique({
      where: { id },
      include: {
        customer: true,
        assignedVehicle: {
          include: {
            driver: true
          }
        },
        schedules: {
          include: {
            vehicle: {
              include: {
                driver: true
              }
            }
          }
        },
        trackings: {
          orderBy: {
            timestamp: 'desc'
          }
        },
        receipts: true
      }
    })
  }
}

export class VehicleQueries {
  static async findAvailable(filters: {
    type?: string
    minCapacity?: number
  } = {}) {
    const { type, minCapacity } = filters

    return prisma.vehicle.findMany({
      where: {
        status: VehicleStatus.AVAILABLE,
        ...(type && { type: type as any }),
        ...(minCapacity && { capacity: { gte: minCapacity } })
      },
      include: {
        driver: true,
        schedules: {
          where: {
            status: {
              in: [ScheduleStatus.PLANNED, ScheduleStatus.IN_PROGRESS]
            }
          }
        }
      }
    })
  }
}

export class NLCommandQueries {
  static async getCommandHistory(filters: {
    userId?: string
    intent?: string
    limit?: number
  } = {}) {
    const { userId, intent, limit = 50 } = filters

    return prisma.nLCommand.findMany({
      where: {
        userId,
        intent
      },
      include: {
        user: true,
        order: true
      },
      orderBy: {
        createdAt: 'desc'
      },
      take: limit
    })
  }
}
```

## 验证清单

- [ ] 所有实体模型定义完整
- [ ] 关系和约束设置正确
- [ ] 索引优化查询性能
- [ ] 枚举类型定义完整
- [ ] 种子数据创建成功
- [ ] 数据库迁移执行成功
- [ ] 查询工具函数可用

## 测试命令

```bash
# 生成迁移
npx prisma migrate dev --name init

# 推送Schema
npx prisma db push

# 运行种子数据
npm run db:seed

# 验证数据库结构
npx prisma studio

# 检查数据完整性
npm run db:seed
```

## 注意事项

- 确保UUID扩展已安装
- 索引要根据实际查询模式优化
- 种子数据要包含测试所需的各种状态
- 迁移文件要包含适当的回滚逻辑
- 考虑数据分区和归档策略
- 监控数据库性能指标