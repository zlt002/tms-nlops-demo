---
title: "TMS NL-Ops演示系统任务005: 核心依赖包安装和配置验证"
epic: "tms-nlops-demo"
task: "005"
phase: "1"
status: "completed"
priority: "high"
estimated_hours: 2
parallel: true
depends_on: ["001", "002", "003", "004"]
tags: ["dependencies", "packages", "validation", "infrastructure"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T05:45:00Z"
---

## 概述

安装和配置TMS NL-Ops演示系统的所有核心依赖包，包括UI组件、状态管理、API客户端、认证、日期处理等，并验证所有配置正确工作。

## 目标

- 安装所有必要的依赖包
- 配置核心库和插件
- 验证依赖包兼容性
- 测试所有功能正常工作
- 确保开发环境稳定

## 核心依赖分类

### 基础框架
- **Next.js**: 15+ (React框架)
- **React**: 18+ (UI库)
- **TypeScript**: 5+ (类型系统)

### UI和样式
- **Tailwind CSS**: 3+ (实用程序优先的CSS框架)
- **shadcn/ui**: v2 (现代UI组件库)
- **Lucide React**: 图标库
- **Radix UI**: 无障碍组件基础

### 状态管理
- **Zustand**: 轻量级状态管理
- **React Query**: 服务端状态管理

### 数据处理
- **Prisma**: 数据库ORM
- **Zod**: 数据验证

### 工具库
- **Date-fns**: 日期处理
- **Lodash**: 实用工具函数
- **Axios**: HTTP客户端

### 开发工具
- **ESLint**: 代码检查
- **Prettier**: 代码格式化
- **Husky**: Git hooks
- **Commitizen**: 提交规范

## 实施步骤

### 1. 安装核心依赖

```bash
# 基础依赖
npm install zustand @tanstack/react-query axios date-fns lodash @radix-ui/react-slot class-variance-authority clsx tailwind-merge

# 开发依赖
npm install -D @types/lodash eslint-config-prettier prettier husky lint-staged @commitlint/cli @commitlint/config-conventional
```

### 2. 更新package.json

```json
{
  "name": "tms-nlops-demo",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:migrate": "prisma migrate dev",
    "db:studio": "prisma studio",
    "db:seed": "tsx prisma/seed.ts",
    "db:reset": "prisma migrate reset",
    "prepare": "husky install"
  },
  "dependencies": {
    "@prisma/client": "^5.8.1",
    "@radix-ui/react-slot": "^1.0.2",
    "@tanstack/react-query": "^5.17.0",
    "axios": "^1.6.2",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "date-fns": "^2.30.0",
    "lodash": "^4.17.21",
    "lucide-react": "^0.292.0",
    "next": "^15.0.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "tailwind-merge": "^2.0.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.22.4",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@commitlint/cli": "^18.4.4",
    "@commitlint/config-conventional": "^18.4.4",
    "@types/lodash": "^4.14.202",
    "@types/node": "^20.10.5",
    "@types/react": "^18.2.45",
    "@types/react-dom": "^18.2.18",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.56.0",
    "eslint-config-next": "^15.0.0",
    "eslint-config-prettier": "^9.1.0",
    "husky": "^8.0.3",
    "lint-staged": "^15.2.0",
    "postcss": "^8.4.32",
    "prettier": "^3.1.1",
    "prisma": "^5.8.1",
    "tailwindcss": "^3.3.6",
    "tsx": "^4.6.2",
    "typescript": "^5.3.3"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,yml,yaml}": [
      "prettier --write"
    ]
  },
  "husky": {
    "hooks": {
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS",
      "pre-commit": "lint-staged"
    }
  }
}
```

### 3. 配置React Query

创建`src/app/providers.tsx`:

```typescript
'use client'

import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { useState } from 'react'

export default function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 60 * 1000, // 1 minute
            refetchOnWindowFocus: false,
            retry: (failureCount, error) => {
              if (failureCount >= 3) return false
              return true
            }
          }
        }
      })
  )

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )
}
```

更新`src/app/layout.tsx`:

```typescript
import Providers from './providers'
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'TMS NL-Ops 演示系统',
  description: '自然语言操作运输管理系统演示',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body className={inter.className}>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### 4. 配置Zustand状态管理

创建`src/store/index.ts`:

```typescript
import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'

// 用户状态
interface UserState {
  user: any | null
  isAuthenticated: boolean
  setUser: (user: any) => void
  logout: () => void
}

export const useUserStore = create<UserState>()(
  devtools(
    persist(
      (set) => ({
        user: null,
        isAuthenticated: false,
        setUser: (user) => set({ user, isAuthenticated: true }),
        logout: () => set({ user: null, isAuthenticated: false })
      }),
      {
        name: 'user-storage'
      }
    )
  )
)

// 应用状态
interface AppState {
  sidebarOpen: boolean
  theme: 'light' | 'dark'
  notifications: any[]
  toggleSidebar: () => void
  setTheme: (theme: 'light' | 'dark') => void
  addNotification: (notification: any) => void
  removeNotification: (id: string) => void
}

export const useAppStore = create<AppState>()(
  devtools(
    (set) => ({
      sidebarOpen: true,
      theme: 'light',
      notifications: [],
      toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
      setTheme: (theme) => set({ theme }),
      addNotification: (notification) =>
        set((state) => ({
          notifications: [...state.notifications, { ...notification, id: Date.now().toString() }]
        })),
      removeNotification: (id) =>
        set((state) => ({
          notifications: state.notifications.filter(n => n.id !== id)
        }))
    })
  )
)
```

### 5. 配置API客户端

创建`src/lib/api/client.ts`:

```typescript
import axios from 'axios'
import { useUserStore } from '@/store'

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api'

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  }
})

// 请求拦截器
apiClient.interceptors.request.use(
  (config) => {
    // 从store获取token
    const userStore = useUserStore.getState()
    if (userStore.user?.token) {
      config.headers.Authorization = `Bearer ${userStore.user.token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
apiClient.interceptors.response.use(
  (response) => {
    return response
  },
  (error) => {
    if (error.response?.status === 401) {
      // 未授权，清除用户状态
      useUserStore.getState().logout()
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)

// 类型化API函数
export const api = {
  // 订单相关
  orders: {
    list: (params?: any) => apiClient.get('/orders', { params }),
    create: (data: any) => apiClient.post('/orders', data),
    update: (id: string, data: any) => apiClient.put(`/orders/${id}`, data),
    delete: (id: string) => apiClient.delete(`/orders/${id}`),
    get: (id: string) => apiClient.get(`/orders/${id}`),
    track: (id: string) => apiClient.get(`/orders/${id}/track`)
  },

  // 车辆相关
  vehicles: {
    list: (params?: any) => apiClient.get('/vehicles', { params }),
    create: (data: any) => apiClient.post('/vehicles', data),
    update: (id: string, data: any) => apiClient.post(`/vehicles/${id}`, data),
    delete: (id: string) => apiClient.delete(`/vehicles/${id}`),
    get: (id: string) => apiClient.get(`/vehicles/${id}`)
  },

  // NL-Ops相关
  nlops: {
    command: (command: string) => apiClient.post('/nlops/command', { command }),
    history: (params?: any) => apiClient.get('/nlops/history', { params }),
    intents: () => apiClient.get('/nlops/intents')
  },

  // 认证相关
  auth: {
    login: (credentials: any) => apiClient.post('/auth/login', credentials),
    logout: () => apiClient.post('/auth/logout'),
    profile: () => apiClient.get('/auth/profile')
  }
}
```

### 6. 配置日期处理工具

创建`src/lib/utils/date.ts`:

```typescript
import { format, formatDistanceToNow, parseISO, addDays, isAfter, isBefore, differenceInDays } from 'date-fns'
import { zhCN } from 'date-fns/locale'

export const formatDate = (date: Date | string, formatStr = 'yyyy-MM-dd HH:mm:ss') => {
  const dateObj = typeof date === 'string' ? parseISO(date) : date
  return format(dateObj, formatStr, { locale: zhCN })
}

export const formatRelativeTime = (date: Date | string) => {
  const dateObj = typeof date === 'string' ? parseISO(date) : date
  return formatDistanceToNow(dateObj, {
    addSuffix: true,
    locale: zhCN
  })
}

export const isOverdue = (date: Date | string) => {
  const dateObj = typeof date === 'string' ? parseISO(date) : date
  return isAfter(new Date(), dateObj)
}

export const getDaysUntil = (date: Date | string) => {
  const dateObj = typeof date === 'string' ? parseISO(date) : date
  return differenceInDays(dateObj, new Date())
}

export const formatDateTime = {
  short: (date: Date | string) => formatDate(date, 'MM-dd HH:mm'),
  long: (date: Date | string) => formatDate(date, 'yyyy-MM-dd HH:mm:ss'),
  date: (date: Date | string) => formatDate(date, 'yyyy-MM-dd'),
  time: (date: Date | string) => formatDate(date, 'HH:mm:ss')
}
```

### 7. 配置验证工具

创建`src/lib/validators/index.ts`:

```typescript
import { z } from 'zod'

// 订单验证
export const createOrderSchema = z.object({
  customerId: z.string().uuid('无效的客户ID'),
  origin: z.string().min(1, '起始地点不能为空'),
  destination: z.string().min(1, '目的地不能为空'),
  weight: z.number().positive('重量必须大于0'),
  volume: z.number().positive('体积必须大于0').optional(),
  value: z.number().positive('货物价值必须大于0').optional(),
  pickupTime: z.date('取货时间格式错误'),
  deliveryTime: z.date('送达时间格式错误'),
  specialInstructions: z.string().optional()
}).refine(data => data.deliveryTime > data.pickupTime, {
  message: '送达时间必须晚于取货时间',
  path: ['deliveryTime']
})

// 车辆验证
export const createVehicleSchema = z.object({
  licensePlate: z.string().min(1, '车牌号不能为空'),
  type: z.enum(['TRUCK', 'VAN', 'TRAILER'], {
    errorMap: () => ({ message: '无效的车辆类型' })
  }),
  capacity: z.number().positive('载重量必须大于0'),
  driverId: z.string().uuid('无效的驾驶员ID')
})

// NL命令验证
export const nlCommandSchema = z.object({
  command: z.string().min(1, '命令不能为空'),
  intent: z.string().min(1, '意图不能为空'),
  parameters: z.record(z.any()).optional()
})

// 类型导出
export type CreateOrderInput = z.infer<typeof createOrderSchema>
export type CreateVehicleInput = z.infer<typeof createVehicleSchema>
export type NLCommandInput = z.infer<typeof nlCommandSchema>
```

### 8. 配置工具函数

创建`src/lib/utils/helpers.ts`:

```typescript
import _ from 'lodash'

// 防抖函数
export const debounce = <T extends (...args: any[]) => any>(
  func: T,
  wait: number
): ((...args: Parameters<T>) => void) => {
  return _.debounce(func, wait)
}

// 节流函数
export const throttle = <T extends (...args: any[]) => any>(
  func: T,
  wait: number
): ((...args: Parameters<T>) => void) => {
  return _.throttle(func, wait)
}

// 深拷贝
export const deepClone = <T>(obj: T): T => {
  return _.cloneDeep(obj)
}

// 获取嵌套对象属性
export const getNestedValue = (obj: any, path: string, defaultValue?: any) => {
  return _.get(obj, path, defaultValue)
}

// 设置嵌套对象属性
export const setNestedValue = (obj: any, path: string, value: any) => {
  return _.set(obj, path, value)
}

// 格式化文件大小
export const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 Bytes'

  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))

  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

// 格式化货币
export const formatCurrency = (amount: number, currency = 'CNY'): string => {
  return new Intl.NumberFormat('zh-CN', {
    style: 'currency',
    currency
  }).format(amount)
}

// 生成唯一ID
export const generateId = (): string => {
  return Math.random().toString(36).substr(2, 9)
}

// 错误处理包装器
export const withErrorHandling = async <T>(
  fn: () => Promise<T>,
  errorHandler?: (error: Error) => void
): Promise<T | null> => {
  try {
    return await fn()
  } catch (error) {
    console.error('Error:', error)
    if (errorHandler) {
      errorHandler(error as Error)
    }
    return null
  }
}
```

### 9. 创建测试验证脚本

创建`scripts/validate-deps.js`:

```javascript
const { execSync } = require('child_process')
const fs = require('fs')
const path = require('path')

function validateDependencies() {
  console.log('开始验证依赖包安装...')

  try {
    // 检查package.json
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'))
    const dependencies = Object.keys(packageJson.dependencies || {})
    const devDependencies = Object.keys(packageJson.devDependencies || {})

    console.log(`生产依赖: ${dependencies.length}个`)
    console.log(`开发依赖: ${devDependencies.length}个`)

    // 验证安装
    console.log('验证依赖包安装...')
    execSync('npm list --depth=0', { stdio: 'inherit' })

    // 类型检查
    console.log('运行TypeScript类型检查...')
    execSync('npm run type-check', { stdio: 'inherit' })

    // ESLint检查
    console.log('运行ESLint检查...')
    execSync('npm run lint', { stdio: 'inherit' })

    // 构建测试
    console.log('测试构建...')
    execSync('npm run build', { stdio: 'inherit' })

    console.log('✅ 所有依赖包验证通过!')

  } catch (error) {
    console.error('❌ 依赖包验证失败:', error.message)
    process.exit(1)
  }
}

validateDependencies()
```

## 验证清单

- [ ] 所有核心依赖包安装成功
- [ ] React Query配置正确
- [ ] Zustand状态管理工作正常
- [ ] API客户端配置完整
- [ ] 日期处理工具可用
- [ ] 验证工具配置正确
- [ ] 工具函数库集成成功
- [ ] TypeScript类型检查通过
- [ ] 构建过程无错误
- [ ] 开发服务器启动正常

## 测试命令

```bash
# 安装所有依赖
npm install

# 类型检查
npm run type-check

# 代码检查
npm run lint

# 格式化检查
npm run format:check

# 构建测试
npm run build

# 启动开发服务器
npm run dev

# 运行依赖验证
node scripts/validate-deps.js
```

## 注意事项

- 确保所有依赖版本兼容
- 定期更新依赖包版本
- 监控安全漏洞
- 测试不同环境的兼容性
- 备份package.json和package-lock.json
- 考虑使用依赖锁定文件确保一致性