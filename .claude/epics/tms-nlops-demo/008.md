---
title: "TMS NL-Ops演示系统任务008: 订单管理API实现"
epic: "tms-nlops-demo"
task: "008"
phase: "2"
status: "completed"
priority: "high"
estimated_hours: 4
parallel: true
depends_on: ["001", "002", "003", "004", "005", "006", "007"]
tags: ["api", "orders", "backend", "typescript"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T09:30:00Z"
---

## 概述

实现订单管理相关的API接口，包括订单的创建、查询、更新和删除操作。基于Phase 1完成的基础设施，构建完整的订单管理RESTful API。

## 目标

- 实现订单CRUD操作的API接口
- 创建订单数据模型和类型定义
- 实现订单状态管理逻辑
- 集成数据验证和错误处理
- 提供订单查询和筛选功能

## 技术栈

- **框架**: Next.js 15+ API Routes
- **语言**: TypeScript
- **数据库**: PostgreSQL (通过Prisma)
- **验证**: Zod schema validation
- **API**: RESTful设计模式

## 实施步骤

### 1. 创建订单数据模型

更新`prisma/schema.prisma`:

```prisma
model Order {
  id          String   @id @default(cuid())
  orderNumber String   @unique
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  // 货物信息
  cargoName     String
  cargoWeight   Float
  cargoVolume   Float
  cargoValue    Float?

  // 运输信息
  originAddress      String
  destinationAddress String
  originContact      String
  destinationContact String

  // 时间信息
  pickupTime    DateTime?
  deliveryTime  DateTime?
  expectedTime  DateTime

  // 订单状态
  status        OrderStatus @default(PENDING)
  priority      Priority    @default(MEDIUM)

  // 费用信息
  totalAmount   Float
  paymentStatus PaymentStatus @default(UNPAID)

  // 元数据
  notes         String?
  createdBy     String
  updatedBy     String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // 关联关系
  shipments     Shipment[]
  documents     Document[]
  trackingLogs  TrackingLog[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
}
```

### 2. 创建订单类型定义

创建`src/types/order.ts`:

```typescript
import { OrderStatus, Priority, PaymentStatus } from '@prisma/client'

export interface Order {
  id: string
  orderNumber: string
  customerId: string
  cargoName: string
  cargoWeight: number
  cargoVolume: number
  cargoValue?: number
  originAddress: string
  destinationAddress: string
  originContact: string
  destinationContact: string
  pickupTime?: Date
  deliveryTime?: Date
  expectedTime: Date
  status: OrderStatus
  priority: Priority
  totalAmount: number
  paymentStatus: PaymentStatus
  notes?: string
  createdBy: string
  updatedBy: string
  createdAt: Date
  updatedAt: Date
}

export interface CreateOrderRequest {
  customerId: string
  cargoName: string
  cargoWeight: number
  cargoVolume: number
  cargoValue?: number
  originAddress: string
  destinationAddress: string
  originContact: string
  destinationContact: string
  pickupTime?: Date
  expectedTime: Date
  priority?: Priority
  notes?: string
}

export interface UpdateOrderRequest {
  cargoName?: string
  cargoWeight?: number
  cargoVolume?: number
  cargoValue?: number
  originAddress?: string
  destinationAddress?: string
  originContact?: string
  destinationContact?: string
  pickupTime?: Date
  deliveryTime?: Date
  expectedTime?: Date
  status?: OrderStatus
  priority?: Priority
  totalAmount?: number
  paymentStatus?: PaymentStatus
  notes?: string
}

export interface OrderQueryParams {
  customerId?: string
  status?: OrderStatus
  priority?: Priority
  startDate?: Date
  endDate?: Date
  page?: number
  limit?: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### 3. 创建订单验证Schema

创建`src/validations/order.ts`:

```typescript
import { z } from 'zod'
import { OrderStatus, Priority, PaymentStatus } from '@prisma/client'

const cargoSchema = z.object({
  name: z.string().min(1, '货物名称不能为空'),
  weight: z.number().positive('货物重量必须大于0'),
  volume: z.number().positive('货物体积必须大于0'),
  value: z.number().optional()
})

const addressSchema = z.object({
  origin: z.string().min(1, '发货地址不能为空'),
  destination: z.string().min(1, '收货地址不能为空'),
  originContact: z.string().min(1, '发货联系人不能为空'),
  destinationContact: z.string().min(1, '收货联系人不能为空')
})

export const createOrderSchema = z.object({
  customerId: z.string().min(1, '客户ID不能为空'),
  cargo: cargoSchema,
  addresses: addressSchema,
  pickupTime: z.date().optional(),
  expectedTime: z.date('期望送达时间不能为空'),
  priority: z.nativeEnum(Priority).optional(),
  notes: z.string().optional()
})

export const updateOrderSchema = z.object({
  cargo: cargoSchema.partial(),
  addresses: addressSchema.partial(),
  pickupTime: z.date().optional(),
  deliveryTime: z.date().optional(),
  expectedTime: z.date().optional(),
  status: z.nativeEnum(OrderStatus).optional(),
  priority: z.nativeEnum(Priority).optional(),
  totalAmount: z.number().positive('总金额必须大于0').optional(),
  paymentStatus: z.nativeEnum(PaymentStatus).optional(),
  notes: z.string().optional()
})

export const orderQuerySchema = z.object({
  customerId: z.string().optional(),
  status: z.nativeEnum(OrderStatus).optional(),
  priority: z.nativeEnum(Priority).optional(),
  startDate: z.date().optional(),
  endDate: z.date().optional(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(20),
  sortBy: z.string().default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc')
})
```

### 4. 实现订单API路由

创建`src/app/api/orders/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { orderQuerySchema } from '@/validations/order'
import { getCurrentUser } from '@/lib/auth'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const searchParams = request.nextUrl.searchParams
    const query = {
      customerId: searchParams.get('customerId') || undefined,
      status: searchParams.get('status') || undefined,
      priority: searchParams.get('priority') || undefined,
      startDate: searchParams.get('startDate') ? new Date(searchParams.get('startDate')!) : undefined,
      endDate: searchParams.get('endDate') ? new Date(searchParams.get('endDate')!) : undefined,
      page: parseInt(searchParams.get('page') || '1'),
      limit: parseInt(searchParams.get('limit') || '20'),
      sortBy: searchParams.get('sortBy') || 'createdAt',
      sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') || 'desc'
    }

    const validatedQuery = orderQuerySchema.parse(query)

    const where: any = {}
    if (validatedQuery.customerId) where.customerId = validatedQuery.customerId
    if (validatedQuery.status) where.status = validatedQuery.status
    if (validatedQuery.priority) where.priority = validatedQuery.priority
    if (validatedQuery.startDate || validatedQuery.endDate) {
      where.createdAt = {}
      if (validatedQuery.startDate) where.createdAt.gte = validatedQuery.startDate
      if (validatedQuery.endDate) where.createdAt.lte = validatedQuery.endDate
    }

    const [orders, total] = await Promise.all([
      prisma.order.findMany({
        where,
        include: {
          customer: true,
          shipments: {
            include: {
              vehicle: true,
              driver: true
            }
          },
          documents: true
        },
        skip: (validatedQuery.page - 1) * validatedQuery.limit,
        take: validatedQuery.limit,
        orderBy: {
          [validatedQuery.sortBy]: validatedQuery.sortOrder
        }
      }),
      prisma.order.count({ where })
    ])

    return NextResponse.json({
      success: true,
      data: orders,
      pagination: {
        page: validatedQuery.page,
        limit: validatedQuery.limit,
        total,
        pages: Math.ceil(total / validatedQuery.limit)
      }
    })
  } catch (error) {
    console.error('获取订单列表失败:', error)
    return NextResponse.json(
      { error: '获取订单列表失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = createOrderSchema.parse(body)

    // 生成订单号
    const orderNumber = generateOrderNumber()

    const order = await prisma.order.create({
      data: {
        orderNumber,
        customerId: validatedData.customerId,
        cargoName: validatedData.cargo.name,
        cargoWeight: validatedData.cargo.weight,
        cargoVolume: validatedData.cargo.volume,
        cargoValue: validatedData.cargo.value,
        originAddress: validatedData.addresses.origin,
        destinationAddress: validatedData.addresses.destination,
        originContact: validatedData.addresses.originContact,
        destinationContact: validatedData.addresses.destinationContact,
        pickupTime: validatedData.pickupTime,
        expectedTime: validatedData.expectedTime,
        priority: validatedData.priority || Priority.MEDIUM,
        status: OrderStatus.PENDING,
        totalAmount: 0, // 计算逻辑后续实现
        paymentStatus: PaymentStatus.UNPAID,
        notes: validatedData.notes,
        createdBy: user.id,
        updatedBy: user.id
      },
      include: {
        customer: true
      }
    })

    return NextResponse.json({
      success: true,
      data: order,
      message: '订单创建成功'
    }, { status: 201 })
  } catch (error) {
    console.error('创建订单失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '创建订单失败', details: error.message },
      { status: 500 }
    )
  }
}

function generateOrderNumber(): string {
  const timestamp = Date.now().toString()
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `ORD${timestamp.slice(-6)}${random}`
}
```

### 5. 实现单个订单操作路由

创建`src/app/api/orders/[id]/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { updateOrderSchema } from '@/validations/order'
import { getCurrentUser } from '@/lib/auth'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const order = await prisma.order.findUnique({
      where: { id: params.id },
      include: {
        customer: true,
        shipments: {
          include: {
            vehicle: true,
            driver: true
          }
        },
        documents: true,
        trackingLogs: {
          orderBy: { createdAt: 'desc' }
        }
      }
    })

    if (!order) {
      return NextResponse.json(
        { error: '订单不存在' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      success: true,
      data: order
    })
  } catch (error) {
    console.error('获取订单详情失败:', error)
    return NextResponse.json(
      { error: '获取订单详情失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const body = await request.json()
    const validatedData = updateOrderSchema.parse(body)

    const existingOrder = await prisma.order.findUnique({
      where: { id: params.id }
    })

    if (!existingOrder) {
      return NextResponse.json(
        { error: '订单不存在' },
        { status: 404 }
      )
    }

    const updateData: any = {
      updatedBy: user.id,
      updatedAt: new Date()
    }

    if (validatedData.cargo) {
      updateData.cargoName = validatedData.cargo.name
      updateData.cargoWeight = validatedData.cargo.weight
      updateData.cargoVolume = validatedData.cargo.volume
      updateData.cargoValue = validatedData.cargo.value
    }

    if (validatedData.addresses) {
      if (validatedData.addresses.origin) updateData.originAddress = validatedData.addresses.origin
      if (validatedData.addresses.destination) updateData.destinationAddress = validatedData.addresses.destination
      if (validatedData.addresses.originContact) updateData.originContact = validatedData.addresses.originContact
      if (validatedData.addresses.destinationContact) updateData.destinationContact = validatedData.addresses.destinationContact
    }

    if (validatedData.pickupTime !== undefined) updateData.pickupTime = validatedData.pickupTime
    if (validatedData.deliveryTime !== undefined) updateData.deliveryTime = validatedData.deliveryTime
    if (validatedData.expectedTime !== undefined) updateData.expectedTime = validatedData.expectedTime
    if (validatedData.status !== undefined) updateData.status = validatedData.status
    if (validatedData.priority !== undefined) updateData.priority = validatedData.priority
    if (validatedData.totalAmount !== undefined) updateData.totalAmount = validatedData.totalAmount
    if (validatedData.paymentStatus !== undefined) updateData.paymentStatus = validatedData.paymentStatus
    if (validatedData.notes !== undefined) updateData.notes = validatedData.notes

    const updatedOrder = await prisma.order.update({
      where: { id: params.id },
      data: updateData,
      include: {
        customer: true,
        shipments: {
          include: {
            vehicle: true,
            driver: true
          }
        },
        documents: true
      }
    })

    return NextResponse.json({
      success: true,
      data: updatedOrder,
      message: '订单更新成功'
    })
  } catch (error) {
    console.error('更新订单失败:', error)
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '数据验证失败', details: error.errors },
        { status: 400 }
      )
    }
    return NextResponse.json(
      { error: '更新订单失败', details: error.message },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const order = await prisma.order.findUnique({
      where: { id: params.id }
    })

    if (!order) {
      return NextResponse.json(
        { error: '订单不存在' },
        { status: 404 }
      )
    }

    if (order.status !== OrderStatus.PENDING) {
      return NextResponse.json(
        { error: '只有待处理的订单才能删除' },
        { status: 400 }
      )
    }

    await prisma.order.delete({
      where: { id: params.id }
    })

    return NextResponse.json({
      success: true,
      message: '订单删除成功'
    })
  } catch (error) {
    console.error('删除订单失败:', error)
    return NextResponse.json(
      { error: '删除订单失败', details: error.message },
      { status: 500 }
    )
  }
}
```

### 6. 创建订单服务层

创建`src/services/orderService.ts`:

```typescript
import { prisma } from '@/lib/prisma'
import { OrderStatus, Priority } from '@prisma/client'

export class OrderService {
  static async calculateOrderTotal(orderData: any): Promise<number> {
    // 基础运费计算逻辑
    const baseRate = 5 // 每公里基础费率
    const distance = await this.calculateDistance(
      orderData.originAddress,
      orderData.destinationAddress
    )

    const weightRate = orderData.cargoWeight * 0.5
    const volumeRate = orderData.cargoVolume * 2

    let total = (distance * baseRate) + weightRate + volumeRate

    // 根据优先级调整价格
    const priorityMultiplier = {
      [Priority.LOW]: 0.9,
      [Priority.MEDIUM]: 1.0,
      [Priority.HIGH]: 1.2,
      [Priority.URGENT]: 1.5
    }

    total *= priorityMultiplier[orderData.priority || Priority.MEDIUM]

    return Math.round(total * 100) / 100
  }

  static async updateOrderStatus(orderId: string, status: OrderStatus, userId: string) {
    const order = await prisma.order.findUnique({
      where: { id: orderId }
    })

    if (!order) {
      throw new Error('订单不存在')
    }

    const validTransitions = {
      [OrderStatus.PENDING]: [OrderStatus.CONFIRMED, OrderStatus.CANCELLED],
      [OrderStatus.CONFIRMED]: [OrderStatus.IN_TRANSIT, OrderStatus.CANCELLED],
      [OrderStatus.IN_TRANSIT]: [OrderStatus.DELIVERED, OrderStatus.RETURNED],
      [OrderStatus.DELIVERED]: [],
      [OrderStatus.CANCELLED]: [],
      [OrderStatus.RETURNED]: [OrderStatus.IN_TRANSIT]
    }

    if (!validTransitions[order.status].includes(status)) {
      throw new Error(`无法从 ${order.status} 转换到 ${status}`)
    }

    const updatedOrder = await prisma.order.update({
      where: { id: orderId },
      data: {
        status,
        updatedBy: userId,
        updatedAt: new Date()
      }
    })

    return updatedOrder
  }

  private static async calculateDistance(origin: string, destination: string): Promise<number> {
    // 简化版距离计算，实际应该使用地图API
    return Math.random() * 500 + 50 // 返回50-550公里之间的随机距离
  }

  static async getOrdersByCustomerId(customerId: string, params: any = {}) {
    const { page = 1, limit = 20, status, sortBy = 'createdAt', sortOrder = 'desc' } = params

    const where: any = { customerId }
    if (status) where.status = status

    const [orders, total] = await Promise.all([
      prisma.order.findMany({
        where,
        include: {
          shipments: {
            include: {
              vehicle: true,
              driver: true
            }
          },
          documents: true
        },
        skip: (page - 1) * limit,
        take: limit,
        orderBy: {
          [sortBy]: sortOrder
        }
      }),
      prisma.order.count({ where })
    ])

    return {
      orders,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    }
  }
}
```

## 验证清单

- [ ] 订单数据模型定义正确
- [ ] API路由实现完整
- [ ] 数据验证Schema有效
- [ ] 订单创建功能正常
- [ ] 订单查询功能正常
- [ ] 订单更新功能正常
- [ ] 订单删除功能正常
- [ ] 状态流转逻辑正确
- [ ] 服务层功能完整
- [ ] 错误处理机制完善

## 测试命令

```bash
# 运行API测试
npm run test:api

# 数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

## 注意事项

- 确保数据库连接配置正确
- 订单状态流转需要符合业务逻辑
- 价格计算逻辑需要根据实际业务需求调整
- 权限验证需要与认证系统集成
- 分页查询需要优化大数据量性能