---
title: "TMS NL-Ops演示系统任务015: API文档生成和测试"
epic: "tms-nlops-demo"
task: "015"
phase: "2"
status: completed
priority: "high"
estimated_hours: 2
parallel: true
depends_on: ["001", "002", "003", "004", "005", "006", "007"]
tags: ["documentation", "testing", "api", "backend", "typescript"]
created: "2025-09-20T04:20:45Z"
updated: "2025-09-20T04:20:45Z"
---

## 概述

实现API文档生成和测试功能，为TMS NL-Ops演示系统提供完整的API文档和自动化测试。构建开发者友好的API文档和测试套件。

## 目标

- 生成完整的API文档
- 创建API测试套件
- 提供交互式API测试界面
- 实现API性能测试
- 提供API示例代码

## 技术栈

- **文档**: Swagger/OpenAPI 3.0
- **测试**: Jest + Supertest
- **文档生成**: swagger-jsdoc
- **交互界面**: Swagger UI
- **性能测试**: Artillery
- **代码示例**: 自动生成器

## 实施步骤

### 1. 创建OpenAPI配置

创建`src/docs/openapi.ts`:

```typescript
import { OpenAPIV3 } from 'openapi-types'

export const openApiSpec: OpenAPIV3.Document = {
  openapi: '3.0.0',
  info: {
    title: 'TMS NL-Ops演示系统 API',
    version: '1.0.0',
    description: '运输管理系统自然语言操作演示系统API文档',
    contact: {
      name: 'API Support',
      email: 'support@tms-nlops.com'
    },
    license: {
      name: 'MIT',
      url: 'https://opensource.org/licenses/MIT'
    }
  },
  servers: [
    {
      url: process.env.NODE_ENV === 'production'
        ? 'https://api.tms-nlops.com'
        : 'http://localhost:3000/api',
      description: process.env.NODE_ENV === 'production' ? 'Production Server' : 'Development Server'
    }
  ],
  components: {
    securitySchemes: {
      BearerAuth: {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT'
      },
      ApiKeyAuth: {
        type: 'apiKey',
        in: 'header',
        name: 'X-API-Key'
      }
    },
    schemas: {
      // 通用响应模式
      ApiResponse: {
        type: 'object',
        properties: {
          success: {
            type: 'boolean',
            description: '请求是否成功'
          },
          data: {
            type: 'object',
            description: '响应数据'
          },
          error: {
            type: 'string',
            description: '错误信息'
          },
          code: {
            type: 'string',
            description: '错误代码'
          },
          details: {
            type: 'object',
            description: '错误详情'
          },
          message: {
            type: 'string',
            description: '响应消息'
          },
          timestamp: {
            type: 'string',
            format: 'date-time',
            description: '响应时间戳'
          }
        }
      },
      // 分页响应模式
      PaginatedResponse: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          data: {
            type: 'array',
            items: { type: 'object' }
          },
          pagination: {
            type: 'object',
            properties: {
              page: { type: 'integer' },
              limit: { type: 'integer' },
              total: { type: 'integer' },
              pages: { type: 'integer' }
            }
          },
          message: { type: 'string' },
          timestamp: { type: 'string', format: 'date-time' }
        }
      },
      // 错误响应模式
      ErrorResponse: {
        type: 'object',
        properties: {
          success: { type: 'boolean', example: false },
          error: { type: 'string' },
          code: { type: 'string' },
          details: { type: 'object' },
          timestamp: { type: 'string', format: 'date-time' }
        }
      }
    }
  },
  tags: [
    {
      name: '订单管理',
      description: '订单相关操作'
    },
    {
      name: '客户管理',
      description: '客户相关操作'
    },
    {
      name: '车辆管理',
      description: '车辆相关操作'
    },
    {
      name: '调度管理',
      description: '调度相关操作'
    },
    {
      name: '在途跟踪',
      description: '在途跟踪相关操作'
    },
    {
      name: '回单管理',
      description: '回单管理相关操作'
    },
    {
      name: '系统管理',
      description: '系统管理相关操作'
    }
  ],
  paths: {}
}
```

### 2. 创建API文档生成器

创建`src/docs/generator.ts`:

```typescript
import { openApiSpec } from './openapi'
import { writeFileSync } from 'fs'
import { join } from 'path'

export class ApiDocumentationGenerator {
  private spec: any = openApiSpec

  addPath(path: string, method: string, config: any): void {
    if (!this.spec.paths[path]) {
      this.spec.paths[path] = {}
    }

    this.spec.paths[path][method.toLowerCase()] = {
      ...config,
      tags: config.tags || ['通用']
    }
  }

  addSchema(name: string, schema: any): void {
    if (!this.spec.components.schemas) {
      this.spec.components.schemas = {}
    }
    this.spec.components.schemas[name] = schema
  }

  generateDocs(): void {
    // 生成OpenAPI JSON文件
    const outputPath = join(process.cwd(), 'public', 'api-docs', 'openapi.json')
    writeFileSync(outputPath, JSON.stringify(this.spec, null, 2))

    // 生成Markdown文档
    this.generateMarkdownDocs()
  }

  private generateMarkdownDocs(): void {
    const markdown = this.generateMarkdownContent()
    const outputPath = join(process.cwd(), 'API_DOCS.md')
    writeFileSync(outputPath, markdown)
  }

  private generateMarkdownContent(): string {
    let content = `# TMS NL-Ops演示系统 API文档

## 概述

TMS NL-Ops演示系统提供完整的运输管理API接口，支持自然语言操作和传统API调用。

## 基础信息

- **基础URL**: \`${this.spec.servers[0].url}\`
- **版本**: ${this.spec.info.version}
- **认证方式**: Bearer Token, API Key

## 认证

### Bearer Token
\`\`\`bash
Authorization: Bearer <your-jwt-token>
\`\`\`

### API Key
\`\`\`bash
X-API-Key: <your-api-key>
\`\`\`

## 错误响应格式

所有API错误响应都遵循以下格式：

\`\`\`json
{
  "success": false,
  "error": "错误信息",
  "code": "ERROR_CODE",
  "details": {},
  "timestamp": "2024-01-01T00:00:00Z"
}
\`\`\`

## API端点

`

    // 生成各个端点的文档
    for (const [path, methods] of Object.entries(this.spec.paths)) {
      content += `### ${path}\n\n`

      for (const [method, config] of Object.entries(methods as any)) {
        const methodUpper = method.toUpperCase()
        content += `#### ${methodUpper} ${path}\n\n`

        if (config.summary) {
          content += `**摘要**: ${config.summary}\n\n`
        }

        if (config.description) {
          content += `**描述**: ${config.description}\n\n`
        }

        content += `**认证**: ${config.security ? '需要' : '不需要'}\n\n`

        if (config.parameters && config.parameters.length > 0) {
          content += `**参数**:\n\n`
          content += `| 参数名 | 位置 | 类型 | 必需 | 描述 |\n`
          content += `|--------|------|------|------|------|\n`

          for (const param of config.parameters) {
            content += `| ${param.name} | ${param.in} | ${param.schema.type} | ${param.required ? '是' : '否'} | ${param.description || '-'} |\n`
          }
          content += '\n'
        }

        if (config.requestBody) {
          content += `**请求体**:\n\n`
          content += `\`\`\`json\n${JSON.stringify(config.requestBody.content['application/json'].schema, null, 2)}\n\`\`\`\n\n`
        }

        if (config.responses) {
          content += `**响应**:\n\n`
          for (const [statusCode, response] of Object.entries(config.responses)) {
            content += `**${statusCode}**:\n\n`
            if (response.description) {
              content += `${response.description}\n\n`
            }
            if (response.content && response.content['application/json']) {
              content += `\`\`\`json\n${JSON.stringify(response.content['application/json'].schema, null, 2)}\n\`\`\`\n\n`
            }
          }
        }

        if (config.examples) {
          content += `**示例**:\n\n`
          content += `\`\`\`bash\n${config.examples.request}\n\`\`\`\n\n`
          if (config.examples.response) {
            content += `\`\`\`json\n${JSON.stringify(JSON.parse(config.examples.response), null, 2)}\n\`\`\`\n\n`
          }
        }

        content += '---\n\n'
      }
    }

    return content
  }
}

// 全局实例
export const apiDocGenerator = new ApiDocumentationGenerator()
```

### 3. 创建Swagger UI页面

创建`src/app/api-docs/page.tsx`:

```typescript
'use client'

import { useEffect, useState } from 'react'
import SwaggerUI from 'swagger-ui-react'
import 'swagger-ui-react/swagger-ui.css'
import { openApiSpec } from '@/docs/openapi'

export default function ApiDocsPage() {
  const [spec, setSpec] = useState<any>(null)

  useEffect(() => {
    // 动态导入Swagger UI样式
    const loadSwaggerUI = async () => {
      try {
        const response = await fetch('/api-docs/openapi.json')
        const apiSpec = await response.json()
        setSpec(apiSpec)
      } catch (error) {
        console.error('加载API文档失败:', error)
        setSpec(openApiSpec)
      }
    }

    loadSwaggerUI()
  }, [])

  if (!spec) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">正在加载API文档...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">TMS NL-Ops API文档</h1>
              <p className="text-sm text-gray-600">运输管理系统自然语言操作演示系统</p>
            </div>
            <div className="flex space-x-4">
              <a
                href="/api-docs/openapi.json"
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                download
              >
                下载OpenAPI规范
              </a>
              <a
                href="/API_DOCS.md"
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                download
              >
                下载Markdown文档
              </a>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto">
        <SwaggerUI spec={spec} />
      </div>
    </div>
  )
}
```

### 4. 创建API测试套件

创建`tests/api.test.ts`:

```typescript
import request from 'supertest'
import app from '../src/app' // 需要导出Express应用

describe('TMS NL-Ops API测试', () => {
  let authToken: string
  let orderId: string
  let customerId: string
  let vehicleId: string

  beforeAll(async () => {
    // 测试前的准备工作
    // 1. 创建测试用户并获取认证token
    const loginResponse = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'test@example.com',
        password: 'password123'
      })

    authToken = loginResponse.body.data.token
  })

  describe('认证测试', () => {
    test('未认证请求应该返回401', async () => {
      const response = await request(app)
        .get('/api/orders')

      expect(response.status).toBe(401)
    })

    test('无效token应该返回401', async () => {
      const response = await request(app)
        .get('/api/orders')
        .set('Authorization', 'Bearer invalid-token')

      expect(response.status).toBe(401)
    })
  })

  describe('订单管理API测试', () => {
    test('GET /api/orders - 获取订单列表', async () => {
      const response = await request(app)
        .get('/api/orders')
        .set('Authorization', `Bearer ${authToken}`)
        .query({ page: 1, limit: 10 })

      expect(response.status).toBe(200)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
      expect(response.body.pagination).toBeDefined()
    })

    test('POST /api/orders - 创建订单', async () => {
      const orderData = {
        customerId: 'test-customer-id',
        cargoName: '测试货物',
        cargoWeight: 1000,
        cargoVolume: 10,
        originAddress: '北京市朝阳区',
        destinationAddress: '上海市浦东新区',
        expectedTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
      }

      const response = await request(app)
        .post('/api/orders')
        .set('Authorization', `Bearer ${authToken}`)
        .send(orderData)

      expect(response.status).toBe(201)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()

      orderId = response.body.data.id
    })

    test('GET /api/orders/:id - 获取订单详情', async () => {
      const response = await request(app)
        .get(`/api/orders/${orderId}`)
        .set('Authorization', `Bearer ${authToken}`)

      expect(response.status).toBe(200)
      expect(response.body.success).toBe(true)
      expect(response.body.data.id).toBe(orderId)
    })

    test('PUT /api/orders/:id - 更新订单', async () => {
      const updateData = {
        cargoName: '更新的货物名称'
      }

      const response = await request(app)
        .put(`/api/orders/${orderId}`)
        .set('Authorization', `Bearer ${authToken}`)
        .send(updateData)

      expect(response.status).toBe(200)
      expect(response.body.success).toBe(true)
      expect(response.body.data.cargoName).toBe(updateData.cargoName)
    })
  })

  describe('客户管理API测试', () => {
    test('GET /api/customers - 获取客户列表', async () => {
      const response = await request(app)
        .get('/api/customers')
        .set('Authorization', `Bearer ${authToken}`)
        .query({ page: 1, limit: 10 })

      expect(response.status).toBe(200)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
    })

    test('POST /api/customers - 创建客户', async () => {
      const customerData = {
        customerType: 'COMPANY',
        companyName: '测试公司',
        email: 'test@company.com',
        phone: '13800138000',
        address: '北京市朝阳区',
        city: '北京市',
        province: '北京'
      }

      const response = await request(app)
        .post('/api/customers')
        .set('Authorization', `Bearer ${authToken}`)
        .send(customerData)

      expect(response.status).toBe(201)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()

      customerId = response.body.data.id
    })
  })

  describe('车辆管理API测试', () => {
    test('GET /api/vehicles - 获取车辆列表', async () => {
      const response = await request(app)
        .get('/api/vehicles')
        .set('Authorization', `Bearer ${authToken}`)
        .query({ page: 1, limit: 10 })

      expect(response.status).toBe(200)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()
    })

    test('POST /api/vehicles - 创建车辆', async () => {
      const vehicleData = {
        licenseNumber: '京A12345',
        vinNumber: 'VIN123456789012345',
        brand: '东风',
        model: '天龙',
        year: 2023,
        vehicleType: 'TRUCK',
        maxLoad: 25,
        maxVolume: 50,
        dailyRate: 1000
      }

      const response = await request(app)
        .post('/api/vehicles')
        .set('Authorization', `Bearer ${authToken}`)
        .send(vehicleData)

      expect(response.status).toBe(201)
      expect(response.body.success).toBe(true)
      expect(response.body.data).toBeDefined()

      vehicleId = response.body.data.id
    })
  })

  describe('在途跟踪API测试', () => {
    test('POST /api/tracking/logs - 上报位置', async () => {
      const trackingData = {
        shipmentId: 'test-shipment-id',
        latitude: 39.9042,
        longitude: 116.4074,
        address: '北京市朝阳区',
        speed: 60,
        heading: 90
      }

      const response = await request(app)
        .post('/api/tracking/logs')
        .set('Authorization', `Bearer ${authToken}`)
        .send(trackingData)

      expect(response.status).toBe(201)
      expect(response.body.success).toBe(true)
    })
  })

  describe('错误处理测试', () => {
    test('无效ID应该返回404', async () => {
      const response = await request(app)
        .get('/api/orders/invalid-id')
        .set('Authorization', `Bearer ${authToken}`)

      expect(response.status).toBe(404)
    })

    test('无效数据应该返回400', async () => {
      const invalidOrderData = {
        // 缺少必需字段
        cargoName: '测试货物'
      }

      const response = await request(app)
        .post('/api/orders')
        .set('Authorization', `Bearer ${authToken}`)
        .send(invalidOrderData)

      expect(response.status).toBe(400)
    })
  })

  describe('性能测试', () => {
    test('API响应时间应该在合理范围内', async () => {
      const startTime = Date.now()

      await request(app)
        .get('/api/orders')
        .set('Authorization', `Bearer ${authToken}`)
        .query({ page: 1, limit: 10 })

      const responseTime = Date.now() - startTime
      expect(responseTime).toBeLessThan(1000) // 响应时间应该小于1秒
    })
  })

  afterAll(async () => {
    // 测试后的清理工作
    if (orderId) {
      await request(app)
        .delete(`/api/orders/${orderId}`)
        .set('Authorization', `Bearer ${authToken}`)
    }

    if (customerId) {
      await request(app)
        .delete(`/api/customers/${customerId}`)
        .set('Authorization', `Bearer ${authToken}`)
    }

    if (vehicleId) {
      await request(app)
        .delete(`/api/vehicles/${vehicleId}`)
        .set('Authorization', `Bearer ${authToken}`)
    }
  })
})
```

### 5. 创建性能测试脚本

创建`tests/performance/load-test.yml`:

```yaml
config:
  target: 'http://localhost:3000/api'
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 120
      arrivalRate: 30
      name: "Load test"
    - duration: 60
      arrivalRate: 50
      name: "Peak load"
  defaults:
    headers:
      Content-Type: 'application/json'
      Authorization: 'Bearer {{ $processEnvironment.TEST_TOKEN }}'

scenarios:
  - name: "订单管理性能测试"
    weight: 1
    requests:
      - name: "获取订单列表"
        url: "/orders"
        method: "GET"
        qs:
          page: 1
          limit: 20
      - name: "创建订单"
        url: "/orders"
        method: "POST"
        json:
          customerId: "test-customer"
          cargoName: "性能测试货物"
          cargoWeight: 1000
          cargoVolume: 10
          originAddress: "北京市朝阳区"
          destinationAddress: "上海市浦东新区"
          expectedTime: "2024-12-31T23:59:59Z"
      - name: "获取订单详情"
        url: "/orders/{{ orderId }}"
        method: "GET"

  - name: "客户管理性能测试"
    weight: 1
    requests:
      - name: "获取客户列表"
        url: "/customers"
        method: "GET"
        qs:
          page: 1
          limit: 20
      - name: "创建客户"
        url: "/customers"
        method: "POST"
        json:
          customerType: "COMPANY"
          companyName: "性能测试公司"
          email: "test@performance.com"
          phone: "13800138000"
          address: "北京市朝阳区"
          city: "北京市"
          province: "北京"

  - name: "在途跟踪性能测试"
    weight: 1
    requests:
      - name: "上报位置"
        url: "/tracking/logs"
        method: "POST"
        json:
          shipmentId: "test-shipment"
          latitude: "{{ $randomNumber(39, 40) }}"
          longitude: "{{ $randomNumber(116, 117) }}"
          address: "测试位置"
          speed: "{{ $randomNumber(0, 120) }}"
          heading: "{{ $randomNumber(0, 360) }}"
```

### 6. 创建API示例代码生成器

创建`src/docs/codeGenerator.ts`:

```typescript
export class ApiCodeGenerator {
  generateJavaScriptExample(
    method: string,
    url: string,
    data?: any,
    headers: Record<string, string> = {}
  ): string {
    const headersString = Object.entries(headers)
      .map(([key, value]) => `      '${key}': '${value}'`)
      .join(',\n')

    const dataString = data ? JSON.stringify(data, null, 6) : ''

    return `// JavaScript/Node.js 示例
const fetch = require('node-fetch');

async function apiCall() {
  const url = '${url}';
  const options = {
    method: '${method.toUpperCase()}',
    headers: {
${headersString}
    }${dataString ? `,
    body: JSON.stringify(${dataString})` : ''}
  };

  try {
    const response = await fetch(url, options);
    const result = await response.json();

    if (!response.ok) {
      throw new Error(\`HTTP error! status: \${response.status}\`);
    }

    console.log('API Response:', result);
    return result;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

// 调用示例
apiCall().catch(console.error);`
  }

  generatePythonExample(
    method: string,
    url: string,
    data?: any,
    headers: Record<string, string> = {}
  ): string {
    const headersString = Object.entries(headers)
      .map(([key, value]) => `        '${key}': '${value}'`)
      .join(',\n')

    const dataString = data ? JSON.stringify(data, null, 8) : ''

    return `# Python 示例
import requests
import json

def api_call():
    url = '${url}'
    headers = {
${headersString}
    }${dataString ? `}
    data = json.dumps(${dataString})` : ''}

    try:
        response = requests.${method.toLowerCase()}(url, headers=headers${dataString ? ', data=data' : ''})
        response.raise_for_status()

        result = response.json()
        print('API Response:', result)
        return result
    except requests.exceptions.RequestException as e:
        print(f'API Error: {e}')
        raise

# 调用示例
if __name__ == '__main__':
    api_call()`
  }

  generateCurlExample(
    method: string,
    url: string,
    data?: any,
    headers: Record<string, string> = {}
  ): string {
    const headersString = Object.entries(headers)
      .map(([key, value]) => `      -H "${key}: ${value}"`)
      .join(' \\\n')

    const dataString = data ? ` \\\n      -d '${JSON.stringify(data)}'` : ''

    return `# cURL 示例
curl -X ${method.toUpperCase()} '${url}' \\
${headersString}${dataString}`
  }

  generateReactHookExample(
    method: string,
    url: string,
    data?: any,
    headers: Record<string, string> = {}
  ): string {
    const headersString = Object.entries(headers)
      .map(([key, value]) => `      '${key}': '${value}'`)
      .join(',\n')

    const dataString = data ? JSON.stringify(data, null, 6) : ''

    return `// React Hook 示例
import { useState } from 'react';

function useApi${method.charAt(0).toUpperCase() + method.slice(1)}() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [data, setData] = useState(null);

  const fetchData = async (requestData) => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch('${url}', {
        method: '${method.toUpperCase()}',
        headers: {
          'Content-Type': 'application/json',
${headersString}
        },${dataString ? `
        body: JSON.stringify(${dataString})` : ''}
      });

      if (!response.ok) {
        throw new Error(\`HTTP error! status: \${response.status}\`);
      }

      const result = await response.json();
      setData(result);
      return result;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  return { data, loading, error, fetchData };
}

// 使用示例
function MyComponent() {
  const { data, loading, error, fetchData } = useApi${method.charAt(0).toUpperCase() + method.slice(1)}();

  const handleClick = () => {
    fetchData(${data ? JSON.stringify(data, null, 4) : 'null'});
  };

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error}</div>;

  return (
    <div>
      <button onClick={handleClick}>
        Call ${method.toUpperCase()} ${url}
      </button>
      {data && (
        <pre>
          {JSON.stringify(data, null, 2)}
        </pre>
      )}
    </div>
  );
}`
  }
}
```

### 7. 创建API健康检查

创建`src/app/api/health/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { logger } from '@/lib/logger'

export async function GET(request: NextRequest) {
  try {
    const startTime = Date.now()

    // 检查数据库连接
    await prisma.$queryRaw`SELECT 1`

    // 检查系统资源
    const memoryUsage = process.memoryUsage()
    const uptime = process.uptime()

    const healthCheck = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: Math.round(uptime),
      version: process.env.npm_package_version || '1.0.0',
      environment: process.env.NODE_ENV,
      database: {
        status: 'connected',
        responseTime: Date.now() - startTime
      },
      memory: {
        rss: Math.round(memoryUsage.rss / 1024 / 1024), // MB
        heapTotal: Math.round(memoryUsage.heapTotal / 1024 / 1024), // MB
        heapUsed: Math.round(memoryUsage.heapUsed / 1024 / 1024), // MB
        external: Math.round(memoryUsage.external / 1024 / 1024), // MB
      },
      system: {
        platform: process.platform,
        arch: process.arch,
        nodeVersion: process.version,
        cpuUsage: process.cpuUsage()
      }
    }

    // 记录健康检查日志
    logger.info('Health check completed', {
      status: healthCheck.status,
      responseTime: healthCheck.database.responseTime,
      memoryUsage: healthCheck.memory.heapUsed
    })

    return NextResponse.json({
      success: true,
      data: healthCheck
    })
  } catch (error) {
    logger.error('Health check failed', error)

    return NextResponse.json({
      success: false,
      error: 'Health check failed',
      code: 'HEALTH_CHECK_FAILED',
      timestamp: new Date().toISOString()
    }, { status: 503 })
  }
}
```

### 8. 创建API统计信息

创建`src/app/api/stats/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { getCurrentUser } from '@/lib/auth'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser()
    if (!user) {
      return NextResponse.json({ error: '未授权访问' }, { status: 401 })
    }

    const searchParams = request.nextUrl.searchParams
    const period = searchParams.get('period') || '7d' // 7d, 30d, 90d, 1y

    // 计算时间范围
    const endDate = new Date()
    const startDate = new Date()

    switch (period) {
      case '7d':
        startDate.setDate(endDate.getDate() - 7)
        break
      case '30d':
        startDate.setDate(endDate.getDate() - 30)
        break
      case '90d':
        startDate.setDate(endDate.getDate() - 90)
        break
      case '1y':
        startDate.setFullYear(endDate.getFullYear() - 1)
        break
    }

    // 并行获取统计数据
    const [
      totalOrders,
      totalCustomers,
      totalVehicles,
      totalShipments,
      ordersByStatus,
      ordersByDate,
      revenue,
      activeShipments,
      completedDeliveries
    ] = await Promise.all([
      // 总订单数
      prisma.order.count({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        }
      }),

      // 总客户数
      prisma.customer.count({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        }
      }),

      // 总车辆数
      prisma.vehicle.count({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        }
      }),

      // 总运单数
      prisma.shipment.count({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        }
      }),

      // 订单状态分布
      prisma.order.groupBy({
        by: ['status'],
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        },
        _count: true
      }),

      // 每日订单数量
      prisma.$queryRaw`
        SELECT
          DATE(created_at) as date,
          COUNT(*) as count
        FROM orders
        WHERE created_at >= ${startDate}
          AND created_at <= ${endDate}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `,

      // 营收统计
      prisma.order.aggregate({
        where: {
          createdAt: {
            gte: startDate,
            lte: endDate
          },
          status: {
            in: ['DELIVERED', 'COMPLETED']
          }
        },
        _sum: {
          totalAmount: true
        }
      }),

      // 活跃运单数
      prisma.shipment.count({
        where: {
          status: {
            in: ['IN_TRANSIT', 'LOADING', 'UNLOADING']
          }
        }
      }),

      // 完成配送数
      prisma.shipment.count({
        where: {
          status: 'DELIVERED',
          createdAt: {
            gte: startDate,
            lte: endDate
          }
        }
      })
    ])

    // 处理订单状态分布
    const statusDistribution = ordersByStatus.reduce((acc, item) => {
      acc[item.status] = item._count
      return acc
    }, {})

    // 处理每日订单数据
    const dailyOrders = (ordersByDate as any[]).map(item => ({
      date: item.date.toISOString().split('T')[0],
      count: parseInt(item.count)
    }))

    const stats = {
      period,
      summary: {
        totalOrders,
        totalCustomers,
        totalVehicles,
        totalShipments,
        activeShipments,
        completedDeliveries,
        revenue: revenue._sum.totalAmount || 0
      },
      statusDistribution,
      dailyOrders,
      performance: {
        completionRate: totalShipments > 0
          ? Math.round((completedDeliveries / totalShipments) * 100)
          : 0,
        averageOrderValue: totalOrders > 0
          ? Math.round((revenue._sum.totalAmount || 0) / totalOrders)
          : 0
      }
    }

    return NextResponse.json({
      success: true,
      data: stats
    })
  } catch (error) {
    console.error('获取统计数据失败:', error)
    return NextResponse.json(
      { error: '获取统计数据失败', details: error.message },
      { status: 500 }
    )
  }
}
```

## 验证清单

- [ ] OpenAPI规范生成正确
- [ ] Swagger UI界面正常显示
- [ ] API测试套件完整
- [ ] 性能测试脚本可运行
- [ ] 代码示例生成器工作正常
- [ ] 健康检查接口正常
- [ ] 统计接口正常
- [ ] 文档样式美观
- [ ] 示例代码准确
- [ ] 测试覆盖率充分

## 测试命令

```bash
# 运行API测试
npm run test:api

# 运行性能测试
npm run test:performance

# 生成API文档
npm run generate:docs

# 启动Swagger UI
npm run dev
# 访问 http://localhost:3000/api-docs

# 健康检查
curl http://localhost:3000/api/health

# 获取统计信息
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/stats
```

## 注意事项

- 确保API文档与实际实现保持同步
- 测试数据应该在测试环境中使用
- 性能测试应该避免在生产环境运行
- 敏感信息不应该出现在文档中
- 示例代码应该包含错误处理
- 文档应该包含所有必要的认证信息
- 测试应该覆盖正常和异常情况
- 性能测试应该监控资源使用情况
- 文档更新应该纳入CI/CD流程