---
title: 端到端集成测试套件开发
epic: tms-nlops-demo
task_id: 038
type: task
status: todo
priority: high
tags: ["testing", "integration", "e2e", "quality", "automation"]
assignee: ""
created: 2025-09-20T04:20:45Z
updated: 2025-09-20T04:20:45Z
parallel: false
depends_on: ["016", "017", "018", "019", "020", "021", "022", "023", "024", "025", "030", "031", "032", "033", "034", "035", "036", "037"]
effort: 6
description: 开发端到端集成测试套件，确保系统各组件和功能的完整性和可靠性
---

## 任务描述

开发和实现全面的端到端集成测试套件，覆盖TMS NL-Ops演示系统的所有核心功能，包括API集成、UI交互、数据处理、错误处理等场景，确保系统的稳定性和可靠性。

## 详细需求

### 1. 测试架构设计
- **测试框架**: 选择合适的测试框架和工具
- **测试分层**: 单元测试、集成测试、端到端测试
- **测试数据**: 管理测试数据和状态
- **测试报告**: 生成详细的测试报告
- **CI/CD集成**: 集成到持续集成流程

### 2. API集成测试
- **API端点测试**: 所有业务API端点的功能测试
- **LangGraph集成**: 智能代理的集成测试
- **Vercel AI SDK**: AI SDK的集成测试
- **工具调用**: 各种工具调用的测试
- **错误处理**: 错误场景的测试

### 3. UI交互测试
- **用户界面测试**: 传统UI组件的功能测试
- **生成式UI测试**: 动态UI组件的测试
- **聊天界面测试**: AI交互界面的测试
- **模式切换测试**: 传统与AI模式切换测试
- **响应式测试**: 不同设备的适配测试

### 4. 端到端场景测试
- **完整业务流程**: 订单创建到完成的完整流程
- **异常处理**: 各种异常场景的处理测试
- **性能测试**: 系统性能和负载测试
- **兼容性测试**: 浏览器和环境兼容性测试
- **安全性测试**: 安全漏洞和权限测试

## 技术实现

### 测试配置和工具
```typescript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: [
    '**/__tests__/**/*.ts',
    '**/?(*.)+(spec|test).ts'
  ],
  transform: {
    '^.+\\.ts$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.tsx'
  ],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
  testTimeout: 30000,
  verbose: true,
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
};

// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

### API集成测试
```typescript
// tests/integration/api.test.ts
import request from 'supertest';
import { app } from '@/app';
import { prisma } from '@/lib/db';
import { createTestOrder, createTestVehicle } from '../fixtures/data';

describe('TMS API Integration Tests', () => {
  beforeAll(async () => {
    // 清理测试数据库
    await prisma.order.deleteMany();
    await prisma.vehicle.deleteMany();
    await prisma.customer.deleteMany();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  describe('订单管理API', () => {
    it('应该创建新订单', async () => {
      const customer = await prisma.customer.create({
        data: {
          name: '测试客户',
          phone: '13800138000',
          email: 'test@example.com'
        }
      });

      const orderData = {
        customerId: customer.id,
        origin: { address: '上海市浦东新区', contact: '张三' },
        destination: { address: '北京市朝阳区', contact: '李四' },
        weight: 100,
        goodsType: '电子产品'
      };

      const response = await request(app)
        .post('/api/tms/orders')
        .send(orderData)
        .expect(201);

      expect(response.body).toHaveProperty('id');
      expect(response.body.customerId).toBe(customer.id);
      expect(response.body.status).toBe('PENDING');
    });

    it('应该查询订单列表', async () => {
      const response = await request(app)
        .get('/api/tms/orders')
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      if (response.body.length > 0) {
        expect(response.body[0]).toHaveProperty('id');
        expect(response.body[0]).toHaveProperty('orderId');
      }
    });

    it('应该获取订单详情', async () => {
      const order = await createTestOrder();

      const response = await request(app)
        .get(`/api/tms/orders/${order.id}`)
        .expect(200);

      expect(response.body.id).toBe(order.id);
      expect(response.body).toHaveProperty('customer');
    });
  });

  describe('排车调度API', () => {
    it('应该获取待调度订单', async () => {
      await createTestOrder({ status: 'PENDING' });

      const response = await request(app)
        .get('/api/tms/dispatch/pending')
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
    });

    it('应该获取可用车辆', async () => {
      await createTestVehicle({ status: 'AVAILABLE' });

      const response = await request(app)
        .get('/api/tms/vehicles/available')
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
    });

    it('应该创建发车单', async () => {
      const vehicle = await createTestVehicle();
      const order = await createTestOrder();

      const dispatchData = {
        vehicleId: vehicle.id,
        orderIds: [order.id]
      };

      const response = await request(app)
        .post('/api/tms/dispatch')
        .send(dispatchData)
        .expect(201);

      expect(response.body).toHaveProperty('id');
      expect(response.body.vehicleId).toBe(vehicle.id);
    });
  });
});
```

### LangGraph集成测试
```typescript
// tests/integration/langgraph.test.ts
import { graph } from '@/agent/graph';
import { AgentState } from '@/agent/state';
import { createTestMessages } from '../fixtures/messages';

describe('LangGraph Integration Tests', () => {
  describe('订单处理流程', () => {
    it('应该正确处理订单查询请求', async () => {
      const input: Partial<AgentState> = {
        messages: createTestMessages([
          {
            role: 'user',
            content: '查询今天所有的订单'
          }
        ]),
        context: { userRole: 'dispatcher' }
      };

      const result = await graph.invoke(input);

      expect(result.messages.length).toBeGreaterThan(1);
      const lastMessage = result.messages[result.messages.length - 1];
      expect(lastMessage.content).toContain('订单');
    });

    it('应该正确处理订单创建请求', async () => {
      const input: Partial<AgentState> = {
        messages: createTestMessages([
          {
            role: 'user',
            content: '为客户"测试公司"创建一个从上海到北京的订单，货物为10箱服务器'
          }
        ]),
        context: { userRole: 'dispatcher' }
      };

      const result = await graph.invoke(input);

      expect(result.messages.length).toBeGreaterThan(1);
      expect(result.data).toHaveProperty('orders');
    });

    it('应该正确处理排车调度请求', async () => {
      const input: Partial<AgentState> = {
        messages: createTestMessages([
          {
            role: 'user',
            content: '将订单ORD-001和ORD-002合并排车'
          }
        ]),
        context: { userRole: 'dispatcher' },
        data: {
          orders: [
            { id: 'ORD-001', status: 'PENDING' },
            { id: 'ORD-002', status: 'PENDING' }
          ]
        }
      };

      const result = await graph.invoke(input);

      expect(result.messages.length).toBeGreaterThan(1);
      expect(result.ui).toHaveProperty('component');
    });
  });

  describe('工具调用测试', () => {
    it('应该正确调用查询订单工具', async () => {
      const input: Partial<AgentState> = {
        messages: createTestMessages([
          {
            role: 'user',
            content: '查询客户"未来科技"的订单'
          }
        ]),
        context: { userRole: 'dispatcher' }
      };

      const stream = await graph.stream(input, {
        streamMode: 'values'
      });

      let toolCalled = false;
      for await (const chunk of stream) {
        if (chunk.messages) {
          const lastMessage = chunk.messages[chunk.messages.length - 1];
          if (lastMessage.tool_calls) {
            toolCalled = lastMessage.tool_calls.some(
              call => call.toolName === 'queryOrders'
            );
          }
        }
      }

      expect(toolCalled).toBe(true);
    });
  });
});
```

### 端到端场景测试
```typescript
// tests/e2e/chat-flow.spec.ts
import { test, expect } from '@playwright/test';

test.describe('TMS NL-Ops 端到端测试', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('[data-testid="chat-input"]');
  });

  test('完整的订单管理流程', async ({ page }) => {
    // 1. 创建订单
    await page.fill('[data-testid="chat-input"]', '为"上海科技有限公司"创建一个从浦东新区到北京朝阳区的订单，货物为20箱服务器');
    await page.click('[data-testid="send-button"]');

    // 等待AI响应
    await page.waitForSelector('[data-testid="assistant-message"]');

    // 检查是否显示订单创建成功的消息
    await expect(page.locator('[data-testid="assistant-message"]')).toContainText('订单创建成功');

    // 2. 查询订单
    await page.fill('[data-testid="chat-input"]', '查询刚刚创建的订单');
    await page.click('[data-testid="send-button"]');

    // 等待订单表格显示
    await page.waitForSelector('[data-testid="order-table"]');

    // 检查订单表格是否正确显示
    await expect(page.locator('[data-testid="order-table"]')).toBeVisible();

    // 3. 排车调度
    await page.fill('[data-testid="chat-input"]', '将这个订单进行排车调度');
    await page.click('[data-testid="send-button"]');

    // 等待排车计划显示
    await page.waitForSelector('[data-testid="dispatch-plan"]');

    // 检查排车计划是否正确显示
    await expect(page.locator('[data-testid="dispatch-plan"]')).toBeVisible();

    // 4. 确认发车
    await page.click('[data-testid="confirm-dispatch"]');

    // 等待确认消息
    await expect(page.locator('[data-testid="assistant-message"]')).toContainText('发车成功');
  });

  test('车辆跟踪流程', async ({ page }) => {
    // 创建一个进行中的订单
    await page.fill('[data-testid="chat-input"]', '查询正在进行运输的订单');
    await page.click('[data-testid="send-button"]');

    // 等待订单显示
    await page.waitForSelector('[data-testid="order-table"]');

    // 查询车辆位置
    await page.fill('[data-testid="chat-input"]', '查看车辆沪A12345的当前位置');
    await page.click('[data-testid="send-button"]');

    // 等待车辆跟踪信息显示
    await page.waitForSelector('[data-testid="vehicle-tracker"]');

    // 检查车辆跟踪信息是否正确显示
    await expect(page.locator('[data-testid="vehicle-tracker"]')).toBeVisible();
    await expect(page.locator('[data-testid="vehicle-tracker"]')).toContainText('沪A12345');
  });

  test('错误处理场景', async ({ page }) => {
    // 测试无效的订单查询
    await page.fill('[data-testid="chat-input"]', '查询订单NON-EXISTENT');
    await page.click('[data-testid="send-button"]');

    // 等待错误消息
    await page.waitForSelector('[data-testid="error-message"]');

    // 检查错误消息是否友好
    await expect(page.locator('[data-testid="error-message"]')).toContainText('未找到');
  });

  test('模式切换功能', async ({ page }) => {
    // 切换到传统UI模式
    await page.click('[data-testid="mode-toggle"]');
    await page.click('[data-testid="traditional-mode"]');

    // 检查是否跳转到传统UI页面
    await expect(page).toHaveURL('/tms-dashboard');

    // 切换回AI模式
    await page.click('[data-testid="mode-toggle"]');
    await page.click('[data-testid="ai-mode"]');

    // 检查是否返回聊天界面
    await expect(page).toHaveURL('/');
  });
});
```

### 性能测试
```typescript
// tests/performance/load.test.ts
import { loadApp, closeApp } from '../helpers/load-test';
import { createTestSession } from '../fixtures/session';

describe('性能测试', () => {
  beforeAll(async () => {
    await loadApp();
  });

  afterAll(async () => {
    await closeApp();
  });

  test('并发用户聊天测试', async () => {
    const concurrentUsers = 50;
    const messages = [
      '查询今天的订单',
      '创建一个新订单',
      '查看车辆位置'
    ];

    const results = await Promise.all(
      Array(concurrentUsers).fill(0).map(async (_, index) => {
        const session = createTestSession(`user-${index}`);
        const startTime = Date.now();

        // 模拟用户发送多条消息
        for (const message of messages) {
          await session.sendMessage(message);
          await session.waitForResponse();
        }

        return {
          userId: index,
          totalTime: Date.now() - startTime,
          messageCount: messages.length
        };
      })
    );

    // 分析结果
    const avgResponseTime = results.reduce((sum, r) => sum + r.totalTime, 0) / results.length;
    const avgMessageTime = avgResponseTime / messages.length;

    console.log(`平均响应时间: ${avgResponseTime}ms`);
    console.log(`平均消息处理时间: ${avgMessageTime}ms`);

    expect(avgMessageTime).toBeLessThan(3000); // 每条消息响应时间小于3秒
    expect(results.every(r => r.totalTime < 30000)).toBe(true); // 总时间小于30秒
  });

  test('API负载测试', async () => {
    const requestCount = 1000;
    const endpoints = [
      '/api/tms/orders',
      '/api/tms/vehicles/available',
      '/api/tms/dispatch/pending'
    ];

    const results = await Promise.all(
      Array(requestCount).fill(0).map(async (_, index) => {
        const endpoint = endpoints[index % endpoints.length];
        const startTime = Date.now();

        try {
          const response = await fetch(`http://localhost:3000${endpoint}`);
          return {
            endpoint,
            status: response.status,
            responseTime: Date.now() - startTime,
            success: response.ok
          };
        } catch (error) {
          return {
            endpoint,
            status: 500,
            responseTime: Date.now() - startTime,
            success: false,
            error: error.message
          };
        }
      })
    );

    // 分析结果
    const successRate = results.filter(r => r.success).length / results.length;
    const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;

    console.log(`API成功率: ${(successRate * 100).toFixed(2)}%`);
    console.log(`平均响应时间: ${avgResponseTime}ms`);

    expect(successRate).toBeGreaterThan(0.95); // 成功率大于95%
    expect(avgResponseTime).toBeLessThan(500); // 平均响应时间小于500ms
  });
});
```

## 交付成果

1. **测试框架配置**: Jest和Playwright配置
2. **API集成测试**: 业务API的完整测试套件
3. **LangGraph测试**: 智能代理的集成测试
4. **端到端测试**: 完整业务流程的测试
5. **性能测试**: 负载和性能测试套件
6. **测试数据管理**: 测试数据和夹具
7. **测试报告**: 自动化测试报告生成
8. **CI/CD集成**: 持续集成测试配置

## 验收标准

- [ ] 测试覆盖率 > 80%
- [ ] 所有核心功能测试通过
- [ ] API测试成功率 > 95%
- [ ] 端到端测试通过率 > 90%
- [ ] 性能测试满足要求
- [ ] 错误场景测试覆盖
- [ ] 测试执行时间 < 10分钟
- [ ] 测试报告生成正常
- [ ] CI/CD集成工作正常
- [ ] 测试数据管理完善
- [ ] 测试环境配置正确
- [ ] 代码符合测试规范

## 相关文件

- `/tests/` - 测试目录
- `/tests/integration/` - 集成测试
- `/tests/e2e/` - 端到端测试
- `/tests/performance/` - 性能测试
- `/tests/fixtures/` - 测试数据和夹具
- `/tests/helpers/` - 测试辅助函数
- `/jest.config.js` - Jest配置
- `/playwright.config.ts` - Playwright配置
- `/tests/setup.ts` - 测试设置
- `/tests/teardown.ts` - 测试清理

## 注意事项

1. 测试独立性：每个测试应该独立运行
2. 数据管理：测试数据要隔离和清理
3. 性能影响：测试不应影响生产环境
4. 错误模拟：要模拟各种错误场景
5. 并发测试：要考虑并发访问的情况
6. 测试维护：定期更新和维护测试用例
7. 测试文档：提供详细的测试文档
8. 测试监控：建立测试执行监控